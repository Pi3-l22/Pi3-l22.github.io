<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  
  <meta name="author" content="LiuChao">

  
  
  <meta name="description" content="A personal notebook to record my studies and life">
  

  
  <link rel="icon" href="https://blog.pi3.fun/favicon.ico">

  
  
  <meta name="keywords" content=" study  latex  life  academic ">
  

  
  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css"
  integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
  integrity="sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js"
  integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '\\[', right: '\\]', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false }
      ],
      ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'option'],
      throwOnError: false
    });
  });
</script>


  

  
  <meta property="og:url" content="https://blog.pi3.fun/post/2023/12/%E4%B8%8D%E5%90%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E4%B8%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%9C%8D%E5%8A%A1%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1/">
  <meta property="og:site_name" content="Pi3&#39;Notes">
  <meta property="og:title" content="不同网络架构下文件下载服务协议设计">
  <meta property="og:description" content="A personal notebook to record my studies and life">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2023-12-20T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-12-20T00:00:00+00:00">
    <meta property="article:tag" content="Python">
    <meta property="article:tag" content="Socket">
    <meta property="article:tag" content="TCP">


  
  <link rel="canonical" href="https://blog.pi3.fun/post/2023/12/%E4%B8%8D%E5%90%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E4%B8%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%9C%8D%E5%8A%A1%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1/">

  
  
  
  <meta itemprop="name" content="不同网络架构下文件下载服务协议设计">
  <meta itemprop="description" content="A personal notebook to record my studies and life">
  <meta itemprop="datePublished" content="2023-12-20T00:00:00+00:00">
  <meta itemprop="dateModified" content="2023-12-20T00:00:00+00:00">
  <meta itemprop="wordCount" content="4615">
  <meta itemprop="keywords" content="Python,Socket,TCP">

  
  <link media="screen" rel="stylesheet" href='https://blog.pi3.fun/css/common.css'>
  <link media="screen" rel="stylesheet" href='https://blog.pi3.fun/css/content.css'>

  
  
  <title>不同网络架构下文件下载服务协议设计 - Pi3&#39;Notes</title>
  

  
  

  
<link rel="stylesheet" href='https://blog.pi3.fun/css/single.css'>

</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://blog.pi3.fun/">Pi3&#39;Notes</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/">主页</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/articles/">文章</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/">归档</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/about/">关于</a>
    </span>
    
  </nav>
</header>

    
<main id="main" class="post">
  
  
  <h1>不同网络架构下文件下载服务协议设计</h1>
  
  <div>
    <b>Keywords: </b>
    
    <a class="link" href='https://blog.pi3.fun/tags/python'>#Python</a>
    
    <a class="link" href='https://blog.pi3.fun/tags/socket'>#Socket</a>
    
    <a class="link" href='https://blog.pi3.fun/tags/tcp'>#TCP</a>
    
  </div>
  
  
  
  <details>
    <summary>
      <b>Table of Contents</b>
    </summary>
    <div class="toc"><nav id="TableOfContents">
  <ul>
    <li><a href="#实验目的">实验目的</a></li>
    <li><a href="#实验内容">实验内容</a></li>
    <li><a href="#程序设计思路">程序设计思路</a>
      <ul>
        <li><a href="#网络应用拓扑结构">网络应用拓扑结构</a></li>
        <li><a href="#应用层协议设计">应用层协议设计</a></li>
        <li><a href="#所选用的python库介绍">所选用的Python库介绍</a></li>
        <li><a href="#程序源代码">程序源代码</a></li>
        <li><a href="#程序测试方法及测试结果记录">程序测试方法及测试结果记录</a></li>
        <li><a href="#实验分析总结及心得">实验分析总结及心得</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
  </details>
  
  
  <article class="content">
    
    <h2 id="实验目的">实验目的</h2>
<ol>
<li>熟悉不同网络架构的特点。</li>
<li>掌握不同网络架构下的文件下载服务协议设计。</li>
</ol>
<h2 id="实验内容">实验内容</h2>
<p>使用TCP协议设计一个文件下载服务协议，客户端发送要下载的文件路径给服务器，服务器将对应的文件内容送给客户端，客户端将文件存储到本地磁盘。注意，当文件不存在时给出提示。要求，服务的实现分别采用以下三种方法实现：</p>
<p>(1)单线程，迭代服务器(依次服务每一个客户端)</p>
<p>(2)多线程，并发服务器</p>
<p>(3)异步方式 asyncio库</p>
<p>例如：
<code>$ python download_server.py [-h] [-p port] host</code>
<code>$ python download_client.py [-h] [-p port] host remote_file local_file</code>
完成将服务器的文件remote_file下载到本地，命名为local_file</p>
<h2 id="程序设计思路">程序设计思路</h2>
<h3 id="网络应用拓扑结构">网络应用拓扑结构</h3>
<p>一对多的网络结构，即一台服务器对应多台客户端的星型拓扑结构</p>
<p><img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192026.png" alt="网络拓扑结构"></p>
<h3 id="应用层协议设计">应用层协议设计</h3>
<p>客户端连接到服务端，服务端监听到客户端的连接。</p>
<p>客户端 &ndash;&gt; 需要下载的文件路径 &ndash;&gt; 服务端</p>
<p>客户端 &lt;&ndash; 文件是否存在 &lt;&ndash; 服务端</p>
<p>不存在则双方退出协议，存在则继续</p>
<p>客户端 &ndash;&gt; 确认文件存在消息 &ndash;&gt; 服务端</p>
<p>客户端 &lt;&ndash; 文件头部信息长度 &lt;&ndash; 服务端</p>
<p>客户端 &ndash;&gt; 确认头部长度消息 &ndash;&gt; 服务端</p>
<p>客户端 &lt;&ndash; 文件头部信息 &lt;&ndash; 服务端</p>
<p>客户端 &ndash;&gt; 确认头部信息消息 &ndash;&gt; 服务端</p>
<p>客户端 &lt;&ndash; 文件内容数据 &lt;&ndash; 服务端</p>
<p>双方退出协议部分</p>
<h3 id="所选用的python库介绍">所选用的Python库介绍</h3>
<p>import socket  # 套接字</p>
<p>import sys  # 系统操作</p>
<p>import zipfile  # 压缩文件</p>
<p>import struct  # 字符串打包解包</p>
<p>import json  # json序列化</p>
<p>from tqdm import tqdm  # 进度条</p>
<p>import threading  # 多线程</p>
<p>import asyncio  # 异步IO</p>
<p>import aiofiles  # 异步文件IO</p>
<p>import selectors  # selectors模块单线程异步轮询</p>
<h3 id="程序源代码">程序源代码</h3>
<h4 id="服务器端源码">服务器端源码</h4>
<p><strong>单线程服务端：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">socket</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">sys</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">os</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">zipfile</span>  <span style="color:#080;font-style:italic"># 压缩文件</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">json</span>  <span style="color:#080;font-style:italic"># json序列化</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">struct</span>  <span style="color:#080;font-style:italic"># 字符串打包解包</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">handle_client</span>(client_socket, client_address):
</span></span><span style="display:flex;"><span>    flag <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">False</span>  <span style="color:#080;font-style:italic"># 是否为文件夹</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 接收客户端发送的文件路径</span>
</span></span><span style="display:flex;"><span>    file_path <span style="color:#666">=</span> client_socket<span style="color:#666">.</span>recv(<span style="color:#666">1024</span>)<span style="color:#666">.</span>decode()
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 判断文件或者文件夹是否存在</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">if</span> os<span style="color:#666">.</span>path<span style="color:#666">.</span>exists(file_path):
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[+] 发送 </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 给 </span><span style="color:#b68;font-weight:bold">{</span>client_address<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 发送文件存在的确认信息</span>
</span></span><span style="display:flex;"><span>        client_socket<span style="color:#666">.</span>send(<span style="color:#b44">&#34;file_exist&#34;</span><span style="color:#666">.</span>encode())
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 接收客户端的确认信息</span>
</span></span><span style="display:flex;"><span>        rev <span style="color:#666">=</span> client_socket<span style="color:#666">.</span>recv(<span style="color:#666">1024</span>)<span style="color:#666">.</span>decode()
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> rev <span style="color:#666">!=</span> <span style="color:#b44">&#39;start_send_file&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[-] </span><span style="color:#b68;font-weight:bold">{</span>client_address<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 取消发送 </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 如果是文件夹，就压缩打包成zip文件</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> os<span style="color:#666">.</span>path<span style="color:#666">.</span>isdir(file_path):
</span></span><span style="display:flex;"><span>            zip_file_path <span style="color:#666">=</span> file_path <span style="color:#666">+</span> <span style="color:#b44">&#39;.zip&#39;</span>
</span></span><span style="display:flex;"><span>            zip_file <span style="color:#666">=</span> zipfile<span style="color:#666">.</span>ZipFile(zip_file_path, <span style="color:#b44">&#39;w&#39;</span>, zipfile<span style="color:#666">.</span>ZIP_DEFLATED)
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">for</span> root, dirs, files <span style="color:#a2f;font-weight:bold">in</span> os<span style="color:#666">.</span>walk(file_path):
</span></span><span style="display:flex;"><span>                <span style="color:#a2f;font-weight:bold">for</span> file <span style="color:#a2f;font-weight:bold">in</span> files:
</span></span><span style="display:flex;"><span>                    zip_file<span style="color:#666">.</span>write(os<span style="color:#666">.</span>path<span style="color:#666">.</span>join(root, file))
</span></span><span style="display:flex;"><span>            zip_file<span style="color:#666">.</span>close()
</span></span><span style="display:flex;"><span>            flag <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">True</span>  <span style="color:#080;font-style:italic"># 是否为文件夹</span>
</span></span><span style="display:flex;"><span>            file_path <span style="color:#666">=</span> zip_file_path
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 发送文件头部信息{文件名，文件大小，文件类型}</span>
</span></span><span style="display:flex;"><span>        file_name <span style="color:#666">=</span> os<span style="color:#666">.</span>path<span style="color:#666">.</span>basename(file_path)
</span></span><span style="display:flex;"><span>        file_size <span style="color:#666">=</span> os<span style="color:#666">.</span>path<span style="color:#666">.</span>getsize(file_path)
</span></span><span style="display:flex;"><span>        file_type <span style="color:#666">=</span> os<span style="color:#666">.</span>path<span style="color:#666">.</span>splitext(file_path)[<span style="color:#666">1</span>]
</span></span><span style="display:flex;"><span>        file_header <span style="color:#666">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#b44">&#39;file_name&#39;</span>: file_name,
</span></span><span style="display:flex;"><span>            <span style="color:#b44">&#39;file_size&#39;</span>: file_size,
</span></span><span style="display:flex;"><span>            <span style="color:#b44">&#39;file_type&#39;</span>: file_type
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># json序列化</span>
</span></span><span style="display:flex;"><span>        file_header_json <span style="color:#666">=</span> json<span style="color:#666">.</span>dumps(file_header)
</span></span><span style="display:flex;"><span>        file_header_bytes <span style="color:#666">=</span> file_header_json<span style="color:#666">.</span>encode()
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 将文件头部信息的长度打包成固定长度的字符串</span>
</span></span><span style="display:flex;"><span>        header_size <span style="color:#666">=</span> struct<span style="color:#666">.</span>pack(<span style="color:#b44">&#39;i&#39;</span>, <span style="color:#a2f">len</span>(file_header_bytes))
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 先发送文件头部信息的长度</span>
</span></span><span style="display:flex;"><span>        client_socket<span style="color:#666">.</span>send(header_size)
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 接收客户端的确认信息</span>
</span></span><span style="display:flex;"><span>        rev <span style="color:#666">=</span> client_socket<span style="color:#666">.</span>recv(<span style="color:#666">1024</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> rev<span style="color:#666">.</span>decode() <span style="color:#666">!=</span> <span style="color:#b44">&#39;header_size_ok&#39;</span>:  <span style="color:#080;font-style:italic"># 如果客户端确认信息不是header_size_ok</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[-] </span><span style="color:#b68;font-weight:bold">{</span>client_address<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 取消发送 </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 再发送文件头部信息</span>
</span></span><span style="display:flex;"><span>        client_socket<span style="color:#666">.</span>send(file_header_bytes)
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 接收客户端的确认信息</span>
</span></span><span style="display:flex;"><span>        rev <span style="color:#666">=</span> client_socket<span style="color:#666">.</span>recv(<span style="color:#666">1024</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> rev<span style="color:#666">.</span>decode() <span style="color:#666">==</span> <span style="color:#b44">&#39;header_ok&#39;</span>:  <span style="color:#080;font-style:italic"># 如果客户端确认信息不是header_ok</span>
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-style:italic"># 发送文件内容</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#39;[*] 正在发送文件 </span><span style="color:#b68;font-weight:bold">{</span>file_name<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 内容...&#39;</span>)
</span></span><span style="display:flex;"><span>            send_file(client_socket, file_path, file_size)
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 删除文件夹压缩包</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> flag:
</span></span><span style="display:flex;"><span>            os<span style="color:#666">.</span>remove(file_path)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        client_socket<span style="color:#666">.</span>send(<span style="color:#b44">&#34;FILE NOT FOUND&#34;</span><span style="color:#666">.</span>encode())
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[-] </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 文件不存在&#34;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">send_file</span>(client_socket, file_path, file_size):
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">with</span> <span style="color:#a2f">open</span>(file_path, <span style="color:#b44">&#39;rb&#39;</span>) <span style="color:#a2f;font-weight:bold">as</span> file:
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-style:italic"># 显示tqdm进度条</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">for</span> _ <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#a2f">range</span>(file_size <span style="color:#666">//</span> <span style="color:#666">1024</span>):
</span></span><span style="display:flex;"><span>                file_data <span style="color:#666">=</span> file<span style="color:#666">.</span>read(<span style="color:#666">1024</span>)
</span></span><span style="display:flex;"><span>                client_socket<span style="color:#666">.</span>send(file_data)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">except</span> <span style="color:#d2413a;font-weight:bold">Exception</span> <span style="color:#a2f;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[-] </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 文件发送失败</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[+] </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 文件发送成功</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">main</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">global</span> client_socket
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">if</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">1</span>] <span style="color:#666">==</span> <span style="color:#b44">&#39;-h&#39;</span>:
</span></span><span style="display:flex;"><span>        help_message <span style="color:#666">=</span> <span style="color:#b44">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#b44">[+] 用法:
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    python server.py [-h] [-P port]
</span></span></span><span style="display:flex;"><span><span style="color:#b44"> 
</span></span></span><span style="display:flex;"><span><span style="color:#b44">[+] 参数说明:
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    -h: 查看帮助信息
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    -P: 本地服务器监听端口
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(help_message)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">elif</span> <span style="color:#a2f">len</span>(sys<span style="color:#666">.</span>argv) <span style="color:#666">!=</span> <span style="color:#666">3</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">&#39;[-] 参数错误！输入-h查看帮助信息&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">elif</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">1</span>] <span style="color:#666">!=</span> <span style="color:#b44">&#39;-P&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">&#39;[-] 参数错误！输入-h查看帮助信息&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    host <span style="color:#666">=</span> <span style="color:#b44">&#39;127.0.0.1&#39;</span>
</span></span><span style="display:flex;"><span>    port <span style="color:#666">=</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">2</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>        port <span style="color:#666">=</span> <span style="color:#a2f">int</span>(port)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">except</span> <span style="color:#d2413a;font-weight:bold">Exception</span> <span style="color:#a2f;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">&#39;[-] 端口号必须为整数！&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(e)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    server <span style="color:#666">=</span> socket<span style="color:#666">.</span>socket(socket<span style="color:#666">.</span>AF_INET, socket<span style="color:#666">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>    server<span style="color:#666">.</span>bind((host, port))
</span></span><span style="display:flex;"><span>    server<span style="color:#666">.</span>listen(<span style="color:#666">5</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[*] 服务器正在监听：</span><span style="color:#b68;font-weight:bold">{</span>host<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">:</span><span style="color:#b68;font-weight:bold">{</span>port<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">while</span> <span style="color:#a2f;font-weight:bold">True</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-style:italic"># 接收客户端连接</span>
</span></span><span style="display:flex;"><span>            client_socket, client_address <span style="color:#666">=</span> server<span style="color:#666">.</span>accept()
</span></span><span style="display:flex;"><span>            <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">[+] 接收到客户端连接：</span><span style="color:#b68;font-weight:bold">{</span>client_address<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-style:italic"># 处理客户端请求</span>
</span></span><span style="display:flex;"><span>            handle_client(client_socket, client_address)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">except</span> <span style="color:#d2413a;font-weight:bold">KeyboardInterrupt</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#a2f">print</span>(<span style="color:#b44">&#34;</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">[-] 服务器已停止运行&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 关闭客户端连接</span>
</span></span><span style="display:flex;"><span>    client_socket<span style="color:#666">.</span>close()
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span> __name__ <span style="color:#666">==</span> <span style="color:#b44">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    main()
</span></span></code></pre></div><p><strong>多线程服务端：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">socket</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">sys</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">os</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">zipfile</span>  <span style="color:#080;font-style:italic"># 压缩文件</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">json</span>  <span style="color:#080;font-style:italic"># json序列化</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">struct</span>  <span style="color:#080;font-style:italic"># 字符串打包解包</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">threading</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">handle_client</span>(client_socket, client_address):
</span></span><span style="display:flex;"><span>    flag <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">False</span>  <span style="color:#080;font-style:italic"># 是否为文件夹</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 接收客户端发送的文件路径</span>
</span></span><span style="display:flex;"><span>    file_path <span style="color:#666">=</span> client_socket<span style="color:#666">.</span>recv(<span style="color:#666">1024</span>)<span style="color:#666">.</span>decode()
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 判断文件或者文件夹是否存在</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">if</span> os<span style="color:#666">.</span>path<span style="color:#666">.</span>exists(file_path):
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[+] 发送 </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 给 </span><span style="color:#b68;font-weight:bold">{</span>client_address<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 发送文件存在的确认信息</span>
</span></span><span style="display:flex;"><span>        client_socket<span style="color:#666">.</span>send(<span style="color:#b44">&#34;file_exist&#34;</span><span style="color:#666">.</span>encode())
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 接收客户端的确认信息</span>
</span></span><span style="display:flex;"><span>        rev <span style="color:#666">=</span> client_socket<span style="color:#666">.</span>recv(<span style="color:#666">1024</span>)<span style="color:#666">.</span>decode()
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> rev <span style="color:#666">!=</span> <span style="color:#b44">&#39;start_send_file&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[-] </span><span style="color:#b68;font-weight:bold">{</span>client_address<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 取消发送 </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 如果是文件夹，就压缩打包成zip文件</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> os<span style="color:#666">.</span>path<span style="color:#666">.</span>isdir(file_path):
</span></span><span style="display:flex;"><span>            zip_file_path <span style="color:#666">=</span> file_path <span style="color:#666">+</span> <span style="color:#b44">&#39;.zip&#39;</span>
</span></span><span style="display:flex;"><span>            zip_file <span style="color:#666">=</span> zipfile<span style="color:#666">.</span>ZipFile(zip_file_path, <span style="color:#b44">&#39;w&#39;</span>, zipfile<span style="color:#666">.</span>ZIP_DEFLATED)
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">for</span> root, dirs, files <span style="color:#a2f;font-weight:bold">in</span> os<span style="color:#666">.</span>walk(file_path):
</span></span><span style="display:flex;"><span>                <span style="color:#a2f;font-weight:bold">for</span> file <span style="color:#a2f;font-weight:bold">in</span> files:
</span></span><span style="display:flex;"><span>                    zip_file<span style="color:#666">.</span>write(os<span style="color:#666">.</span>path<span style="color:#666">.</span>join(root, file))
</span></span><span style="display:flex;"><span>            zip_file<span style="color:#666">.</span>close()
</span></span><span style="display:flex;"><span>            flag <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">True</span>  <span style="color:#080;font-style:italic"># 是否为文件夹</span>
</span></span><span style="display:flex;"><span>            file_path <span style="color:#666">=</span> zip_file_path
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 发送文件头部信息{文件名，文件大小，文件类型}</span>
</span></span><span style="display:flex;"><span>        file_name <span style="color:#666">=</span> os<span style="color:#666">.</span>path<span style="color:#666">.</span>basename(file_path)
</span></span><span style="display:flex;"><span>        file_size <span style="color:#666">=</span> os<span style="color:#666">.</span>path<span style="color:#666">.</span>getsize(file_path)
</span></span><span style="display:flex;"><span>        file_type <span style="color:#666">=</span> os<span style="color:#666">.</span>path<span style="color:#666">.</span>splitext(file_path)[<span style="color:#666">1</span>]
</span></span><span style="display:flex;"><span>        file_header <span style="color:#666">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#b44">&#39;file_name&#39;</span>: file_name,
</span></span><span style="display:flex;"><span>            <span style="color:#b44">&#39;file_size&#39;</span>: file_size,
</span></span><span style="display:flex;"><span>            <span style="color:#b44">&#39;file_type&#39;</span>: file_type
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># json序列化</span>
</span></span><span style="display:flex;"><span>        file_header_json <span style="color:#666">=</span> json<span style="color:#666">.</span>dumps(file_header)
</span></span><span style="display:flex;"><span>        file_header_bytes <span style="color:#666">=</span> file_header_json<span style="color:#666">.</span>encode()
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 将文件头部信息的长度打包成固定长度的字符串</span>
</span></span><span style="display:flex;"><span>        header_size <span style="color:#666">=</span> struct<span style="color:#666">.</span>pack(<span style="color:#b44">&#39;i&#39;</span>, <span style="color:#a2f">len</span>(file_header_bytes))
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 先发送文件头部信息的长度</span>
</span></span><span style="display:flex;"><span>        client_socket<span style="color:#666">.</span>send(header_size)
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 接收客户端的确认信息</span>
</span></span><span style="display:flex;"><span>        rev <span style="color:#666">=</span> client_socket<span style="color:#666">.</span>recv(<span style="color:#666">1024</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> rev<span style="color:#666">.</span>decode() <span style="color:#666">!=</span> <span style="color:#b44">&#39;header_size_ok&#39;</span>:  <span style="color:#080;font-style:italic"># 如果客户端确认信息不是header_size_ok</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[-] </span><span style="color:#b68;font-weight:bold">{</span>client_address<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 取消发送 </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 再发送文件头部信息</span>
</span></span><span style="display:flex;"><span>        client_socket<span style="color:#666">.</span>send(file_header_bytes)
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 接收客户端的确认信息</span>
</span></span><span style="display:flex;"><span>        rev <span style="color:#666">=</span> client_socket<span style="color:#666">.</span>recv(<span style="color:#666">1024</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> rev<span style="color:#666">.</span>decode() <span style="color:#666">==</span> <span style="color:#b44">&#39;header_ok&#39;</span>:  <span style="color:#080;font-style:italic"># 如果客户端确认信息不是header_ok</span>
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-style:italic"># 发送文件内容</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#39;[*] 正在发送文件 </span><span style="color:#b68;font-weight:bold">{</span>file_name<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 内容...&#39;</span>)
</span></span><span style="display:flex;"><span>            send_file(client_socket, file_path, file_size)
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 删除文件夹压缩包</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> flag:
</span></span><span style="display:flex;"><span>            os<span style="color:#666">.</span>remove(file_path)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        client_socket<span style="color:#666">.</span>send(<span style="color:#b44">&#34;FILE NOT FOUND&#34;</span><span style="color:#666">.</span>encode())
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[-] </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 文件不存在&#34;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">send_file</span>(client_socket, file_path, file_size):
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">with</span> <span style="color:#a2f">open</span>(file_path, <span style="color:#b44">&#39;rb&#39;</span>) <span style="color:#a2f;font-weight:bold">as</span> file:
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-style:italic"># 显示tqdm进度条</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">for</span> _ <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#a2f">range</span>(file_size <span style="color:#666">//</span> <span style="color:#666">1024</span>):
</span></span><span style="display:flex;"><span>                file_data <span style="color:#666">=</span> file<span style="color:#666">.</span>read(<span style="color:#666">1024</span>)
</span></span><span style="display:flex;"><span>                client_socket<span style="color:#666">.</span>send(file_data)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">except</span> <span style="color:#d2413a;font-weight:bold">Exception</span> <span style="color:#a2f;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[-] </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 文件发送失败&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[+] </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 文件发送成功&#34;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">main</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">global</span> client_socket
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">if</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">1</span>] <span style="color:#666">==</span> <span style="color:#b44">&#39;-h&#39;</span>:
</span></span><span style="display:flex;"><span>        help_message <span style="color:#666">=</span> <span style="color:#b44">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#b44">[+] 用法:
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    python server.py [-h] [-P port]
</span></span></span><span style="display:flex;"><span><span style="color:#b44"> 
</span></span></span><span style="display:flex;"><span><span style="color:#b44">[+] 参数说明:
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    -h: 查看帮助信息
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    -P: 本地服务器监听端口
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(help_message)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">elif</span> <span style="color:#a2f">len</span>(sys<span style="color:#666">.</span>argv) <span style="color:#666">!=</span> <span style="color:#666">3</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">&#39;[-] 参数错误！输入-h查看帮助信息&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">elif</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">1</span>] <span style="color:#666">!=</span> <span style="color:#b44">&#39;-P&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">&#39;[-] 参数错误！输入-h查看帮助信息&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    host <span style="color:#666">=</span> <span style="color:#b44">&#39;127.0.0.1&#39;</span>
</span></span><span style="display:flex;"><span>    port <span style="color:#666">=</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">2</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>        port <span style="color:#666">=</span> <span style="color:#a2f">int</span>(port)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">except</span> <span style="color:#d2413a;font-weight:bold">Exception</span> <span style="color:#a2f;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">&#39;[-] 端口号必须为整数！&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(e)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    server <span style="color:#666">=</span> socket<span style="color:#666">.</span>socket(socket<span style="color:#666">.</span>AF_INET, socket<span style="color:#666">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>    server<span style="color:#666">.</span>bind((host, port))
</span></span><span style="display:flex;"><span>    server<span style="color:#666">.</span>listen(<span style="color:#666">5</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[*] 服务器正在监听：</span><span style="color:#b68;font-weight:bold">{</span>host<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">:</span><span style="color:#b68;font-weight:bold">{</span>port<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">while</span> <span style="color:#a2f;font-weight:bold">True</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-style:italic"># 接收客户端连接</span>
</span></span><span style="display:flex;"><span>            client_socket, client_address <span style="color:#666">=</span> server<span style="color:#666">.</span>accept()
</span></span><span style="display:flex;"><span>            <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[+] 接收到客户端连接：</span><span style="color:#b68;font-weight:bold">{</span>client_address<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-style:italic"># 多线程处理客户端请求</span>
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-style:italic"># handle_client(client_socket, client_address)</span>
</span></span><span style="display:flex;"><span>            client_thread <span style="color:#666">=</span> threading<span style="color:#666">.</span>Thread(target<span style="color:#666">=</span>handle_client, args<span style="color:#666">=</span>(client_socket, client_address))
</span></span><span style="display:flex;"><span>            client_thread<span style="color:#666">.</span>start()
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">except</span> <span style="color:#d2413a;font-weight:bold">KeyboardInterrupt</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#a2f">print</span>(<span style="color:#b44">&#34;</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">[-] 服务器已停止运行&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 关闭客户端连接</span>
</span></span><span style="display:flex;"><span>    client_socket<span style="color:#666">.</span>close()
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span> __name__ <span style="color:#666">==</span> <span style="color:#b44">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    main()
</span></span></code></pre></div><p><strong>asyncio异步服务端：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">sys</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">os</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">zipfile</span>  <span style="color:#080;font-style:italic"># 压缩文件</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">json</span>  <span style="color:#080;font-style:italic"># json序列化</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">struct</span>  <span style="color:#080;font-style:italic"># 字符串打包解包</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">asyncio</span>  <span style="color:#080;font-style:italic"># 异步IO socket</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">aiofiles</span>  <span style="color:#080;font-style:italic"># 异步文件IO</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">async</span> <span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">handle_client</span>(reader, writer):
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 获取客户端信息</span>
</span></span><span style="display:flex;"><span>    client_address <span style="color:#666">=</span> writer<span style="color:#666">.</span>get_extra_info(<span style="color:#b44">&#39;peername&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">[+] 接收到客户端连接：</span><span style="color:#b68;font-weight:bold">{</span>client_address<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span>    flag <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">False</span>  <span style="color:#080;font-style:italic"># 是否为文件夹</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 接收客户端发送的文件路径</span>
</span></span><span style="display:flex;"><span>    file_path <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">await</span> asyncio<span style="color:#666">.</span>wait_for(reader<span style="color:#666">.</span>read(<span style="color:#666">1024</span>), <span style="color:#a2f;font-weight:bold">None</span>)
</span></span><span style="display:flex;"><span>    file_path <span style="color:#666">=</span> file_path<span style="color:#666">.</span>decode()
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 判断文件或者文件夹是否存在</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">if</span> os<span style="color:#666">.</span>path<span style="color:#666">.</span>exists(file_path):
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[+] 发送 </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 给 </span><span style="color:#b68;font-weight:bold">{</span>client_address<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 发送文件存在的确认信息</span>
</span></span><span style="display:flex;"><span>        writer<span style="color:#666">.</span>write(<span style="color:#b44">&#34;file_exist&#34;</span><span style="color:#666">.</span>encode())
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">await</span> writer<span style="color:#666">.</span>drain()  <span style="color:#080;font-style:italic"># 清空套接字 刷新缓冲区</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 接收客户端的确认信息</span>
</span></span><span style="display:flex;"><span>        rev <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">await</span> asyncio<span style="color:#666">.</span>wait_for(reader<span style="color:#666">.</span>read(<span style="color:#666">1024</span>), <span style="color:#a2f;font-weight:bold">None</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> rev<span style="color:#666">.</span>decode() <span style="color:#666">!=</span> <span style="color:#b44">&#39;start_send_file&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[-] </span><span style="color:#b68;font-weight:bold">{</span>client_address<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 取消发送 </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 如果是文件夹，就压缩打包成zip文件</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> os<span style="color:#666">.</span>path<span style="color:#666">.</span>isdir(file_path):
</span></span><span style="display:flex;"><span>            file_path <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">await</span> zip_file(file_path)
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 发送文件头部信息{文件名，文件大小，文件类型}</span>
</span></span><span style="display:flex;"><span>        file_name <span style="color:#666">=</span> os<span style="color:#666">.</span>path<span style="color:#666">.</span>basename(file_path)
</span></span><span style="display:flex;"><span>        file_size <span style="color:#666">=</span> os<span style="color:#666">.</span>path<span style="color:#666">.</span>getsize(file_path)
</span></span><span style="display:flex;"><span>        file_type <span style="color:#666">=</span> os<span style="color:#666">.</span>path<span style="color:#666">.</span>splitext(file_path)[<span style="color:#666">1</span>]
</span></span><span style="display:flex;"><span>        file_header <span style="color:#666">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#b44">&#39;file_name&#39;</span>: file_name,
</span></span><span style="display:flex;"><span>            <span style="color:#b44">&#39;file_size&#39;</span>: file_size,
</span></span><span style="display:flex;"><span>            <span style="color:#b44">&#39;file_type&#39;</span>: file_type
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># json序列化</span>
</span></span><span style="display:flex;"><span>        file_header_json <span style="color:#666">=</span> json<span style="color:#666">.</span>dumps(file_header)
</span></span><span style="display:flex;"><span>        file_header_bytes <span style="color:#666">=</span> file_header_json<span style="color:#666">.</span>encode()
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 将文件头部信息的长度打包成固定长度的字符串</span>
</span></span><span style="display:flex;"><span>        header_size <span style="color:#666">=</span> struct<span style="color:#666">.</span>pack(<span style="color:#b44">&#39;i&#39;</span>, <span style="color:#a2f">len</span>(file_header_bytes))
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 先发送文件头部信息的长度</span>
</span></span><span style="display:flex;"><span>        writer<span style="color:#666">.</span>write(header_size)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">await</span> writer<span style="color:#666">.</span>drain()  <span style="color:#080;font-style:italic"># 清空套接字 刷新缓冲区</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 接收客户端的确认信息</span>
</span></span><span style="display:flex;"><span>        rev <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">await</span> asyncio<span style="color:#666">.</span>wait_for(reader<span style="color:#666">.</span>read(<span style="color:#666">1024</span>), <span style="color:#a2f;font-weight:bold">None</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> rev<span style="color:#666">.</span>decode() <span style="color:#666">!=</span> <span style="color:#b44">&#39;header_size_ok&#39;</span>:  <span style="color:#080;font-style:italic"># 如果客户端确认信息不是header_size_ok</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[-] </span><span style="color:#b68;font-weight:bold">{</span>client_address<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 取消发送 </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 再发送文件头部信息</span>
</span></span><span style="display:flex;"><span>        writer<span style="color:#666">.</span>write(file_header_bytes)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">await</span> writer<span style="color:#666">.</span>drain()  <span style="color:#080;font-style:italic"># 清空套接字 刷新缓冲区</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 接收客户端的确认信息</span>
</span></span><span style="display:flex;"><span>        rev <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">await</span> asyncio<span style="color:#666">.</span>wait_for(reader<span style="color:#666">.</span>read(<span style="color:#666">1024</span>), <span style="color:#a2f;font-weight:bold">None</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> rev<span style="color:#666">.</span>decode() <span style="color:#666">==</span> <span style="color:#b44">&#39;header_ok&#39;</span>:  <span style="color:#080;font-style:italic"># 如果客户端确认信息不是header_ok</span>
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-style:italic"># 发送文件内容</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#39;[*] 正在发送文件 </span><span style="color:#b68;font-weight:bold">{</span>file_name<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 内容...&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-style:italic"># send_file(client_socket, file_path, file_size)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-style:italic"># 异步发送文件内容</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">await</span> send_file(writer, file_path, file_size)
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 删除文件夹压缩包</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> flag:
</span></span><span style="display:flex;"><span>            os<span style="color:#666">.</span>remove(file_path)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        client_socket<span style="color:#666">.</span>send(<span style="color:#b44">&#34;FILE NOT FOUND&#34;</span><span style="color:#666">.</span>encode())
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[-] </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 文件不存在&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">await</span> writer<span style="color:#666">.</span>drain()  <span style="color:#080;font-style:italic"># 清理 刷新缓冲区</span>
</span></span><span style="display:flex;"><span>    writer<span style="color:#666">.</span>close()  <span style="color:#080;font-style:italic"># 关闭连接</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">async</span> <span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">zip_file</span>(file_path):
</span></span><span style="display:flex;"><span>    zip_file_path <span style="color:#666">=</span> file_path <span style="color:#666">+</span> <span style="color:#b44">&#39;.zip&#39;</span>
</span></span><span style="display:flex;"><span>    zip_file <span style="color:#666">=</span> zipfile<span style="color:#666">.</span>ZipFile(zip_file_path, <span style="color:#b44">&#39;w&#39;</span>, zipfile<span style="color:#666">.</span>ZIP_DEFLATED)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">for</span> root, dirs, files <span style="color:#a2f;font-weight:bold">in</span> os<span style="color:#666">.</span>walk(file_path):
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">for</span> file <span style="color:#a2f;font-weight:bold">in</span> files:
</span></span><span style="display:flex;"><span>            zip_file<span style="color:#666">.</span>write(os<span style="color:#666">.</span>path<span style="color:#666">.</span>join(root, file))
</span></span><span style="display:flex;"><span>    zip_file<span style="color:#666">.</span>close()
</span></span><span style="display:flex;"><span>    flag <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">True</span>  <span style="color:#080;font-style:italic"># 是否为文件夹</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">return</span> zip_file_path
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">async</span> <span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">send_file</span>(writer, file_path, file_size):
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">async</span> <span style="color:#a2f;font-weight:bold">with</span> aiofiles<span style="color:#666">.</span>open(file_path, <span style="color:#b44">&#39;rb&#39;</span>) <span style="color:#a2f;font-weight:bold">as</span> file:
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-style:italic"># 显示tqdm进度条</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">for</span> _ <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#a2f">range</span>(file_size <span style="color:#666">//</span> <span style="color:#666">1024</span>):
</span></span><span style="display:flex;"><span>                file_data <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">await</span> file<span style="color:#666">.</span>read(<span style="color:#666">1024</span>)
</span></span><span style="display:flex;"><span>                writer<span style="color:#666">.</span>write(file_data)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">except</span> <span style="color:#d2413a;font-weight:bold">Exception</span> <span style="color:#a2f;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[-] </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 文件发送失败</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[+] </span><span style="color:#b68;font-weight:bold">{</span>file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 文件发送成功</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">async</span> <span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">main</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">global</span> client_socket
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">if</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">1</span>] <span style="color:#666">==</span> <span style="color:#b44">&#39;-h&#39;</span>:
</span></span><span style="display:flex;"><span>        help_message <span style="color:#666">=</span> <span style="color:#b44">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#b44">[+] 用法:
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    python server.py [-h] [-P port]
</span></span></span><span style="display:flex;"><span><span style="color:#b44"> 
</span></span></span><span style="display:flex;"><span><span style="color:#b44">[+] 参数说明:
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    -h: 查看帮助信息
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    -P: 本地服务器监听端口
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(help_message)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">elif</span> <span style="color:#a2f">len</span>(sys<span style="color:#666">.</span>argv) <span style="color:#666">!=</span> <span style="color:#666">3</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">&#39;[-] 参数错误！输入-h查看帮助信息&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">elif</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">1</span>] <span style="color:#666">!=</span> <span style="color:#b44">&#39;-P&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">&#39;[-] 参数错误！输入-h查看帮助信息&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    host <span style="color:#666">=</span> <span style="color:#b44">&#39;127.0.0.1&#39;</span>
</span></span><span style="display:flex;"><span>    port <span style="color:#666">=</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">2</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>        port <span style="color:#666">=</span> <span style="color:#a2f">int</span>(port)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">except</span> <span style="color:#d2413a;font-weight:bold">Exception</span> <span style="color:#a2f;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">&#39;[-] 端口号必须为整数！&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(e)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[*] 服务器正在监听：</span><span style="color:#b68;font-weight:bold">{</span>host<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">:</span><span style="color:#b68;font-weight:bold">{</span>port<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 生成一个asyncio服务器</span>
</span></span><span style="display:flex;"><span>    server <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">await</span> asyncio<span style="color:#666">.</span>start_server(handle_client, host, port)
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 启动服务器 循环接收客户端连接</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">async</span> <span style="color:#a2f;font-weight:bold">with</span> server:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">await</span> server<span style="color:#666">.</span>serve_forever()
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 关闭客户端连接</span>
</span></span><span style="display:flex;"><span>    client_socket<span style="color:#666">.</span>close()
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span> __name__ <span style="color:#666">==</span> <span style="color:#b44">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>        asyncio<span style="color:#666">.</span>run(main())
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">except</span> <span style="color:#d2413a;font-weight:bold">KeyboardInterrupt</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">&#34;</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">[-] 服务器已停止运行&#34;</span>)
</span></span></code></pre></div><h4 id="客户端源码">客户端源码</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">socket</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">sys</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">zipfile</span>  <span style="color:#080;font-style:italic"># 压缩文件</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">struct</span>  <span style="color:#080;font-style:italic"># 字符串打包解包</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">json</span>  <span style="color:#080;font-style:italic"># json序列化</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">tqdm</span> <span style="color:#a2f;font-weight:bold">import</span> tqdm  <span style="color:#080;font-style:italic"># 进度条</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">main</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">if</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">1</span>] <span style="color:#666">==</span> <span style="color:#b44">&#39;-h&#39;</span>:
</span></span><span style="display:flex;"><span>        help_message <span style="color:#666">=</span> <span style="color:#b44">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#b44">[+] 用法:
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    python client.py [-h] [-H host] [-P port] [-r remote_file_path] [-l local_file_path]
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    
</span></span></span><span style="display:flex;"><span><span style="color:#b44">[+] 参数说明:
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    -h: 查看帮助信息
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    -H: 远程服务器地址
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    -P: 远程服务器端口
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    -r: 远程文件路径
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    -l: 本地文件路径
</span></span></span><span style="display:flex;"><span><span style="color:#b44">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(help_message)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">elif</span> <span style="color:#a2f">len</span>(sys<span style="color:#666">.</span>argv) <span style="color:#666">!=</span> <span style="color:#666">9</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">&#39;[-] 参数错误！输入-h查看帮助信息&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">elif</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">1</span>] <span style="color:#666">!=</span> <span style="color:#b44">&#39;-H&#39;</span> <span style="color:#a2f;font-weight:bold">or</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">3</span>] <span style="color:#666">!=</span> <span style="color:#b44">&#39;-P&#39;</span> <span style="color:#a2f;font-weight:bold">or</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">5</span>] <span style="color:#666">!=</span> <span style="color:#b44">&#39;-r&#39;</span> <span style="color:#a2f;font-weight:bold">or</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">7</span>] <span style="color:#666">!=</span> <span style="color:#b44">&#39;-l&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">&#39;[-] 参数错误！输入-h查看帮助信息&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    host <span style="color:#666">=</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">2</span>]
</span></span><span style="display:flex;"><span>    port <span style="color:#666">=</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">4</span>]
</span></span><span style="display:flex;"><span>    remote_file_path <span style="color:#666">=</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">6</span>]
</span></span><span style="display:flex;"><span>    local_file_path <span style="color:#666">=</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">8</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>        port <span style="color:#666">=</span> <span style="color:#a2f">int</span>(port)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">except</span> <span style="color:#d2413a;font-weight:bold">Exception</span> <span style="color:#a2f;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">&#39;[-] 端口号必须为整数！&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(e)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>        client <span style="color:#666">=</span> socket<span style="color:#666">.</span>socket(socket<span style="color:#666">.</span>AF_INET, socket<span style="color:#666">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>        client<span style="color:#666">.</span>connect((host, port))
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">except</span> <span style="color:#d2413a;font-weight:bold">Exception</span> <span style="color:#a2f;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">&#39;[-] 连接服务器失败！&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(e)
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 发送要下载的文件路径</span>
</span></span><span style="display:flex;"><span>    client<span style="color:#666">.</span>send(remote_file_path<span style="color:#666">.</span>encode())
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 接收文件是否存在</span>
</span></span><span style="display:flex;"><span>    rev <span style="color:#666">=</span> client<span style="color:#666">.</span>recv(<span style="color:#666">1024</span>)<span style="color:#666">.</span>decode()
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">if</span> rev <span style="color:#666">==</span> <span style="color:#b44">&#39;FILE NOT FOUND&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#39;[-] </span><span style="color:#b68;font-weight:bold">{</span>remote_file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 文件不存在&#39;</span>)
</span></span><span style="display:flex;"><span>        client<span style="color:#666">.</span>close()
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 发送确认信息</span>
</span></span><span style="display:flex;"><span>    client<span style="color:#666">.</span>send(<span style="color:#b44">&#39;start_send_file&#39;</span><span style="color:#666">.</span>encode())
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 接收文件头部长度</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f">print</span>(<span style="color:#b44">&#39;[*] 正在接收文件头部信息...&#39;</span>)
</span></span><span style="display:flex;"><span>    rev <span style="color:#666">=</span> client<span style="color:#666">.</span>recv(<span style="color:#666">10</span>)
</span></span><span style="display:flex;"><span>    file_header_size <span style="color:#666">=</span> struct<span style="color:#666">.</span>unpack(<span style="color:#b44">&#39;i&#39;</span>, rev)[<span style="color:#666">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 发送确认信息</span>
</span></span><span style="display:flex;"><span>    client<span style="color:#666">.</span>send(<span style="color:#b44">&#39;header_size_ok&#39;</span><span style="color:#666">.</span>encode())
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 接收文件头部信息</span>
</span></span><span style="display:flex;"><span>    file_header_bytes <span style="color:#666">=</span> client<span style="color:#666">.</span>recv(file_header_size)
</span></span><span style="display:flex;"><span>    file_header_json <span style="color:#666">=</span> file_header_bytes<span style="color:#666">.</span>decode()
</span></span><span style="display:flex;"><span>    file_header <span style="color:#666">=</span> json<span style="color:#666">.</span>loads(file_header_json)
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 发送确认信息</span>
</span></span><span style="display:flex;"><span>    client<span style="color:#666">.</span>send(<span style="color:#b44">&#39;header_ok&#39;</span><span style="color:#666">.</span>encode())
</span></span><span style="display:flex;"><span>    <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#39;[+] 文件名：</span><span style="color:#b68;font-weight:bold">{</span>file_header[<span style="color:#b44">&#34;file_name&#34;</span>]<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> | 文件大小：</span><span style="color:#b68;font-weight:bold">{</span>file_header[<span style="color:#b44">&#34;file_size&#34;</span>]<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> B&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 接收文件内容</span>
</span></span><span style="display:flex;"><span>    recv_file(client, local_file_path, file_header[<span style="color:#b44">&#39;file_size&#39;</span>])
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">recv_file</span>(client_socket, local_file_path, file_size):
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">with</span> <span style="color:#a2f">open</span>(local_file_path, <span style="color:#b44">&#39;wb&#39;</span>) <span style="color:#a2f;font-weight:bold">as</span> file:
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-style:italic"># 显示tqdm进度条</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">for</span> _ <span style="color:#a2f;font-weight:bold">in</span> tqdm(<span style="color:#a2f">range</span>(file_size <span style="color:#666">//</span> <span style="color:#666">1024</span>), desc<span style="color:#666">=</span><span style="color:#b44">&#34;接收中&#34;</span>, unit<span style="color:#666">=</span><span style="color:#b44">&#34;KB&#34;</span>, unit_scale<span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">True</span>):
</span></span><span style="display:flex;"><span>                file_data <span style="color:#666">=</span> client_socket<span style="color:#666">.</span>recv(<span style="color:#666">1024</span>)
</span></span><span style="display:flex;"><span>                file<span style="color:#666">.</span>write(file_data)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">except</span> <span style="color:#d2413a;font-weight:bold">Exception</span> <span style="color:#a2f;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[-] </span><span style="color:#b68;font-weight:bold">{</span>local_file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 文件接收失败&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#34;[+] </span><span style="color:#b68;font-weight:bold">{</span>local_file_path<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 文件接收成功&#34;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span> __name__ <span style="color:#666">==</span> <span style="color:#b44">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    main()
</span></span></code></pre></div><h3 id="程序测试方法及测试结果记录">程序测试方法及测试结果记录</h3>
<ol>
<li>测试方法</li>
</ol>
<p>对于单线程的服务端，采用下载单个文件，检测下载过程中，客户端和服务端是否正常，并且能够处理异常情况</p>
<p>对于多线程、异步的服务端，采用同时下载两个或者多个文件的形式，检测下载过程众怒给，客户端和服务端是否正常，并且能够处理多种的异常情况</p>
<ol start="2">
<li>测试流程</li>
</ol>
<p>单线程：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192629.png" alt="client端使用说明"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192635.png" alt="server端使用说明"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192646.png" alt="client端接收logo.png文件"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192653.png" alt="server端显示的日志信息"></p>
<p>多线程：</p>
<p>客户端和服务端使用说明，同单线程的情况</p>
<p><img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192700.png" alt="client端接收file.zip大文件的过程"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192705.png" alt="另一client端同时接收logo.png文件成功"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192709.png" alt="server端显示的日志信息"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192714.png" alt=" client端接收大文件file.zip成功"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192718.png" alt="全部client端接收文件成功后server端的日志信息"></p>
<p>Asyncio异步：</p>
<p>客户端和服务端使用说明，同单线程的情况</p>
<p><img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192730.png" alt="client端接收file.zip文件过程"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192734.png" alt="另一client端同时接收logo.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192739.png" alt="server端显示的日志信息"></p>
<h3 id="实验分析总结及心得">实验分析总结及心得</h3>
<p><strong>实验过程中参考的文献：</strong></p>
<p><a href="https://blog.csdn.net/FY_13781298928/article/details/133747112">Python使用Asyncio开发TCP服务器简单案例-CSDN博客</a></p>
<p><a href="https://juejin.cn/post/7120545649891737614">asyncio实现异步socket server - 掘金 (juejin.cn)</a></p>
<p><a href="https://www.birdpython.com/posts/1/88/">异步网络模型 - 老鸟python (birdpython.com)</a></p>
<p><a href="https://www.cnblogs.com/-wenli/p/11192394.html">python异步编程&ndash;回调模型(selectors模块) - -零 - 博客园 (cnblogs.com)</a></p>
<p><strong>总结一下：</strong>
多线程的原理就是，在执行一个任务，当这个任务处于阻塞或者IO操作时，可以开启另外一个新的线程去执行另外有一个工作，提高执行效率。但是缺点就是整个线程的阻塞判断和线程切换都是程序自动判断，人为不能干预。</p>
<p>由此引出了协程的概念，协程就是在切换任务的时候，是我们在编程可以指定的。单线程异步就用了这样的思想，asyncio是单进程并发库，不是多线程，也不是多进程，单纯是在一个进程里面异步（切来切去运行），切换的地方用await标记，能够切换的函数用async标记，从而避免程序自动判断切换。</p>
<p>而对于select模型和poll模型的异步思想，是单线程轮询策略，核心就是在循环中，不断的select从任务列表取出可以读和写的fd对象，然后对其进行不同的处理，就是把所有的接收Socket数据和发送Socket数据都存在各自的列表队列里，之后循环每个队列中的每个对象，处理对应的事件操作。poll提供了register、modify、unregister、poll等方法，运行逻辑就是，如果是需要监测的事件，就将其register到poll对象中，然后通过poll方法不断取出就绪的fd，根据fd的事件类型(POLLIN, POLLOUT)对其进行不同的处理。</p>
<p>总的来说，单线程、多线程、asyncio实现的异步都很简单，很快就能写出来，但是select和poll模型就相对来说比较困难，本身的实现格式比较复杂，同时我设计的协议也并不简单，所以利用select模型实现异步还是比较困难的，最后虽然通过简化协议流程实现了这个服务端代码但是实现的效果还是不理想，异步处理的单个事件还是太大了，不知道怎么细化，还是有很大的改进空间的。</p>
    
  </article>
  <div class="paginator">
    
    <a class="link" href="https://blog.pi3.fun/post/2023/12/%E5%BE%AE%E4%BF%A1%E5%AE%9A%E6%97%B6%E5%8F%91%E9%80%81%E5%80%92%E6%95%B0%E6%97%A5/">← prev</a>
    
    
    <a class="link" href="https://blog.pi3.fun/post/2023/12/windows10%E4%B8%8B%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8wsa/">next →</a>
    
  </div>
  <div class="comment">
    
    
    
    
    
    
  </div>
  
</main>

    <footer id="footer">
  <div>
    <span>© 2021</span> - <span>2024</span>
    <span> 🍦 By LiuChao</span>
  </div>

  

  <div class="footnote">
    <span>Follow me on <a class=link href=https://github.com/Pi3-l22 Target=_ blank>GitHub</a> | <a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a>
</span>
  </div>
</footer>

  </div>

  
  

  
  

  
  

</body>

</html>
