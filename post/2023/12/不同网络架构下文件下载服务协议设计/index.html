<!doctype html><html lang=zh-cn><head><script>(function(){const e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)})()</script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=author content="LiuChao"><meta name=description content="A personal notebook to record my studies and life"><link rel=icon href=https://blog.pi3.fun/favicon.ico><meta name=keywords content=" study  latex  life  academic "><meta property="og:url" content="https://blog.pi3.fun/post/2023/12/%E4%B8%8D%E5%90%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E4%B8%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%9C%8D%E5%8A%A1%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1/"><meta property="og:site_name" content="Pi3's Notes"><meta property="og:title" content="不同网络架构下文件下载服务协议设计"><meta property="og:description" content="A personal notebook to record my studies and life"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-12-20T00:00:00+00:00"><meta property="article:modified_time" content="2023-12-20T00:00:00+00:00"><meta property="article:tag" content="技术"><meta property="article:tag" content="Python"><meta property="article:tag" content="Socket"><link rel=canonical href=https://blog.pi3.fun/post/2023/12/%E4%B8%8D%E5%90%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E4%B8%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%9C%8D%E5%8A%A1%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1/><meta itemprop=name content="不同网络架构下文件下载服务协议设计"><meta itemprop=description content="A personal notebook to record my studies and life"><meta itemprop=datePublished content="2023-12-20T00:00:00+00:00"><meta itemprop=dateModified content="2023-12-20T00:00:00+00:00"><meta itemprop=wordCount content="4615"><meta itemprop=keywords content="技术,Python,Socket"><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/common.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/content.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/theme.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/iconfont/iconfont.css><link rel=stylesheet href=https://blog.pi3.fun/css/syntax/xcode.css data-theme-style=light media="(prefers-color-scheme: light)"><link rel=stylesheet href=https://blog.pi3.fun/css/syntax/catppuccin-mocha.css data-theme-style=dark media="not all"><title>不同网络架构下文件下载服务协议设计 - Pi3's Notes</title>
<link rel=stylesheet href=https://blog.pi3.fun/css/single.css><link href=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/katex.min.css rel=stylesheet><script defer src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/katex.min.js></script><script defer src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}],ignoredTags:["script","noscript","style","textarea","pre","code","option"],throwOnError:!1})})</script></head><body><div id=wrapper><header id=header><h1><a href=https://blog.pi3.fun/>Pi3's Notes</a></h1><nav><span class=nav-bar-item><a class=link href=/>文章</a>
</span><span class=nav-bar-item><a class=link href=/post/>归档</a>
</span><span class=nav-bar-item><a class=link href=/about/>关于</a>
</span><span class=nav-bar-item><a class=link href=/links/>友链</a>
</span><span class=nav-bar-item><a class="link theme-toggle" href=javascript:void(0);>黑暗</a></span></nav></header><main id=main class=post><h1>不同网络架构下文件下载服务协议设计</h1><div><b>Keywords: </b><a class=link href=https://blog.pi3.fun/tags/%E6%8A%80%E6%9C%AF>#技术</a>
<a class=link href=https://blog.pi3.fun/tags/python>#Python</a>
<a class=link href=https://blog.pi3.fun/tags/socket>#Socket</a></div><details><summary><b>Table of Contents</b></summary><div class=toc><nav id=TableOfContents><ul><li><a href=#实验目的>实验目的</a></li><li><a href=#实验内容>实验内容</a></li><li><a href=#程序设计思路>程序设计思路</a><ul><li><a href=#网络应用拓扑结构>网络应用拓扑结构</a></li><li><a href=#应用层协议设计>应用层协议设计</a></li><li><a href=#所选用的python库介绍>所选用的Python库介绍</a></li><li><a href=#程序源代码>程序源代码</a></li><li><a href=#程序测试方法及测试结果记录>程序测试方法及测试结果记录</a></li><li><a href=#实验分析总结及心得>实验分析总结及心得</a></li></ul></li></ul></nav></div></details><article class=content><h2 id=实验目的>实验目的</h2><ol><li>熟悉不同网络架构的特点。</li><li>掌握不同网络架构下的文件下载服务协议设计。</li></ol><h2 id=实验内容>实验内容</h2><p>使用TCP协议设计一个文件下载服务协议，客户端发送要下载的文件路径给服务器，服务器将对应的文件内容送给客户端，客户端将文件存储到本地磁盘。注意，当文件不存在时给出提示。要求，服务的实现分别采用以下三种方法实现：</p><p>(1)单线程，迭代服务器(依次服务每一个客户端)</p><p>(2)多线程，并发服务器</p><p>(3)异步方式 asyncio库</p><p>例如：
<code>$ python download_server.py [-h] [-p port] host</code>
<code>$ python download_client.py [-h] [-p port] host remote_file local_file</code>
完成将服务器的文件remote_file下载到本地，命名为local_file</p><h2 id=程序设计思路>程序设计思路</h2><h3 id=网络应用拓扑结构>网络应用拓扑结构</h3><p>一对多的网络结构，即一台服务器对应多台客户端的星型拓扑结构</p><p><img src=https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192026.png alt=网络拓扑结构></p><h3 id=应用层协议设计>应用层协议设计</h3><p>客户端连接到服务端，服务端监听到客户端的连接。</p><p>客户端 &ndash;> 需要下载的文件路径 &ndash;> 服务端</p><p>客户端 &lt;&ndash; 文件是否存在 &lt;&ndash; 服务端</p><p>不存在则双方退出协议，存在则继续</p><p>客户端 &ndash;> 确认文件存在消息 &ndash;> 服务端</p><p>客户端 &lt;&ndash; 文件头部信息长度 &lt;&ndash; 服务端</p><p>客户端 &ndash;> 确认头部长度消息 &ndash;> 服务端</p><p>客户端 &lt;&ndash; 文件头部信息 &lt;&ndash; 服务端</p><p>客户端 &ndash;> 确认头部信息消息 &ndash;> 服务端</p><p>客户端 &lt;&ndash; 文件内容数据 &lt;&ndash; 服务端</p><p>双方退出协议部分</p><h3 id=所选用的python库介绍>所选用的Python库介绍</h3><p>import socket # 套接字</p><p>import sys # 系统操作</p><p>import zipfile # 压缩文件</p><p>import struct # 字符串打包解包</p><p>import json # json序列化</p><p>from tqdm import tqdm # 进度条</p><p>import threading # 多线程</p><p>import asyncio # 异步IO</p><p>import aiofiles # 异步文件IO</p><p>import selectors # selectors模块单线程异步轮询</p><h3 id=程序源代码>程序源代码</h3><h4 id=服务器端源码>服务器端源码</h4><p><strong>单线程服务端：</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>zipfile</span>  <span class=c1># 压缩文件</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>  <span class=c1># json序列化</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>  <span class=c1># 字符串打包解包</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_client</span><span class=p>(</span><span class=n>client_socket</span><span class=p>,</span> <span class=n>client_address</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>flag</span> <span class=o>=</span> <span class=kc>False</span>  <span class=c1># 是否为文件夹</span>
</span></span><span class=line><span class=cl>    <span class=c1># 接收客户端发送的文件路径</span>
</span></span><span class=line><span class=cl>    <span class=n>file_path</span> <span class=o>=</span> <span class=n>client_socket</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># 判断文件或者文件夹是否存在</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>file_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] 发送 </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2> 给 </span><span class=si>{</span><span class=n>client_address</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 发送文件存在的确认信息</span>
</span></span><span class=line><span class=cl>        <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&#34;file_exist&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=c1># 接收客户端的确认信息</span>
</span></span><span class=line><span class=cl>        <span class=n>rev</span> <span class=o>=</span> <span class=n>client_socket</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rev</span> <span class=o>!=</span> <span class=s1>&#39;start_send_file&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] </span><span class=si>{</span><span class=n>client_address</span><span class=si>}</span><span class=s2> 取消发送 </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=c1># 如果是文件夹，就压缩打包成zip文件</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>isdir</span><span class=p>(</span><span class=n>file_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>zip_file_path</span> <span class=o>=</span> <span class=n>file_path</span> <span class=o>+</span> <span class=s1>&#39;.zip&#39;</span>
</span></span><span class=line><span class=cl>            <span class=n>zip_file</span> <span class=o>=</span> <span class=n>zipfile</span><span class=o>.</span><span class=n>ZipFile</span><span class=p>(</span><span class=n>zip_file_path</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>,</span> <span class=n>zipfile</span><span class=o>.</span><span class=n>ZIP_DEFLATED</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>root</span><span class=p>,</span> <span class=n>dirs</span><span class=p>,</span> <span class=n>files</span> <span class=ow>in</span> <span class=n>os</span><span class=o>.</span><span class=n>walk</span><span class=p>(</span><span class=n>file_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>file</span> <span class=ow>in</span> <span class=n>files</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>zip_file</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>root</span><span class=p>,</span> <span class=n>file</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>zip_file</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>flag</span> <span class=o>=</span> <span class=kc>True</span>  <span class=c1># 是否为文件夹</span>
</span></span><span class=line><span class=cl>            <span class=n>file_path</span> <span class=o>=</span> <span class=n>zip_file_path</span>
</span></span><span class=line><span class=cl>        <span class=c1># 发送文件头部信息{文件名，文件大小，文件类型}</span>
</span></span><span class=line><span class=cl>        <span class=n>file_name</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>basename</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>file_size</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>getsize</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>file_type</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>splitext</span><span class=p>(</span><span class=n>file_path</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>file_header</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;file_name&#39;</span><span class=p>:</span> <span class=n>file_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;file_size&#39;</span><span class=p>:</span> <span class=n>file_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;file_type&#39;</span><span class=p>:</span> <span class=n>file_type</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1># json序列化</span>
</span></span><span class=line><span class=cl>        <span class=n>file_header_json</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>file_header</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>file_header_bytes</span> <span class=o>=</span> <span class=n>file_header_json</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># 将文件头部信息的长度打包成固定长度的字符串</span>
</span></span><span class=line><span class=cl>        <span class=n>header_size</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;i&#39;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>file_header_bytes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=c1># 先发送文件头部信息的长度</span>
</span></span><span class=line><span class=cl>        <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>header_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 接收客户端的确认信息</span>
</span></span><span class=line><span class=cl>        <span class=n>rev</span> <span class=o>=</span> <span class=n>client_socket</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rev</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span> <span class=o>!=</span> <span class=s1>&#39;header_size_ok&#39;</span><span class=p>:</span>  <span class=c1># 如果客户端确认信息不是header_size_ok</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] </span><span class=si>{</span><span class=n>client_address</span><span class=si>}</span><span class=s2> 取消发送 </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=c1># 再发送文件头部信息</span>
</span></span><span class=line><span class=cl>        <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>file_header_bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 接收客户端的确认信息</span>
</span></span><span class=line><span class=cl>        <span class=n>rev</span> <span class=o>=</span> <span class=n>client_socket</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rev</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span> <span class=o>==</span> <span class=s1>&#39;header_ok&#39;</span><span class=p>:</span>  <span class=c1># 如果客户端确认信息不是header_ok</span>
</span></span><span class=line><span class=cl>            <span class=c1># 发送文件内容</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;[*] 正在发送文件 </span><span class=si>{</span><span class=n>file_name</span><span class=si>}</span><span class=s1> 内容...&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>send_file</span><span class=p>(</span><span class=n>client_socket</span><span class=p>,</span> <span class=n>file_path</span><span class=p>,</span> <span class=n>file_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 删除文件夹压缩包</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>flag</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>os</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&#34;FILE NOT FOUND&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2> 文件不存在&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_file</span><span class=p>(</span><span class=n>client_socket</span><span class=p>,</span> <span class=n>file_path</span><span class=p>,</span> <span class=n>file_size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 显示tqdm进度条</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>file_size</span> <span class=o>//</span> <span class=mi>1024</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>file_data</span> <span class=o>=</span> <span class=n>file</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>file_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2> 文件发送失败</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2> 文件发送成功</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>client_socket</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;-h&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>help_message</span> <span class=o>=</span> <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>[+] 用法:
</span></span></span><span class=line><span class=cl><span class=s1>    python server.py [-h] [-P port]
</span></span></span><span class=line><span class=cl><span class=s1> 
</span></span></span><span class=line><span class=cl><span class=s1>[+] 参数说明:
</span></span></span><span class=line><span class=cl><span class=s1>    -h: 查看帮助信息
</span></span></span><span class=line><span class=cl><span class=s1>    -P: 本地服务器监听端口
</span></span></span><span class=line><span class=cl><span class=s1>    &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>help_message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[-] 参数错误！输入-h查看帮助信息&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;-P&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[-] 参数错误！输入-h查看帮助信息&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=n>host</span> <span class=o>=</span> <span class=s1>&#39;127.0.0.1&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>port</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[-] 端口号必须为整数！&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>server</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] 服务器正在监听：</span><span class=si>{</span><span class=n>host</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 接收客户端连接</span>
</span></span><span class=line><span class=cl>            <span class=n>client_socket</span><span class=p>,</span> <span class=n>client_address</span> <span class=o>=</span> <span class=n>server</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] 接收到客户端连接：</span><span class=si>{</span><span class=n>client_address</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 处理客户端请求</span>
</span></span><span class=line><span class=cl>            <span class=n>handle_client</span><span class=p>(</span><span class=n>client_socket</span><span class=p>,</span> <span class=n>client_address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>KeyboardInterrupt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[-] 服务器已停止运行&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=c1># 关闭客户端连接</span>
</span></span><span class=line><span class=cl>    <span class=n>client_socket</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><p><strong>多线程服务端：</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>zipfile</span>  <span class=c1># 压缩文件</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>  <span class=c1># json序列化</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>  <span class=c1># 字符串打包解包</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_client</span><span class=p>(</span><span class=n>client_socket</span><span class=p>,</span> <span class=n>client_address</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>flag</span> <span class=o>=</span> <span class=kc>False</span>  <span class=c1># 是否为文件夹</span>
</span></span><span class=line><span class=cl>    <span class=c1># 接收客户端发送的文件路径</span>
</span></span><span class=line><span class=cl>    <span class=n>file_path</span> <span class=o>=</span> <span class=n>client_socket</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># 判断文件或者文件夹是否存在</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>file_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] 发送 </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2> 给 </span><span class=si>{</span><span class=n>client_address</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 发送文件存在的确认信息</span>
</span></span><span class=line><span class=cl>        <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&#34;file_exist&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=c1># 接收客户端的确认信息</span>
</span></span><span class=line><span class=cl>        <span class=n>rev</span> <span class=o>=</span> <span class=n>client_socket</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rev</span> <span class=o>!=</span> <span class=s1>&#39;start_send_file&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] </span><span class=si>{</span><span class=n>client_address</span><span class=si>}</span><span class=s2> 取消发送 </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=c1># 如果是文件夹，就压缩打包成zip文件</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>isdir</span><span class=p>(</span><span class=n>file_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>zip_file_path</span> <span class=o>=</span> <span class=n>file_path</span> <span class=o>+</span> <span class=s1>&#39;.zip&#39;</span>
</span></span><span class=line><span class=cl>            <span class=n>zip_file</span> <span class=o>=</span> <span class=n>zipfile</span><span class=o>.</span><span class=n>ZipFile</span><span class=p>(</span><span class=n>zip_file_path</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>,</span> <span class=n>zipfile</span><span class=o>.</span><span class=n>ZIP_DEFLATED</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>root</span><span class=p>,</span> <span class=n>dirs</span><span class=p>,</span> <span class=n>files</span> <span class=ow>in</span> <span class=n>os</span><span class=o>.</span><span class=n>walk</span><span class=p>(</span><span class=n>file_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>file</span> <span class=ow>in</span> <span class=n>files</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>zip_file</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>root</span><span class=p>,</span> <span class=n>file</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>zip_file</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>flag</span> <span class=o>=</span> <span class=kc>True</span>  <span class=c1># 是否为文件夹</span>
</span></span><span class=line><span class=cl>            <span class=n>file_path</span> <span class=o>=</span> <span class=n>zip_file_path</span>
</span></span><span class=line><span class=cl>        <span class=c1># 发送文件头部信息{文件名，文件大小，文件类型}</span>
</span></span><span class=line><span class=cl>        <span class=n>file_name</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>basename</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>file_size</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>getsize</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>file_type</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>splitext</span><span class=p>(</span><span class=n>file_path</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>file_header</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;file_name&#39;</span><span class=p>:</span> <span class=n>file_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;file_size&#39;</span><span class=p>:</span> <span class=n>file_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;file_type&#39;</span><span class=p>:</span> <span class=n>file_type</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1># json序列化</span>
</span></span><span class=line><span class=cl>        <span class=n>file_header_json</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>file_header</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>file_header_bytes</span> <span class=o>=</span> <span class=n>file_header_json</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># 将文件头部信息的长度打包成固定长度的字符串</span>
</span></span><span class=line><span class=cl>        <span class=n>header_size</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;i&#39;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>file_header_bytes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=c1># 先发送文件头部信息的长度</span>
</span></span><span class=line><span class=cl>        <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>header_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 接收客户端的确认信息</span>
</span></span><span class=line><span class=cl>        <span class=n>rev</span> <span class=o>=</span> <span class=n>client_socket</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rev</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span> <span class=o>!=</span> <span class=s1>&#39;header_size_ok&#39;</span><span class=p>:</span>  <span class=c1># 如果客户端确认信息不是header_size_ok</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] </span><span class=si>{</span><span class=n>client_address</span><span class=si>}</span><span class=s2> 取消发送 </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=c1># 再发送文件头部信息</span>
</span></span><span class=line><span class=cl>        <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>file_header_bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 接收客户端的确认信息</span>
</span></span><span class=line><span class=cl>        <span class=n>rev</span> <span class=o>=</span> <span class=n>client_socket</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rev</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span> <span class=o>==</span> <span class=s1>&#39;header_ok&#39;</span><span class=p>:</span>  <span class=c1># 如果客户端确认信息不是header_ok</span>
</span></span><span class=line><span class=cl>            <span class=c1># 发送文件内容</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;[*] 正在发送文件 </span><span class=si>{</span><span class=n>file_name</span><span class=si>}</span><span class=s1> 内容...&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>send_file</span><span class=p>(</span><span class=n>client_socket</span><span class=p>,</span> <span class=n>file_path</span><span class=p>,</span> <span class=n>file_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 删除文件夹压缩包</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>flag</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>os</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&#34;FILE NOT FOUND&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2> 文件不存在&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_file</span><span class=p>(</span><span class=n>client_socket</span><span class=p>,</span> <span class=n>file_path</span><span class=p>,</span> <span class=n>file_size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 显示tqdm进度条</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>file_size</span> <span class=o>//</span> <span class=mi>1024</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>file_data</span> <span class=o>=</span> <span class=n>file</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>file_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2> 文件发送失败&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2> 文件发送成功&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>client_socket</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;-h&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>help_message</span> <span class=o>=</span> <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>[+] 用法:
</span></span></span><span class=line><span class=cl><span class=s1>    python server.py [-h] [-P port]
</span></span></span><span class=line><span class=cl><span class=s1> 
</span></span></span><span class=line><span class=cl><span class=s1>[+] 参数说明:
</span></span></span><span class=line><span class=cl><span class=s1>    -h: 查看帮助信息
</span></span></span><span class=line><span class=cl><span class=s1>    -P: 本地服务器监听端口
</span></span></span><span class=line><span class=cl><span class=s1>    &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>help_message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[-] 参数错误！输入-h查看帮助信息&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;-P&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[-] 参数错误！输入-h查看帮助信息&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=n>host</span> <span class=o>=</span> <span class=s1>&#39;127.0.0.1&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>port</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[-] 端口号必须为整数！&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>server</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] 服务器正在监听：</span><span class=si>{</span><span class=n>host</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 接收客户端连接</span>
</span></span><span class=line><span class=cl>            <span class=n>client_socket</span><span class=p>,</span> <span class=n>client_address</span> <span class=o>=</span> <span class=n>server</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] 接收到客户端连接：</span><span class=si>{</span><span class=n>client_address</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 多线程处理客户端请求</span>
</span></span><span class=line><span class=cl>            <span class=c1># handle_client(client_socket, client_address)</span>
</span></span><span class=line><span class=cl>            <span class=n>client_thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>handle_client</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>client_socket</span><span class=p>,</span> <span class=n>client_address</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>client_thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>KeyboardInterrupt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[-] 服务器已停止运行&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=c1># 关闭客户端连接</span>
</span></span><span class=line><span class=cl>    <span class=n>client_socket</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><p><strong>asyncio异步服务端：</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>zipfile</span>  <span class=c1># 压缩文件</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>  <span class=c1># json序列化</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>  <span class=c1># 字符串打包解包</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>  <span class=c1># 异步IO socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>aiofiles</span>  <span class=c1># 异步文件IO</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>handle_client</span><span class=p>(</span><span class=n>reader</span><span class=p>,</span> <span class=n>writer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 获取客户端信息</span>
</span></span><span class=line><span class=cl>    <span class=n>client_address</span> <span class=o>=</span> <span class=n>writer</span><span class=o>.</span><span class=n>get_extra_info</span><span class=p>(</span><span class=s1>&#39;peername&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] 接收到客户端连接：</span><span class=si>{</span><span class=n>client_address</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>flag</span> <span class=o>=</span> <span class=kc>False</span>  <span class=c1># 是否为文件夹</span>
</span></span><span class=line><span class=cl>    <span class=c1># 接收客户端发送的文件路径</span>
</span></span><span class=line><span class=cl>    <span class=n>file_path</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span><span class=n>reader</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>1024</span><span class=p>),</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>file_path</span> <span class=o>=</span> <span class=n>file_path</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># 判断文件或者文件夹是否存在</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>file_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] 发送 </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2> 给 </span><span class=si>{</span><span class=n>client_address</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 发送文件存在的确认信息</span>
</span></span><span class=line><span class=cl>        <span class=n>writer</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&#34;file_exist&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>writer</span><span class=o>.</span><span class=n>drain</span><span class=p>()</span>  <span class=c1># 清空套接字 刷新缓冲区</span>
</span></span><span class=line><span class=cl>        <span class=c1># 接收客户端的确认信息</span>
</span></span><span class=line><span class=cl>        <span class=n>rev</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span><span class=n>reader</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>1024</span><span class=p>),</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rev</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span> <span class=o>!=</span> <span class=s1>&#39;start_send_file&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] </span><span class=si>{</span><span class=n>client_address</span><span class=si>}</span><span class=s2> 取消发送 </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=c1># 如果是文件夹，就压缩打包成zip文件</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>isdir</span><span class=p>(</span><span class=n>file_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>file_path</span> <span class=o>=</span> <span class=k>await</span> <span class=n>zip_file</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 发送文件头部信息{文件名，文件大小，文件类型}</span>
</span></span><span class=line><span class=cl>        <span class=n>file_name</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>basename</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>file_size</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>getsize</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>file_type</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>splitext</span><span class=p>(</span><span class=n>file_path</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>file_header</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;file_name&#39;</span><span class=p>:</span> <span class=n>file_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;file_size&#39;</span><span class=p>:</span> <span class=n>file_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;file_type&#39;</span><span class=p>:</span> <span class=n>file_type</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1># json序列化</span>
</span></span><span class=line><span class=cl>        <span class=n>file_header_json</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>file_header</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>file_header_bytes</span> <span class=o>=</span> <span class=n>file_header_json</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># 将文件头部信息的长度打包成固定长度的字符串</span>
</span></span><span class=line><span class=cl>        <span class=n>header_size</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;i&#39;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>file_header_bytes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=c1># 先发送文件头部信息的长度</span>
</span></span><span class=line><span class=cl>        <span class=n>writer</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>header_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>writer</span><span class=o>.</span><span class=n>drain</span><span class=p>()</span>  <span class=c1># 清空套接字 刷新缓冲区</span>
</span></span><span class=line><span class=cl>        <span class=c1># 接收客户端的确认信息</span>
</span></span><span class=line><span class=cl>        <span class=n>rev</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span><span class=n>reader</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>1024</span><span class=p>),</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rev</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span> <span class=o>!=</span> <span class=s1>&#39;header_size_ok&#39;</span><span class=p>:</span>  <span class=c1># 如果客户端确认信息不是header_size_ok</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] </span><span class=si>{</span><span class=n>client_address</span><span class=si>}</span><span class=s2> 取消发送 </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=c1># 再发送文件头部信息</span>
</span></span><span class=line><span class=cl>        <span class=n>writer</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>file_header_bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>writer</span><span class=o>.</span><span class=n>drain</span><span class=p>()</span>  <span class=c1># 清空套接字 刷新缓冲区</span>
</span></span><span class=line><span class=cl>        <span class=c1># 接收客户端的确认信息</span>
</span></span><span class=line><span class=cl>        <span class=n>rev</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span><span class=n>reader</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>1024</span><span class=p>),</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rev</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span> <span class=o>==</span> <span class=s1>&#39;header_ok&#39;</span><span class=p>:</span>  <span class=c1># 如果客户端确认信息不是header_ok</span>
</span></span><span class=line><span class=cl>            <span class=c1># 发送文件内容</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;[*] 正在发送文件 </span><span class=si>{</span><span class=n>file_name</span><span class=si>}</span><span class=s1> 内容...&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># send_file(client_socket, file_path, file_size)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 异步发送文件内容</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>send_file</span><span class=p>(</span><span class=n>writer</span><span class=p>,</span> <span class=n>file_path</span><span class=p>,</span> <span class=n>file_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 删除文件夹压缩包</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>flag</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>os</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>client_socket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&#34;FILE NOT FOUND&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2> 文件不存在&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>writer</span><span class=o>.</span><span class=n>drain</span><span class=p>()</span>  <span class=c1># 清理 刷新缓冲区</span>
</span></span><span class=line><span class=cl>    <span class=n>writer</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>  <span class=c1># 关闭连接</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>zip_file</span><span class=p>(</span><span class=n>file_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>zip_file_path</span> <span class=o>=</span> <span class=n>file_path</span> <span class=o>+</span> <span class=s1>&#39;.zip&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>zip_file</span> <span class=o>=</span> <span class=n>zipfile</span><span class=o>.</span><span class=n>ZipFile</span><span class=p>(</span><span class=n>zip_file_path</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>,</span> <span class=n>zipfile</span><span class=o>.</span><span class=n>ZIP_DEFLATED</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>root</span><span class=p>,</span> <span class=n>dirs</span><span class=p>,</span> <span class=n>files</span> <span class=ow>in</span> <span class=n>os</span><span class=o>.</span><span class=n>walk</span><span class=p>(</span><span class=n>file_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>file</span> <span class=ow>in</span> <span class=n>files</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>zip_file</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>root</span><span class=p>,</span> <span class=n>file</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>zip_file</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>flag</span> <span class=o>=</span> <span class=kc>True</span>  <span class=c1># 是否为文件夹</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>zip_file_path</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>send_file</span><span class=p>(</span><span class=n>writer</span><span class=p>,</span> <span class=n>file_path</span><span class=p>,</span> <span class=n>file_size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>with</span> <span class=n>aiofiles</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 显示tqdm进度条</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>file_size</span> <span class=o>//</span> <span class=mi>1024</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>file_data</span> <span class=o>=</span> <span class=k>await</span> <span class=n>file</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>writer</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>file_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2> 文件发送失败</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2> 文件发送成功</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>client_socket</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;-h&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>help_message</span> <span class=o>=</span> <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>[+] 用法:
</span></span></span><span class=line><span class=cl><span class=s1>    python server.py [-h] [-P port]
</span></span></span><span class=line><span class=cl><span class=s1> 
</span></span></span><span class=line><span class=cl><span class=s1>[+] 参数说明:
</span></span></span><span class=line><span class=cl><span class=s1>    -h: 查看帮助信息
</span></span></span><span class=line><span class=cl><span class=s1>    -P: 本地服务器监听端口
</span></span></span><span class=line><span class=cl><span class=s1>    &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>help_message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[-] 参数错误！输入-h查看帮助信息&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;-P&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[-] 参数错误！输入-h查看帮助信息&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=n>host</span> <span class=o>=</span> <span class=s1>&#39;127.0.0.1&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>port</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[-] 端口号必须为整数！&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] 服务器正在监听：</span><span class=si>{</span><span class=n>host</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 生成一个asyncio服务器</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>start_server</span><span class=p>(</span><span class=n>handle_client</span><span class=p>,</span> <span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 启动服务器 循环接收客户端连接</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>with</span> <span class=n>server</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>server</span><span class=o>.</span><span class=n>serve_forever</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># 关闭客户端连接</span>
</span></span><span class=line><span class=cl>    <span class=n>client_socket</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>main</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>KeyboardInterrupt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[-] 服务器已停止运行&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h4 id=客户端源码>客户端源码</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>zipfile</span>  <span class=c1># 压缩文件</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>  <span class=c1># 字符串打包解包</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>  <span class=c1># json序列化</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>tqdm</span> <span class=kn>import</span> <span class=n>tqdm</span>  <span class=c1># 进度条</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;-h&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>help_message</span> <span class=o>=</span> <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>[+] 用法:
</span></span></span><span class=line><span class=cl><span class=s1>    python client.py [-h] [-H host] [-P port] [-r remote_file_path] [-l local_file_path]
</span></span></span><span class=line><span class=cl><span class=s1>    
</span></span></span><span class=line><span class=cl><span class=s1>[+] 参数说明:
</span></span></span><span class=line><span class=cl><span class=s1>    -h: 查看帮助信息
</span></span></span><span class=line><span class=cl><span class=s1>    -H: 远程服务器地址
</span></span></span><span class=line><span class=cl><span class=s1>    -P: 远程服务器端口
</span></span></span><span class=line><span class=cl><span class=s1>    -r: 远程文件路径
</span></span></span><span class=line><span class=cl><span class=s1>    -l: 本地文件路径
</span></span></span><span class=line><span class=cl><span class=s1>    &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>help_message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>9</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[-] 参数错误！输入-h查看帮助信息&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;-H&#39;</span> <span class=ow>or</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;-P&#39;</span> <span class=ow>or</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;-r&#39;</span> <span class=ow>or</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>7</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;-l&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[-] 参数错误！输入-h查看帮助信息&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>host</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>remote_file_path</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>6</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>local_file_path</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>8</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>port</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[-] 端口号必须为整数！&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[-] 连接服务器失败！&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1># 发送要下载的文件路径</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>remote_file_path</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=c1># 接收文件是否存在</span>
</span></span><span class=line><span class=cl>    <span class=n>rev</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>rev</span> <span class=o>==</span> <span class=s1>&#39;FILE NOT FOUND&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;[-] </span><span class=si>{</span><span class=n>remote_file_path</span><span class=si>}</span><span class=s1> 文件不存在&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=c1># 发送确认信息</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s1>&#39;start_send_file&#39;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=c1># 接收文件头部长度</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[*] 正在接收文件头部信息...&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rev</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>file_header_size</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack</span><span class=p>(</span><span class=s1>&#39;i&#39;</span><span class=p>,</span> <span class=n>rev</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1># 发送确认信息</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s1>&#39;header_size_ok&#39;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=c1># 接收文件头部信息</span>
</span></span><span class=line><span class=cl>    <span class=n>file_header_bytes</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>file_header_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>file_header_json</span> <span class=o>=</span> <span class=n>file_header_bytes</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>file_header</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>file_header_json</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 发送确认信息</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s1>&#39;header_ok&#39;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;[+] 文件名：</span><span class=si>{</span><span class=n>file_header</span><span class=p>[</span><span class=s2>&#34;file_name&#34;</span><span class=p>]</span><span class=si>}</span><span class=s1> | 文件大小：</span><span class=si>{</span><span class=n>file_header</span><span class=p>[</span><span class=s2>&#34;file_size&#34;</span><span class=p>]</span><span class=si>}</span><span class=s1> B&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 接收文件内容</span>
</span></span><span class=line><span class=cl>    <span class=n>recv_file</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>local_file_path</span><span class=p>,</span> <span class=n>file_header</span><span class=p>[</span><span class=s1>&#39;file_size&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>recv_file</span><span class=p>(</span><span class=n>client_socket</span><span class=p>,</span> <span class=n>local_file_path</span><span class=p>,</span> <span class=n>file_size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>local_file_path</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 显示tqdm进度条</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=n>tqdm</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>file_size</span> <span class=o>//</span> <span class=mi>1024</span><span class=p>),</span> <span class=n>desc</span><span class=o>=</span><span class=s2>&#34;接收中&#34;</span><span class=p>,</span> <span class=n>unit</span><span class=o>=</span><span class=s2>&#34;KB&#34;</span><span class=p>,</span> <span class=n>unit_scale</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>file_data</span> <span class=o>=</span> <span class=n>client_socket</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>file</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>file_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] </span><span class=si>{</span><span class=n>local_file_path</span><span class=si>}</span><span class=s2> 文件接收失败&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] </span><span class=si>{</span><span class=n>local_file_path</span><span class=si>}</span><span class=s2> 文件接收成功&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=程序测试方法及测试结果记录>程序测试方法及测试结果记录</h3><ol><li>测试方法</li></ol><p>对于单线程的服务端，采用下载单个文件，检测下载过程中，客户端和服务端是否正常，并且能够处理异常情况</p><p>对于多线程、异步的服务端，采用同时下载两个或者多个文件的形式，检测下载过程众怒给，客户端和服务端是否正常，并且能够处理多种的异常情况</p><ol start=2><li>测试流程</li></ol><p>单线程：</p><p><img src=https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192629.png alt=client端使用说明></p><p><img src=https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192635.png alt=server端使用说明></p><p><img src=https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192646.png alt=client端接收logo.png文件></p><p><img src=https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192653.png alt=server端显示的日志信息></p><p>多线程：</p><p>客户端和服务端使用说明，同单线程的情况</p><p><img src=https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192700.png alt=client端接收file.zip大文件的过程></p><p><img src=https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192705.png alt=另一client端同时接收logo.png文件成功></p><p><img src=https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192709.png alt=server端显示的日志信息></p><p><img src=https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192714.png alt=" client端接收大文件file.zip成功"></p><p><img src=https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192718.png alt=全部client端接收文件成功后server端的日志信息></p><p>Asyncio异步：</p><p>客户端和服务端使用说明，同单线程的情况</p><p><img src=https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192730.png alt=client端接收file.zip文件过程></p><p><img src=https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192734.png alt=另一client端同时接收logo.png></p><p><img src=https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231220192739.png alt=server端显示的日志信息></p><h3 id=实验分析总结及心得>实验分析总结及心得</h3><p><strong>实验过程中参考的文献：</strong></p><p><a href=https://blog.csdn.net/FY_13781298928/article/details/133747112>Python使用Asyncio开发TCP服务器简单案例-CSDN博客</a></p><p><a href=https://juejin.cn/post/7120545649891737614>asyncio实现异步socket server - 掘金 (juejin.cn)</a></p><p><a href=https://www.birdpython.com/posts/1/88/>异步网络模型 - 老鸟python (birdpython.com)</a></p><p><a href=https://www.cnblogs.com/-wenli/p/11192394.html>python异步编程&ndash;回调模型(selectors模块) - -零 - 博客园 (cnblogs.com)</a></p><p><strong>总结一下：</strong>
多线程的原理就是，在执行一个任务，当这个任务处于阻塞或者IO操作时，可以开启另外一个新的线程去执行另外有一个工作，提高执行效率。但是缺点就是整个线程的阻塞判断和线程切换都是程序自动判断，人为不能干预。</p><p>由此引出了协程的概念，协程就是在切换任务的时候，是我们在编程可以指定的。单线程异步就用了这样的思想，asyncio是单进程并发库，不是多线程，也不是多进程，单纯是在一个进程里面异步（切来切去运行），切换的地方用await标记，能够切换的函数用async标记，从而避免程序自动判断切换。</p><p>而对于select模型和poll模型的异步思想，是单线程轮询策略，核心就是在循环中，不断的select从任务列表取出可以读和写的fd对象，然后对其进行不同的处理，就是把所有的接收Socket数据和发送Socket数据都存在各自的列表队列里，之后循环每个队列中的每个对象，处理对应的事件操作。poll提供了register、modify、unregister、poll等方法，运行逻辑就是，如果是需要监测的事件，就将其register到poll对象中，然后通过poll方法不断取出就绪的fd，根据fd的事件类型(POLLIN, POLLOUT)对其进行不同的处理。</p><p>总的来说，单线程、多线程、asyncio实现的异步都很简单，很快就能写出来，但是select和poll模型就相对来说比较困难，本身的实现格式比较复杂，同时我设计的协议也并不简单，所以利用select模型实现异步还是比较困难的，最后虽然通过简化协议流程实现了这个服务端代码但是实现的效果还是不理想，异步处理的单个事件还是太大了，不知道怎么细化，还是有很大的改进空间的。</p></article><div class=paginator><a class=link href=https://blog.pi3.fun/post/2023/12/%E5%BE%AE%E4%BF%A1%E5%AE%9A%E6%97%B6%E5%8F%91%E9%80%81%E5%80%92%E6%95%B0%E6%97%A5/>← prev</a>
<a class=link href=https://blog.pi3.fun/post/2023/12/windows10%E4%B8%8B%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8wsa/>next →</a></div><div class=comment><div id=tcomment></div><script src=https://registry.npmmirror.com/twikoo/1.6.39/files/dist/twikoo.min.js></script><script async>twikoo.init({envId:"https://twikoo.pi3.fun/.netlify/functions/twikoo",el:"#tcomment",lang:"zh-CN"})</script></div></main><footer id=footer><div><span style=display:flex;align-items:center><span style=margin-right:.5rem>© 2021 - 2024</span><img src=https://image.pi3.fun/static/rainbow.gif loading=lazy width=20 alt=rainbow><span style=margin-left:.5rem>By Liu Chao</span></span></div><div class=footnote><span><a class=link href=/index.xml><span class="iconfont icon-RSS"></span></a> | <a class=link href=https://github.com/Pi3-l22 target=_ blank><span class="iconfont icon-GitHub"></span></a> | <a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener><span class="iconfont icon-creative-commons-fill"></span></a><br><a href=https://www.foreverblog.cn/ target=_blank><img src=https://img.foreverblog.cn/logo_en_default.png style=width:auto;height:16px> </a>| <a class=link href=https://blogscn.fun/ target=_blank><img src=https://photo.xiangming.site/img/blogscn.png style=width:auto;height:15px></a></span></div><div class=blog-icon></div></footer></div><script>document.addEventListener("DOMContentLoaded",function(){const n=localStorage.getItem("theme")||"light",e=document.querySelector('link[data-theme-style="light"]'),t=document.querySelector('link[data-theme-style="dark"]'),i=window.matchMedia("(prefers-color-scheme: dark)");i.addListener(function(n){if(!localStorage.getItem("theme")){const s=n.matches?"dark":"light";document.documentElement.setAttribute("data-theme",s),localStorage.setItem("theme",s),s==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");const o=document.querySelector("iframe.giscus-frame");if(o){const e=s==="light"?"light_tritanopia":"dark_tritanopia";o.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}}}),n==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");function o(){const e=document.querySelector("iframe.giscus-frame");if(e){const t=n==="light"?"light_tritanopia":"dark_tritanopia";e.contentWindow.postMessage({giscus:{setConfig:{theme:t}}},"https://giscus.app")}else setTimeout(o,1e3)}o();const s=document.querySelector(".theme-toggle");s&&(s.textContent=n==="light"?"黑暗":"明亮",s.addEventListener("click",function(){const o=document.documentElement.getAttribute("data-theme"),n=o==="light"?"dark":"light";document.documentElement.setAttribute("data-theme",n),localStorage.setItem("theme",n),n==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");const s=document.querySelector("iframe.giscus-frame");if(s){const e=n==="light"?"light_tritanopia":"dark_tritanopia";s.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}this.textContent=n==="light"?"黑暗":"明亮"}))})</script></body></html>