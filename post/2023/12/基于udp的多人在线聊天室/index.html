<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  
  <meta name="author" content="LiuChao">

  
  
  <meta name="description" content="一个基于UDP的简单多人在线聊天室项目">
  

  
  <link rel="icon" href="https://pi3-l22.github.io/favicon.ico">

  
  
  <meta name="keywords" content=" study  latex  life  academic ">
  

  
  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css"
  integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
  integrity="sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js"
  integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '\\[', right: '\\]', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false }
      ],
      ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'option'],
      throwOnError: false
    });
  });
</script>


  

  
  <meta property="og:url" content="https://pi3-l22.github.io/post/2023/12/%E5%9F%BA%E4%BA%8Eudp%E7%9A%84%E5%A4%9A%E4%BA%BA%E5%9C%A8%E7%BA%BF%E8%81%8A%E5%A4%A9%E5%AE%A4/">
  <meta property="og:site_name" content="Pi3&#39;Notes">
  <meta property="og:title" content="基于UDP的多人在线聊天室">
  <meta property="og:description" content="一个基于UDP的简单多人在线聊天室项目">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2023-12-07T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-12-07T00:00:00+00:00">
    <meta property="article:tag" content="UDP">
    <meta property="article:tag" content="Socket">
    <meta property="article:tag" content="Python">
    <meta property="article:tag" content="Flet">


  
  <link rel="canonical" href="https://pi3-l22.github.io/post/2023/12/%E5%9F%BA%E4%BA%8Eudp%E7%9A%84%E5%A4%9A%E4%BA%BA%E5%9C%A8%E7%BA%BF%E8%81%8A%E5%A4%A9%E5%AE%A4/">

  
  
  
  <meta itemprop="name" content="基于UDP的多人在线聊天室">
  <meta itemprop="description" content="一个基于UDP的简单多人在线聊天室项目">
  <meta itemprop="datePublished" content="2023-12-07T00:00:00+00:00">
  <meta itemprop="dateModified" content="2023-12-07T00:00:00+00:00">
  <meta itemprop="wordCount" content="3553">
  <meta itemprop="keywords" content="UDP,Socket,Python,Flet">

  
  <link media="screen" rel="stylesheet" href='https://pi3-l22.github.io/css/common.css'>
  <link media="screen" rel="stylesheet" href='https://pi3-l22.github.io/css/content.css'>

  
  
  <title>基于UDP的多人在线聊天室 - Pi3&#39;Notes</title>
  

  
  

  
<link rel="stylesheet" href='https://pi3-l22.github.io/css/single.css'>

</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://pi3-l22.github.io/">Pi3&#39;Notes</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/home/">主页</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/">文章</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/">归档</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/about/">关于</a>
    </span>
    
  </nav>
</header>

    
<main id="main" class="post">
  
  
  <h1>基于UDP的多人在线聊天室</h1>
  
  <div>
    <b>Keywords: </b>
    
    <a class="link" href='https://pi3-l22.github.io/tags/udp'>#UDP</a>
    
    <a class="link" href='https://pi3-l22.github.io/tags/socket'>#Socket</a>
    
    <a class="link" href='https://pi3-l22.github.io/tags/python'>#Python</a>
    
    <a class="link" href='https://pi3-l22.github.io/tags/flet'>#flet</a>
    
  </div>
  
  
  
  <details>
    <summary>
      <b>Table of Contents</b>
    </summary>
    <div class="toc"><nav id="TableOfContents">
  <ul>
    <li><a href="#实验内容">实验内容</a></li>
    <li><a href="#程序设计思路">程序设计思路</a>
      <ul>
        <li><a href="#网络结构拓扑图">网络结构拓扑图</a></li>
        <li><a href="#使用的python库">使用的Python库</a></li>
        <li><a href="#具体设计流程">具体设计流程</a></li>
      </ul>
    </li>
    <li><a href="#成果展示">成果展示</a></li>
    <li><a href="#总结与心得">总结与心得</a></li>
  </ul>
</nav></div>
  </details>
  
  
  <article class="content">
    
    <h2 id="实验内容">实验内容</h2>
<p>编写基于UDP的聊天室程序，实现多人聊天功能。自己设计应用协议，要求实现以下功能：</p>
<ol>
<li>用户注册：服务器端记录已注册的用户名和密码。</li>
<li>用户登录：服务器接收登录信息后，检测是否在注册名单内。是，则聊天室的“在线清单”内加入此用户（包含用户名和主机连接地址）；否，则提示用户需要先注册。</li>
<li>公聊：客户端输入公聊命令+发送信息；服务器端接收信息，并按照指令，将信息发送往所有“在线清单”用户。</li>
<li>私聊：客户端输入私聊命令+发送方用户名+发送信息；服务器端接收信息，并按照指令，将信息发送往客户端指定的发送方用户。</li>
<li>退出聊天室。</li>
</ol>
<h2 id="程序设计思路">程序设计思路</h2>
<h3 id="网络结构拓扑图">网络结构拓扑图</h3>
<p>一对多的网络结构，即一台服务器对应多台客户端的星型拓扑结构
<img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231207231031.png" alt="网络结构拓扑图"></p>
<h3 id="使用的python库">使用的Python库</h3>
<ul>
<li>socket套接字库</li>
<li>threading多线程库</li>
<li><a href="https://flet.dev/docs/">flet第三方库</a>，用于实现图形化界面</li>
</ul>
<h3 id="具体设计流程">具体设计流程</h3>
<p>首先我们应该先知道，UDP和TCP的区别是什么。UDP是无连接的，发送出去的数据不论对方是否收到，都不管，而TCP是面向连接的，每次通信都需要确保对方已经接收到才能进行下一步，也就多了很多协议设计的难度以及需要很多的异常判断。
在此之前，我已经写过一个关于socket的项目，是基于TCP的：<a href="Python%E8%BF%9C%E7%A8%8B%E6%8E%A7%E5%88%B6%E7%A8%8B%E5%BA%8F.md">Python远程控制程序</a>，相比较之前这个项目，此次的程序设计就显得简单多了，毕竟是基于UDP的。</p>
<h4 id="最简单的udp连接">最简单的UDP连接</h4>
<p>首先先写一个最简单的UDP连接程序，作为整个程序的基础
<strong>client端</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>IP <span style="color:#666">=</span> <span style="color:#b44">&#39;localhost&#39;</span>
</span></span><span style="display:flex;"><span>POST <span style="color:#666">=</span> <span style="color:#666">7777</span>
</span></span><span style="display:flex;"><span>SERVER_ADDR <span style="color:#666">=</span> (IP, POST)
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 创建一个UDP的socket</span>
</span></span><span style="display:flex;"><span>client <span style="color:#666">=</span> socket<span style="color:#666">.</span>socket(socket<span style="color:#666">.</span>AF_INET, socket<span style="color:#666">.</span>SOCK_DGRAM)
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 发送消息</span>
</span></span><span style="display:flex;"><span>message <span style="color:#666">=</span> <span style="color:#a2f">input</span>()
</span></span><span style="display:flex;"><span>client<span style="color:#666">.</span>sendto(message<span style="color:#666">.</span>encode(), SERVER_ADDR)
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 接收消息</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># while True:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># data, server = client.recvfrom(1024)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># print(data.decode())</span>
</span></span></code></pre></div><p><strong>server端</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>IP <span style="color:#666">=</span> <span style="color:#b44">&#39;localhost&#39;</span>
</span></span><span style="display:flex;"><span>POST <span style="color:#666">=</span> <span style="color:#666">7777</span>
</span></span><span style="display:flex;"><span>SERVER_ADDR <span style="color:#666">=</span> (IP, POST)
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 创建一个UDP的socket</span>
</span></span><span style="display:flex;"><span>server <span style="color:#666">=</span> socket<span style="color:#666">.</span>socket(socket<span style="color:#666">.</span>AF_INET, socket<span style="color:#666">.</span>SOCK_DGRAM)
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 监听本机端口</span>
</span></span><span style="display:flex;"><span>server<span style="color:#666">.</span>bind(SERVER_ADDR)
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 接收消息</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">while</span> <span style="color:#a2f;font-weight:bold">True</span>:
</span></span><span style="display:flex;"><span>    data, address <span style="color:#666">=</span> server<span style="color:#666">.</span>recvfrom(BUFFER)
</span></span><span style="display:flex;"><span>    message <span style="color:#666">=</span> data<span style="color:#666">.</span>decode()
</span></span><span style="display:flex;"><span>    <span style="color:#a2f">print</span>(message)
</span></span></code></pre></div><p>这样就完成一个最简单的UDP连接程序，实现了client发送消息，server接收消息</p>
<h4 id="相应功能的实现">相应功能的实现</h4>
<p>接下里就是在上面程序的基础上加上对应的功能，本次程序需要实现：</p>
<ol>
<li>登录</li>
<li>注册</li>
<li>公聊</li>
<li>私聊</li>
<li>退出
在client端中，我们需要将用户输入的消息，根据相应的操作进行封装成固定的格式，以便server端根据收到的数据，了解需要进行什么操作，经过操作后返回对应的数据</li>
</ol>
<ul>
<li>注册操作的封装格式：REGISTER {username} {password}</li>
<li>登录操作的封装格式：LOGIN {username} {password}</li>
<li>公聊操作的封装格式：PUBLIC {message}</li>
<li>私聊操作的封装格式：PRIVATE {to_username} {message}</li>
<li>退出操作的封装格式：EXIT {username}</li>
</ul>
<p><strong>client端功能实现</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 注册</span>
</span></span><span style="display:flex;"><span>username <span style="color:#666">=</span> <span style="color:#a2f">input</span>(<span style="color:#b44">&#34;[*] 输入用户名: &#34;</span>)
</span></span><span style="display:flex;"><span>password <span style="color:#666">=</span> <span style="color:#a2f">input</span>(<span style="color:#b44">&#34;[*] 输入密码: &#34;</span>)
</span></span><span style="display:flex;"><span>registration_message <span style="color:#666">=</span> <span style="color:#b44">f</span><span style="color:#b44">&#34;REGISTER </span><span style="color:#b68;font-weight:bold">{</span>username<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> </span><span style="color:#b68;font-weight:bold">{</span>password<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>
</span></span><span style="display:flex;"><span>client<span style="color:#666">.</span>sendto(registration_message<span style="color:#666">.</span>encode(), SERVER_ADDR)
</span></span><span style="display:flex;"><span>response, add <span style="color:#666">=</span> client<span style="color:#666">.</span>recvfrom(BUFFER)
</span></span><span style="display:flex;"><span><span style="color:#a2f">print</span>(response<span style="color:#666">.</span>decode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 登录</span>
</span></span><span style="display:flex;"><span>username <span style="color:#666">=</span> <span style="color:#a2f">input</span>(<span style="color:#b44">&#34;[*] 输入用户名: &#34;</span>)
</span></span><span style="display:flex;"><span>password <span style="color:#666">=</span> <span style="color:#a2f">input</span>(<span style="color:#b44">&#34;[*] 输入密码: &#34;</span>)
</span></span><span style="display:flex;"><span>login_message <span style="color:#666">=</span> <span style="color:#b44">f</span><span style="color:#b44">&#34;LOGIN </span><span style="color:#b68;font-weight:bold">{</span>username<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> </span><span style="color:#b68;font-weight:bold">{</span>password<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>
</span></span><span style="display:flex;"><span>client<span style="color:#666">.</span>sendto(login_message<span style="color:#666">.</span>encode(), SERVER_ADDR)
</span></span><span style="display:flex;"><span>response, add <span style="color:#666">=</span> client<span style="color:#666">.</span>recvfrom(<span style="color:#666">1024</span>)
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span> response<span style="color:#666">.</span>decode() <span style="color:#666">==</span> <span style="color:#b44">&#34;Login successful&#34;</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># print(f&#34;[+] 欢迎 {username} 加入聊天室&#34;)</span>
</span></span><span style="display:flex;"><span>	rev, add <span style="color:#666">=</span> client<span style="color:#666">.</span>recvfrom(<span style="color:#666">1024</span>)
</span></span><span style="display:flex;"><span>	online_users <span style="color:#666">=</span> <span style="color:#a2f">list</span>(rev<span style="color:#666">.</span>decode()<span style="color:#666">.</span>replace(<span style="color:#b44">&#34;[&#34;</span>, <span style="color:#b44">&#34;&#34;</span>)<span style="color:#666">.</span>replace(<span style="color:#b44">&#34;]&#34;</span>, <span style="color:#b44">&#34;&#34;</span>)<span style="color:#666">.</span>replace(<span style="color:#b44">&#34;&#39;&#34;</span>, <span style="color:#b44">&#34;&#34;</span>)<span style="color:#666">.</span>split(<span style="color:#b44">&#34;, &#34;</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#a2f">print</span>(<span style="color:#b44">&#34;[*] 当前在线用户: &#34;</span>, end<span style="color:#666">=</span><span style="color:#b44">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">for</span> user <span style="color:#a2f;font-weight:bold">in</span> online_users:
</span></span><span style="display:flex;"><span>		<span style="color:#a2f">print</span>(user, end<span style="color:#666">=</span><span style="color:#b44">&#39; &#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#a2f">print</span>(response<span style="color:#666">.</span>decode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 公聊、私聊、退出</span>
</span></span><span style="display:flex;"><span>message <span style="color:#666">=</span> <span style="color:#a2f">input</span>()
</span></span><span style="display:flex;"><span>client<span style="color:#666">.</span>sendto(message<span style="color:#666">.</span>encode(), SERVER_ADDR)
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span> message <span style="color:#666">==</span> <span style="color:#b44">&#34;exit&#34;</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">elif</span> message<span style="color:#666">.</span>startswith(<span style="color:#b44">&#34;@&#34;</span>):
</span></span><span style="display:flex;"><span>	to_address <span style="color:#666">=</span> message<span style="color:#666">.</span>split(<span style="color:#b44">&#34; &#34;</span>)[<span style="color:#666">0</span>]<span style="color:#666">.</span>replace(<span style="color:#b44">&#34;@&#34;</span>, <span style="color:#b44">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>	private_message <span style="color:#666">=</span> message<span style="color:#666">.</span>split(<span style="color:#b44">&#34; &#34;</span>)[<span style="color:#666">1</span>]
</span></span><span style="display:flex;"><span>	private_message <span style="color:#666">=</span> <span style="color:#b44">f</span><span style="color:#b44">&#34;PRIVATE </span><span style="color:#b68;font-weight:bold">{</span>to_address<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> </span><span style="color:#b68;font-weight:bold">{</span>private_message<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>
</span></span><span style="display:flex;"><span>	client<span style="color:#666">.</span>sendto(private_message<span style="color:#666">.</span>encode(), SERVER_ADDR)
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>	public_message <span style="color:#666">=</span> <span style="color:#b44">f</span><span style="color:#b44">&#34;PUBLIC </span><span style="color:#b68;font-weight:bold">{</span>message<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#34;</span>
</span></span><span style="display:flex;"><span>	client<span style="color:#666">.</span>sendto(public_message<span style="color:#666">.</span>encode(), SERVER_ADDR)
</span></span></code></pre></div><p><strong>server端功能实现</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 记录注册过的用户信息字典</span>
</span></span><span style="display:flex;"><span>user_dict <span style="color:#666">=</span> {}  <span style="color:#080;font-style:italic"># {username: password}</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 记录在线用户信息字典</span>
</span></span><span style="display:flex;"><span>online_user <span style="color:#666">=</span> {}  <span style="color:#080;font-style:italic"># {username: (ip, port)}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 初始化用户信息</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">init_users</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">with</span> <span style="color:#a2f">open</span>(<span style="color:#b44">&#39;users.txt&#39;</span>, <span style="color:#b44">&#39;r&#39;</span>) <span style="color:#a2f;font-weight:bold">as</span> f:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">for</span> line <span style="color:#a2f;font-weight:bold">in</span> f<span style="color:#666">.</span>readlines():
</span></span><span style="display:flex;"><span>            username <span style="color:#666">=</span> line<span style="color:#666">.</span>split(<span style="color:#b44">&#39;,&#39;</span>)[<span style="color:#666">0</span>]
</span></span><span style="display:flex;"><span>            password <span style="color:#666">=</span> line<span style="color:#666">.</span>split(<span style="color:#b44">&#39;,&#39;</span>)[<span style="color:#666">1</span>]<span style="color:#666">.</span>replace(<span style="color:#b44">&#39;</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">&#39;</span>, <span style="color:#b44">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>            user_dict[username] <span style="color:#666">=</span> password
</span></span><span style="display:flex;"><span>    <span style="color:#a2f">print</span>(<span style="color:#b44">f</span><span style="color:#b44">&#39;[+] 注册用户信息加载成功&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 保存注册用户信息</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">save_users</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">with</span> <span style="color:#a2f">open</span>(<span style="color:#b44">&#39;users.txt&#39;</span>, <span style="color:#b44">&#39;w&#39;</span>) <span style="color:#a2f;font-weight:bold">as</span> f:
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">for</span> username <span style="color:#a2f;font-weight:bold">in</span> user_dict<span style="color:#666">.</span>keys():
</span></span><span style="display:flex;"><span>            password <span style="color:#666">=</span> user_dict[username]
</span></span><span style="display:flex;"><span>            f<span style="color:#666">.</span>write(<span style="color:#b44">f</span><span style="color:#b44">&#39;</span><span style="color:#b68;font-weight:bold">{</span>username<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">,</span><span style="color:#b68;font-weight:bold">{</span>password<span style="color:#b68;font-weight:bold">}</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 列出在线用户</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">list_online_users</span>(address):
</span></span><span style="display:flex;"><span>    users <span style="color:#666">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">for</span> username <span style="color:#a2f;font-weight:bold">in</span> online_user<span style="color:#666">.</span>keys():
</span></span><span style="display:flex;"><span>        users<span style="color:#666">.</span>append(username)
</span></span><span style="display:flex;"><span>    server<span style="color:#666">.</span>sendto(<span style="color:#a2f">str</span>(users)<span style="color:#666">.</span>encode(), address)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 注册</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">register</span>(username, password, address):
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">if</span> username <span style="color:#a2f;font-weight:bold">in</span> user_dict<span style="color:#666">.</span>keys():
</span></span><span style="display:flex;"><span>        server<span style="color:#666">.</span>sendto(<span style="color:#b44">&#34;[-] 用户名已存在&#34;</span><span style="color:#666">.</span>encode(), address)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        user_dict[username] <span style="color:#666">=</span> password
</span></span><span style="display:flex;"><span>        save_users()
</span></span><span style="display:flex;"><span>        server<span style="color:#666">.</span>sendto(<span style="color:#b44">&#34;[+] 注册成功&#34;</span><span style="color:#666">.</span>encode(), address)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 登录</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">login</span>(username, password, address):
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">if</span> username <span style="color:#a2f;font-weight:bold">not</span> <span style="color:#a2f;font-weight:bold">in</span> user_dict<span style="color:#666">.</span>keys():
</span></span><span style="display:flex;"><span>        server<span style="color:#666">.</span>sendto(<span style="color:#b44">&#34;[-] 用户名不存在&#34;</span><span style="color:#666">.</span>encode(), address)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">elif</span> user_dict[username] <span style="color:#666">!=</span> password:
</span></span><span style="display:flex;"><span>        server<span style="color:#666">.</span>sendto(<span style="color:#b44">&#34;[-] 密码错误&#34;</span><span style="color:#666">.</span>encode(), address)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        server<span style="color:#666">.</span>sendto(<span style="color:#b44">&#34;Login successful&#34;</span><span style="color:#666">.</span>encode(), address)
</span></span><span style="display:flex;"><span>        online_user[username] <span style="color:#666">=</span> address
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 发送在线用户列表</span>
</span></span><span style="display:flex;"><span>        list_online_users(address)
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-style:italic"># 发送上线通知</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">for</span> online <span style="color:#a2f;font-weight:bold">in</span> online_user<span style="color:#666">.</span>keys():
</span></span><span style="display:flex;"><span>            server<span style="color:#666">.</span>sendto(<span style="color:#b44">f</span><span style="color:#b44">&#39;</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">[+] 欢迎 </span><span style="color:#b68;font-weight:bold">{</span>username<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> 加入聊天室&#39;</span><span style="color:#666">.</span>encode(), online_user[online])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 公聊</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">public_chat</span>(message, address):
</span></span><span style="display:flex;"><span>    from_username <span style="color:#666">=</span> <span style="color:#b44">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 通过address获取username</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">for</span> username <span style="color:#a2f;font-weight:bold">in</span> online_user<span style="color:#666">.</span>keys():
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> online_user[username] <span style="color:#666">==</span> address:
</span></span><span style="display:flex;"><span>            from_username <span style="color:#666">=</span> username
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">for</span> username <span style="color:#a2f;font-weight:bold">in</span> online_user<span style="color:#666">.</span>keys():
</span></span><span style="display:flex;"><span>        server<span style="color:#666">.</span>sendto(<span style="color:#b44">f</span><span style="color:#b44">&#39;[+] </span><span style="color:#b68;font-weight:bold">{</span>from_username<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">: </span><span style="color:#b68;font-weight:bold">{</span>message<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#39;</span><span style="color:#666">.</span>encode(), online_user[username])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 私聊</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">private_chat</span>(message, to_username, address):
</span></span><span style="display:flex;"><span>    from_username <span style="color:#666">=</span> <span style="color:#b44">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 通过address获取username</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">for</span> username <span style="color:#a2f;font-weight:bold">in</span> online_user<span style="color:#666">.</span>keys():
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> online_user[username] <span style="color:#666">==</span> address:
</span></span><span style="display:flex;"><span>            from_username <span style="color:#666">=</span> username
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">if</span> to_username <span style="color:#a2f;font-weight:bold">not</span> <span style="color:#a2f;font-weight:bold">in</span> online_user<span style="color:#666">.</span>keys():
</span></span><span style="display:flex;"><span>        server<span style="color:#666">.</span>sendto(<span style="color:#b44">&#34;[-] 用户不在线&#34;</span><span style="color:#666">.</span>encode(), address)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        to_address <span style="color:#666">=</span> online_user[to_username]
</span></span><span style="display:flex;"><span>        server<span style="color:#666">.</span>sendto(<span style="color:#b44">f</span><span style="color:#b44">&#39;[@] </span><span style="color:#b68;font-weight:bold">{</span>from_username<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">: </span><span style="color:#b68;font-weight:bold">{</span>message<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#39;</span><span style="color:#666">.</span>encode(), to_address)
</span></span><span style="display:flex;"><span>        server<span style="color:#666">.</span>sendto(<span style="color:#b44">f</span><span style="color:#b44">&#39;[@] </span><span style="color:#b68;font-weight:bold">{</span>from_username<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">: </span><span style="color:#b68;font-weight:bold">{</span>message<span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">&#39;</span><span style="color:#666">.</span>encode(), address)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"># 根据选项分别进入对应的函数</span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">menu</span>(data, address):
</span></span><span style="display:flex;"><span>    command <span style="color:#666">=</span> data<span style="color:#666">.</span>split()[<span style="color:#666">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">if</span> command <span style="color:#666">==</span> <span style="color:#b44">&#34;REGISTER&#34;</span>:
</span></span><span style="display:flex;"><span>        username <span style="color:#666">=</span> data<span style="color:#666">.</span>split()[<span style="color:#666">1</span>]
</span></span><span style="display:flex;"><span>        password <span style="color:#666">=</span> data<span style="color:#666">.</span>split()[<span style="color:#666">2</span>]
</span></span><span style="display:flex;"><span>        register(username, password, address)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">elif</span> command <span style="color:#666">==</span> <span style="color:#b44">&#34;LOGIN&#34;</span>:
</span></span><span style="display:flex;"><span>        username <span style="color:#666">=</span> data<span style="color:#666">.</span>split()[<span style="color:#666">1</span>]
</span></span><span style="display:flex;"><span>        password <span style="color:#666">=</span> data<span style="color:#666">.</span>split()[<span style="color:#666">2</span>]
</span></span><span style="display:flex;"><span>        login(username, password, address)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">elif</span> command <span style="color:#666">==</span> <span style="color:#b44">&#34;PUBLIC&#34;</span>:
</span></span><span style="display:flex;"><span>        message <span style="color:#666">=</span> data<span style="color:#666">.</span>split()[<span style="color:#666">1</span>]
</span></span><span style="display:flex;"><span>        public_chat(message, address)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">elif</span> command <span style="color:#666">==</span> <span style="color:#b44">&#34;PRIVATE&#34;</span>:
</span></span><span style="display:flex;"><span>        to_username <span style="color:#666">=</span> data<span style="color:#666">.</span>split()[<span style="color:#666">1</span>]
</span></span><span style="display:flex;"><span>        message <span style="color:#666">=</span> data<span style="color:#666">.</span>split()[<span style="color:#666">2</span>]
</span></span><span style="display:flex;"><span>        private_chat(message, to_username, address)
</span></span></code></pre></div><p>写完这些，其实整个实验就算是完成了，但是在测试的过程中还是发现了一些问题：用户输入信息的交互不好，因为是在命令行中进行操作，所以有些时候会和对方输出的信息重叠，受到干扰，体验不好，所以决定在接下来要写个图形化界面</p>
<h4 id="图形化界面编写">图形化界面编写</h4>
<p>对于python图形化界面的编写，其实有很多的方式，如python的标准库Tkinter、QT系列的pyqt5和pyside6、还有Flutter系的flet、…………
在此之前，我也利用flet编写过python的图形化界面项目：<a href="%E5%9F%BA%E4%BA%8EPython%E7%9A%84%E6%9C%AC%E5%9C%B0%E9%87%8F%E5%AD%90%E6%96%87%E4%BB%B6%E5%8A%A0%E8%A7%A3%E5%AF%86.md">基于Python的本地量子文件加密</a>，所以这次我还是使用flet进行编写
不管是之前的项目，还是这次的程序，编写图形化界面，我全部都是参考官方的文档，写的很详细，给予了我很大的帮助，里面还有很多的例子，帮助我理解，所以这次的编写也算是有点入门了</p>
<hr>
<p><strong>登录页面代码框架：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">login_page</span>(page:ft<span style="color:#666">.</span>page):
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 初始化设置</span>
</span></span><span style="display:flex;"><span>	page<span style="color:#666">.</span>title <span style="color:#666">=</span> <span style="color:#b44">&#34;多人在线聊天室&#34;</span>  
</span></span><span style="display:flex;"><span>	page<span style="color:#666">.</span>window_bgcolor <span style="color:#666">=</span> ft<span style="color:#666">.</span>colors<span style="color:#666">.</span>TRANSPARENT  
</span></span><span style="display:flex;"><span>	page<span style="color:#666">.</span>bgcolor <span style="color:#666">=</span> <span style="color:#b44">&#34;#E1F7FB&#34;</span>
</span></span><span style="display:flex;"><span>	page<span style="color:#666">.</span>window_width <span style="color:#666">=</span> <span style="color:#666">500</span>  
</span></span><span style="display:flex;"><span>	page<span style="color:#666">.</span>window_height <span style="color:#666">=</span> <span style="color:#666">360</span>  
</span></span><span style="display:flex;"><span>	page<span style="color:#666">.</span>window_min_width <span style="color:#666">=</span> <span style="color:#666">500</span>  
</span></span><span style="display:flex;"><span>	page<span style="color:#666">.</span>window_min_height <span style="color:#666">=</span> <span style="color:#666">360</span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># ……………………</span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 登录按钮点击事件  </span>
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">btn_login_click</span>(e):  
</span></span><span style="display:flex;"><span>	    <span style="color:#a2f;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>	    
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 注册按钮点击事件  </span>
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">btn_register_click</span>(e):  
</span></span><span style="display:flex;"><span>	    <span style="color:#a2f;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>	    
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 错误弹窗</span>
</span></span><span style="display:flex;"><span>	login_error_dlg <span style="color:#666">=</span> ft<span style="color:#666">.</span>AlertDialog(  
</span></span><span style="display:flex;"><span>    title<span style="color:#666">=</span>ft<span style="color:#666">.</span>Text(  
</span></span><span style="display:flex;"><span>        <span style="color:#b44">&#34;用户名或密码错误！</span><span style="color:#b62;font-weight:bold">\n\n</span><span style="color:#b44">请检查后重新输入！&#34;</span>),  
</span></span><span style="display:flex;"><span>	)  
</span></span><span style="display:flex;"><span>	login_success_dlg <span style="color:#666">=</span> ft<span style="color:#666">.</span>AlertDialog(  
</span></span><span style="display:flex;"><span>	    title<span style="color:#666">=</span>ft<span style="color:#666">.</span>Text(  
</span></span><span style="display:flex;"><span>	        <span style="color:#b44">&#34;登录成功！</span><span style="color:#b62;font-weight:bold">\n\n</span><span style="color:#b44">欢迎进入聊天室！&#34;</span>),  
</span></span><span style="display:flex;"><span>	)  
</span></span><span style="display:flex;"><span>	register_error_dlg <span style="color:#666">=</span> ft<span style="color:#666">.</span>AlertDialog(  
</span></span><span style="display:flex;"><span>	    title<span style="color:#666">=</span>ft<span style="color:#666">.</span>Text(  
</span></span><span style="display:flex;"><span>	        <span style="color:#b44">&#34;注册失败！</span><span style="color:#b62;font-weight:bold">\n\n</span><span style="color:#b44">用户名已存在！&#34;</span>),  
</span></span><span style="display:flex;"><span>	)  
</span></span><span style="display:flex;"><span>	register_success_dlg <span style="color:#666">=</span> ft<span style="color:#666">.</span>AlertDialog(  
</span></span><span style="display:flex;"><span>	    title<span style="color:#666">=</span>ft<span style="color:#666">.</span>Text(  
</span></span><span style="display:flex;"><span>	        <span style="color:#b44">&#34;注册成功！</span><span style="color:#b62;font-weight:bold">\n\n</span><span style="color:#b44">请登录！&#34;</span>),  
</span></span><span style="display:flex;"><span>	)  
</span></span><span style="display:flex;"><span>	login_empty_dlg <span style="color:#666">=</span> ft<span style="color:#666">.</span>AlertDialog(  
</span></span><span style="display:flex;"><span>	    title<span style="color:#666">=</span>ft<span style="color:#666">.</span>Text(  
</span></span><span style="display:flex;"><span>	        <span style="color:#b44">&#34;用户名或密码为空！</span><span style="color:#b62;font-weight:bold">\n\n</span><span style="color:#b44">请检查后重新输入！&#34;</span>)  
</span></span><span style="display:flex;"><span>	)  
</span></span><span style="display:flex;"><span>	server_error_dlg <span style="color:#666">=</span> ft<span style="color:#666">.</span>AlertDialog(  
</span></span><span style="display:flex;"><span>	    title<span style="color:#666">=</span>ft<span style="color:#666">.</span>Text(  
</span></span><span style="display:flex;"><span>	        <span style="color:#b44">&#34;服务器错误！</span><span style="color:#b62;font-weight:bold">\n\n</span><span style="color:#b44">请稍后尝试！&#34;</span>)  
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 标题</span>
</span></span><span style="display:flex;"><span>	title <span style="color:#666">=</span> ft<span style="color:#666">.</span>Stack(
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># ………………</span>
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 密码输入框</span>
</span></span><span style="display:flex;"><span>	password_box <span style="color:#666">=</span> ft<span style="color:#666">.</span>TextField(  
</span></span><span style="display:flex;"><span>    label<span style="color:#666">=</span><span style="color:#b44">&#34;密码&#34;</span>,  
</span></span><span style="display:flex;"><span>    hint_text<span style="color:#666">=</span><span style="color:#b44">&#34;请输入你的密码&#34;</span>,  
</span></span><span style="display:flex;"><span>    max_lines<span style="color:#666">=</span><span style="color:#666">1</span>,  
</span></span><span style="display:flex;"><span>    width<span style="color:#666">=</span><span style="color:#666">350</span>,  
</span></span><span style="display:flex;"><span>    height<span style="color:#666">=</span><span style="color:#666">55</span>,  
</span></span><span style="display:flex;"><span>    password<span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">True</span>,  
</span></span><span style="display:flex;"><span>    can_reveal_password<span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">True</span>,  
</span></span><span style="display:flex;"><span>    keyboard_type<span style="color:#666">=</span>ft<span style="color:#666">.</span>KeyboardType<span style="color:#666">.</span>VISIBLE_PASSWORD,  
</span></span><span style="display:flex;"><span>    shift_enter<span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">True</span>,  
</span></span><span style="display:flex;"><span>    on_submit<span style="color:#666">=</span>btn_login_click  
</span></span><span style="display:flex;"><span>	)  
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 用户名输入框</span>
</span></span><span style="display:flex;"><span>	username_box <span style="color:#666">=</span> ft<span style="color:#666">.</span>TextField(  
</span></span><span style="display:flex;"><span>	    label<span style="color:#666">=</span><span style="color:#b44">&#34;用户名&#34;</span>,  
</span></span><span style="display:flex;"><span>	    hint_text<span style="color:#666">=</span><span style="color:#b44">&#34;请输入你的用户名&#34;</span>,  
</span></span><span style="display:flex;"><span>	    max_lines<span style="color:#666">=</span><span style="color:#666">1</span>,  
</span></span><span style="display:flex;"><span>	    width<span style="color:#666">=</span><span style="color:#666">350</span>,  
</span></span><span style="display:flex;"><span>	    height<span style="color:#666">=</span><span style="color:#666">55</span>,  
</span></span><span style="display:flex;"><span>	    autofocus<span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">True</span>,  
</span></span><span style="display:flex;"><span>	    shift_enter<span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">True</span>,  
</span></span><span style="display:flex;"><span>	    on_submit<span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">lambda</span> e: password_box<span style="color:#666">.</span>focus(),  
</span></span><span style="display:flex;"><span>	)  
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 登录按钮 </span>
</span></span><span style="display:flex;"><span>	btn_login <span style="color:#666">=</span> ft<span style="color:#666">.</span>ElevatedButton(  
</span></span><span style="display:flex;"><span>	    text<span style="color:#666">=</span><span style="color:#b44">&#34;登录&#34;</span>,  
</span></span><span style="display:flex;"><span>	    width<span style="color:#666">=</span><span style="color:#666">150</span>,  
</span></span><span style="display:flex;"><span>	    height<span style="color:#666">=</span><span style="color:#666">50</span>,  
</span></span><span style="display:flex;"><span>	    animate_size<span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">True</span>,  
</span></span><span style="display:flex;"><span>	    on_click<span style="color:#666">=</span>btn_login_click,  
</span></span><span style="display:flex;"><span>	    icon<span style="color:#666">=</span>ft<span style="color:#666">.</span>icons<span style="color:#666">.</span>LOGIN,  
</span></span><span style="display:flex;"><span>	)  
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 注册按钮</span>
</span></span><span style="display:flex;"><span>	btn_register <span style="color:#666">=</span> ft<span style="color:#666">.</span>ElevatedButton(  
</span></span><span style="display:flex;"><span>	    text<span style="color:#666">=</span><span style="color:#b44">&#34;注册&#34;</span>,  
</span></span><span style="display:flex;"><span>	    width<span style="color:#666">=</span><span style="color:#666">150</span>,  
</span></span><span style="display:flex;"><span>	    height<span style="color:#666">=</span><span style="color:#666">50</span>,  
</span></span><span style="display:flex;"><span>	    animate_size<span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">True</span>,  
</span></span><span style="display:flex;"><span>	    on_click<span style="color:#666">=</span>btn_register_click,  
</span></span><span style="display:flex;"><span>	    icon<span style="color:#666">=</span>ft<span style="color:#666">.</span>icons<span style="color:#666">.</span>CREATE_OUTLINED,  
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 添加页面布局</span>
</span></span><span style="display:flex;"><span>	page<span style="color:#666">.</span>add(
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># ……………………</span>
</span></span><span style="display:flex;"><span>	)
</span></span></code></pre></div><p><strong>主页面代码框架：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">main_page</span>(page: ft<span style="color:#666">.</span>Page):
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 页面配置初始化</span>
</span></span><span style="display:flex;"><span>	page<span style="color:#666">.</span>clean()  
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># page.vertical_alignment = ft.MainAxisAlignment.START  # 垂直居中  </span>
</span></span><span style="display:flex;"><span>	page<span style="color:#666">.</span>horizontal_alignment <span style="color:#666">=</span> <span style="color:#b44">&#34;stretch&#34;</span>  
</span></span><span style="display:flex;"><span>	page<span style="color:#666">.</span>window_max_height <span style="color:#666">=</span> <span style="color:#666">600</span>  
</span></span><span style="display:flex;"><span>	page<span style="color:#666">.</span>window_max_width <span style="color:#666">=</span> <span style="color:#666">800</span>  
</span></span><span style="display:flex;"><span>	page<span style="color:#666">.</span>window_width <span style="color:#666">=</span> <span style="color:#666">800</span>  
</span></span><span style="display:flex;"><span>	page<span style="color:#666">.</span>window_height <span style="color:#666">=</span> <span style="color:#666">600</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 拦截本机窗口关闭信号 配合关闭窗口默认退出聊天  </span>
</span></span><span style="display:flex;"><span>	page<span style="color:#666">.</span>window_prevent_close <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 接收消息</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">receive_message</span>():
</span></span><span style="display:flex;"><span>		<span style="color:#a2f;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 更新聊天框  </span>
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">update_chat</span>(message):
</span></span><span style="display:flex;"><span>		<span style="color:#a2f;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 聊天内容列表  </span>
</span></span><span style="display:flex;"><span>	chat <span style="color:#666">=</span> ft<span style="color:#666">.</span>ListView(  
</span></span><span style="display:flex;"><span>	    width<span style="color:#666">=</span><span style="color:#666">400</span>,  
</span></span><span style="display:flex;"><span>	    height<span style="color:#666">=</span><span style="color:#666">400</span>,  
</span></span><span style="display:flex;"><span>	    expand<span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">True</span>,  
</span></span><span style="display:flex;"><span>	    spacing<span style="color:#666">=</span><span style="color:#666">10</span>,  
</span></span><span style="display:flex;"><span>	    auto_scroll<span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">True</span>,  
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 发送消息事件  </span>
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">send_message_click</span>(e):
</span></span><span style="display:flex;"><span>		<span style="color:#a2f;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 发送消息按钮  </span>
</span></span><span style="display:flex;"><span>	btn_send <span style="color:#666">=</span> ft<span style="color:#666">.</span>ElevatedButton(  
</span></span><span style="display:flex;"><span>	    text<span style="color:#666">=</span><span style="color:#b44">&#34;发送&#34;</span>,  
</span></span><span style="display:flex;"><span>	    width<span style="color:#666">=</span><span style="color:#666">120</span>,  
</span></span><span style="display:flex;"><span>	    height<span style="color:#666">=</span><span style="color:#666">50</span>,  
</span></span><span style="display:flex;"><span>	    animate_size<span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">True</span>,  
</span></span><span style="display:flex;"><span>	    on_click<span style="color:#666">=</span>send_message_click,  
</span></span><span style="display:flex;"><span>	    icon<span style="color:#666">=</span>ft<span style="color:#666">.</span>icons<span style="color:#666">.</span>SEND,  
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 输入框  </span>
</span></span><span style="display:flex;"><span>	new_message <span style="color:#666">=</span> ft<span style="color:#666">.</span>TextField(  
</span></span><span style="display:flex;"><span>	    label<span style="color:#666">=</span><span style="color:#b44">&#34;Message&#34;</span>,  
</span></span><span style="display:flex;"><span>	    hint_text<span style="color:#666">=</span><span style="color:#b44">&#34;输入聊天消息&#34;</span>,  
</span></span><span style="display:flex;"><span>	    max_lines<span style="color:#666">=</span><span style="color:#666">1</span>,  
</span></span><span style="display:flex;"><span>	    width<span style="color:#666">=</span><span style="color:#666">500</span>,  
</span></span><span style="display:flex;"><span>	    height<span style="color:#666">=</span><span style="color:#666">60</span>,  
</span></span><span style="display:flex;"><span>	    autofocus<span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">True</span>,  
</span></span><span style="display:flex;"><span>	    shift_enter<span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">True</span>,  
</span></span><span style="display:flex;"><span>	    on_submit<span style="color:#666">=</span>send_message_click,  
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 当前用户头像  </span>
</span></span><span style="display:flex;"><span>	user_avatar <span style="color:#666">=</span> ft<span style="color:#666">.</span>CircleAvatar(  
</span></span><span style="display:flex;"><span>	    content<span style="color:#666">=</span>ft<span style="color:#666">.</span>Text(ct<span style="color:#666">.</span>now_username, size<span style="color:#666">=</span><span style="color:#666">14</span>, weight<span style="color:#666">=</span>ft<span style="color:#666">.</span>FontWeight<span style="color:#666">.</span>BOLD),  
</span></span><span style="display:flex;"><span>	    width<span style="color:#666">=</span><span style="color:#666">60</span>,  
</span></span><span style="display:flex;"><span>	    height<span style="color:#666">=</span><span style="color:#666">60</span>,  
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 添加页面布局</span>
</span></span><span style="display:flex;"><span>	page<span style="color:#666">.</span>add(
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># ………………</span>
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic"># 窗口关闭默认退出聊天室  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">close_window</span>(e):  
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> e<span style="color:#666">.</span>data <span style="color:#666">==</span> <span style="color:#b44">&#39;close&#39;</span>:  
</span></span><span style="display:flex;"><span>            ct<span style="color:#666">.</span>send_message(<span style="color:#b44">&#39;exit&#39;</span>)  
</span></span><span style="display:flex;"><span>            page<span style="color:#666">.</span>window_destroy() <span style="color:#080;font-style:italic"># 真正退出窗口  </span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    page<span style="color:#666">.</span>on_window_event <span style="color:#666">=</span> close_window  
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic"># 开启接收消息线程  </span>
</span></span><span style="display:flex;"><span>    receive_thread <span style="color:#666">=</span> threading<span style="color:#666">.</span>Thread(target<span style="color:#666">=</span>receive_message)  
</span></span><span style="display:flex;"><span>    receive_thread<span style="color:#666">.</span>start()  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>ft<span style="color:#666">.</span>app(target<span style="color:#666">=</span>login_page, assets_dir<span style="color:#666">=</span><span style="color:#b44">&#34;assets&#34;</span>)
</span></span></code></pre></div><h2 id="成果展示">成果展示</h2>
<p><img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231207231109.png" alt="服务端启动">
<img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231207231123.png" alt="登录界面">
<img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231207231137.png" alt="注册功能">
<img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231207231147.png" alt="聊天界面">
<img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231207231159.png" alt="公聊功能">
<img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231207231210.png" alt="私聊功能">
<img src="https://cdn.jsdelivr.net/gh/Pi3-l22/pico_rep/img/20231207231221.png" alt="退出聊天室功能"></p>
<h2 id="总结与心得">总结与心得</h2>
<p>总的来说，写一个基于UDP协议的多人聊天室这个实验还是很简单的，因为UDP是无连接的，不像TCP一样要考虑很多的问题，如丢包、失去连接等，UDP只管发送和接收，不用关心信息是否送达，所以少了很多“握手”的过程，简单不少。
但是，等到整个程序写完之后，在命令行中执行，我发现了一个问题，当我正在命令行输入消息时，终端上已经有部分文字，这时候对方发来消息，那么对方的消息就会从我当前的光标处打印出来，把我的语句断开，这对用户来说是个不好的体验。所以最后，我决定写一个图形化界面，将用户输入和公屏输出分开，这样体验和美观程度会大大提高。
图像化界面选择了<a href="https://flet.dev/docs/">flet框架</a>，它基于Google 的 Flutter实现，所以对我来说很快能上手，而不像pyqt5那样复杂。在编写图像化的过程中也遇到了很多问题，不过大部分是flet框架的问题，对于socket这一块的问题就是：因为UDP基于无连接，所以我发送出去的消息不知道对方有没有收到，当我的服务端没有开启时，客户端在登录时会向服务端发送请求同时转到阻塞等到回应，但是这个过程中没有提示，用户可能会多次点击登录或者注册，导致开启大量的UDP阻塞等待，等到服务端上线时，发送的消息会被这些阻塞等待给覆盖掉，导致影响后面的欢迎界面的输出。解决办法就是：设置一个阻塞等待超时，当等待超时，自动释放阻塞的线程，同时弹出警告框，告诉用户“当前服务器连接不上，稍后再试”，以免开启更多的线程，浪费资源同时影响后续输出。
解决了上面这个问题，但是上面这个解决办法同样导致出现了接下来一个问题：需要一直阻塞等待服务端发送消息的功能，因为上面设置的超时时间而报错，所以解决办法也很简单就是在这个功能中，将超时时间设为None。
总之，在这个实验中，我遇到了不少问题，随着一个个问题被解决，我也从中学到了很多。</p>
    
  </article>
  <div class="paginator">
    
    <a class="link" href="https://pi3-l22.github.io/post/2023/11/%E5%9F%BA%E4%BA%8Esocket%E7%9A%84%E8%BF%9C%E7%A8%8B%E6%8E%A7%E5%88%B6%E7%A8%8B%E5%BA%8F/">← prev</a>
    
    
    <a class="link" href="https://pi3-l22.github.io/post/2023/12/t-sql%E8%AF%AD%E5%8F%A5%E6%93%8D%E4%BD%9C%E4%BA%8C/">next →</a>
    
  </div>
  <div class="comment">
    
    
    
    
    
    
  </div>
  
</main>

    <footer id="footer">
  <div>
    <span>© 2021</span> - <span>2024</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> 🍦 Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span>Follow me on <a class=link href=https://github.com/Pi3-l22>GitHub</a> |
<a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a>
</span>
  </div>
</footer>

  </div>

  
  

  
  

  
  

</body>

</html>
