<!doctype html><html lang=zh-cn><head><script>(function(){const e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)})()</script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=author content="LiuChao"><meta name=description content="GORM 官方文档基础入门学习笔记"><link rel=icon href=https://blog.pi3.fun/favicon.ico><meta name=keywords content=" study  latex  life  academic "><meta property="og:url" content="https://blog.pi3.fun/post/2025/03/gorm%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%96%E7%A8%8B/"><meta property="og:site_name" content="Pi3's Notes"><meta property="og:title" content="GORM数据库编程"><meta property="og:description" content="GORM 官方文档基础入门学习笔记"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2025-03-04T00:00:00+00:00"><meta property="article:modified_time" content="2025-03-04T00:00:00+00:00"><meta property="article:tag" content="技术"><meta property="article:tag" content="Golang"><meta property="article:tag" content="GORM"><link rel=canonical href=https://blog.pi3.fun/post/2025/03/gorm%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%96%E7%A8%8B/><meta itemprop=name content="GORM数据库编程"><meta itemprop=description content="GORM 官方文档基础入门学习笔记"><meta itemprop=datePublished content="2025-03-04T00:00:00+00:00"><meta itemprop=dateModified content="2025-03-04T00:00:00+00:00"><meta itemprop=wordCount content="11073"><meta itemprop=keywords content="技术,Golang,GORM"><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/common.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/content.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/theme.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/iconfont/iconfont.css><link rel=stylesheet href=https://blog.pi3.fun/css/syntax/xcode.css data-theme-style=light media="(prefers-color-scheme: light)"><link rel=stylesheet href=https://blog.pi3.fun/css/syntax/catppuccin-mocha.css data-theme-style=dark media="not all"><title>GORM数据库编程 - Pi3's Notes</title>
<link rel=stylesheet href=https://blog.pi3.fun/css/single.css><link href=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/katex.min.css rel=stylesheet><script defer src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/katex.min.js></script><script defer src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}],ignoredTags:["script","noscript","style","textarea","pre","code","option"],throwOnError:!1})})</script></head><body><div id=wrapper><header id=header><h1><a href=https://blog.pi3.fun/>Pi3's Notes</a></h1><nav><span class=nav-bar-item><a class=link href=/>文章</a>
</span><span class=nav-bar-item><a class=link href=/post/>归档</a>
</span><span class=nav-bar-item><a class=link href=/about/>关于</a>
</span><span class=nav-bar-item><a class=link href=/links/>友链</a>
</span><span class=nav-bar-item><a class="link theme-toggle" href=javascript:void(0);>黑暗</a></span></nav></header><main id=main class=post><h1>GORM数据库编程</h1><div><b>Keywords: </b><a class=link href=https://blog.pi3.fun/tags/%E6%8A%80%E6%9C%AF>#技术</a>
<a class=link href=https://blog.pi3.fun/tags/golang>#Golang</a>
<a class=link href=https://blog.pi3.fun/tags/gorm>#GORM</a></div><div><b>Release Date: </b><span>2025-03-04</span></div><details><summary><b>Table of Contents</b></summary><div class=toc><nav id=TableOfContents><ul><li><a href=#什么是-orm>什么是 ORM</a></li><li><a href=#连接数据库>连接数据库</a></li><li><a href=#创建数据表>创建数据表</a></li><li><a href=#数据的增删改查>数据的增删改查</a></li><li><a href=#零值更新问题>零值更新问题</a></li><li><a href=#表结构定义的细节>表结构定义的细节</a></li><li><a href=#创建记录>创建记录</a></li><li><a href=#查询记录>查询记录</a></li><li><a href=#更新记录>更新记录</a></li><li><a href=#删除记录>删除记录</a></li><li><a href=#belong-to>Belong To</a></li><li><a href=#has-many>Has Many</a></li><li><a href=#many-to-many>Many To Many</a></li><li><a href=#自定义表名>自定义表名</a></li><li><a href=#before-create>Before Create</a></li><li><a href=#完整示例代码>完整示例代码</a></li></ul></nav></div></details><article class=content><p><a href=https://gorm.io/zh_CN/docs/index.html>GORM 官方文档</a>基础入门学习笔记</p><h2 id=什么是-orm>什么是 ORM</h2><p>ORM 全称是：Object Relational Mapping（对象关系映射），其主要作用是在编程中，把面向对象的概念跟数据库中表的概念对应起来。举例来说就是，我定义一个对象，那就对应着一张表，这个对象的实例，就对应着表中的一条记录。</p><p>传统通过 SQL 语句来操作数据库，需要我们有足够的 SQL 语句基础，并且不同数据库有不同的 SQL 语言，有一定的门槛。然而 ORM 可以帮我们隔离 SQL 语言，操作数据库时不需要编写对应的 SQL 语言，只需要面向对象编程即可。</p><p>针对 Java、Python 等面向对象的编程语言来说，ORM 就是将一张表映射成一个类，表中的列映射成类中的一个子类（类中套类）。但是对于 Go 语言而言，表不是映射为一个类而是一个结构体（struct），表中的列可以映射成 struct 中不同的类型，同时可以使用 struct 中的 tag 来描述数据库中列的各种属性。</p><p>Go 语言中常用的 ORM 框架有以下这些：</p><ul><li><a href=https://github.com/go-gorm/gorm>gorm</a>（本笔记中使用）</li><li><a href=https://github.com/facebook/ent>ent</a></li><li><a href=https://github.com/jmoiron/sqlx>sqlx</a></li><li><a href=https://gitea.com/xorm/xorm/>xorm</a></li><li><a href=https://github.com/didi/gendry/>gendry</a></li></ul><blockquote><p>我们不用太去纠结应该选择哪一个 ORM 框架，熟悉了其中一个，其他的 orm 迁移成本很低，我们就选择一个 star 数量最高的，不会有出错的框架就行了，它们之间整体差异不会很大。我们更应该关注 SQL 语言本身，它远比 ORM 框架要重要的多。</p></blockquote><p>ORM 有何优缺点？</p><p>优点：</p><ul><li>提高了开发效率。</li><li>屏蔽 SQL 细节。可以自动对实体 Entity 对象与数据库中的 Table 进行字段与属性的映射；不用直接 SQL 编码，屏蔽各种数据库之间的差异。</li></ul><p>缺点：</p><ul><li>ORM 会牺牲程序的执行效率和会固定思维模式</li><li>太过依赖 ORM 会导致 SQL 理解不够</li><li>对于固定的 ORM 依赖过重，导致切换到其他的 ORM 代价高</li></ul><p>我们需要以 SQL 为主，ORM 为辅。ORM 主要目的是为了增加代码可维护性和开发效率。对于 SQL 我们一定要学好：</p><ul><li>group by</li><li>子查询</li><li>having 子句</li></ul><h2 id=连接数据库>连接数据库</h2><p><a href=https://gorm.io/zh_CN/docs/index.html>GORM 官方文档</a>，其官方文档写的十分详细和规范，可以方便我们自行学习。本学习笔记将使用 MySQL 数据库进行演示。</p><p>示例代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;gorm.io/driver/mysql&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;gorm.io/gorm&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=c1>// 参考 https://github.com/go-sql-driver/mysql#dsn-data-source-name 获取详情
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>dsn</span> <span class=o>:=</span> <span class=s>&#34;user:pass@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>mysql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>dsn</span><span class=p>),</span> <span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Config</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><blockquote><p>注意：想要正确的处理 <code>time.Time</code> ，您需要带上 <code>parseTime</code> 参数， (<a href=https://github.com/go-sql-driver/mysql#parameters>更多参数</a>) 要支持完整的 UTF-8 编码，您需要将 <code>charset=utf8</code> 更改为 <code>charset=utf8mb4</code> 查看 <a href=https://mathiasbynens.be/notes/mysql-utf8mb4>此文章</a> 获取详情。</p></blockquote><p>MySQL 驱动程序提供了 <a href=https://github.com/go-gorm/mysql>一些高级配置</a> 可以在初始化过程中使用，例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>mysql</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>mysql</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// DSN data source name
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>DSN</span><span class=p>:</span> <span class=s>&#34;gorm:gorm@tcp(127.0.0.1:3306)/gorm?charset=utf8&amp;parseTime=True&amp;loc=Local&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=c1>// string 类型字段的默认长度
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>DefaultStringSize</span><span class=p>:</span> <span class=mi>256</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=c1>// 禁用 datetime 精度，MySQL 5.6 之前的数据库不支持
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>DisableDatetimePrecision</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=c1>// 重命名索引时采用删除并新建的方式，MySQL 5.7 之前的数据库和 MariaDB 不支持重命名索引
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>DontSupportRenameIndex</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=c1>// 用 `change` 重命名列，MySQL 8 之前的数据库和 MariaDB 不支持重命名列
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>DontSupportRenameColumn</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=c1>// 根据当前 MySQL 版本自动配置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>SkipInitializeWithVersion</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> 
</span></span><span class=line><span class=cl><span class=p>}),</span> <span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Config</span><span class=p>{})</span>
</span></span></code></pre></div><h2 id=创建数据表>创建数据表</h2><p>根据 <a href=https://gorm.io/zh_CN/docs/logger.html>GORM 文档中的说明</a>，GORM 有一个默认的 logger 实现，我们将设置一个全局的 logger，用于将我们后续执行操作的 SQL 语言都打印出来，边学习 GORM 的同时，学习其 SQL 语句的写法。搞清楚 GORM 各个 API 背后真正执行的 SQL 语句是什么。</p><p>配置 logger，并在连接时通过配置参数传入。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>newLogger</span> <span class=o>:=</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// io writer
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>log</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stdout</span><span class=p>,</span> <span class=s>&#34;\r\n&#34;</span><span class=p>,</span> <span class=nx>log</span><span class=p>.</span><span class=nx>LstdFlags</span><span class=p>),</span> 
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>SlowThreshold</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=c1>// Slow SQL threshold
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>LogLevel</span><span class=p>:</span> <span class=nx>logger</span><span class=p>.</span><span class=nx>Info</span><span class=p>,</span> <span class=c1>// Log level
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// Ignore ErrRecordNotFound error for logger
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>IgnoreRecordNotFoundError</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=nx>ParameterizedQueries</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=c1>// Don&#39;t include params in the SQL log
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>Colorful</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=c1>// Enable color
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>dsn</span> <span class=o>:=</span> <span class=s>&#34;user:pass@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>mysql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>dsn</span><span class=p>),</span> <span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Logger</span><span class=p>:</span> <span class=nx>newLogger</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p>接着我们就可以快速入门 GORM 的写法，首先定义一个表结构，将表结构直接生成对应的 MySQL 表，这也是 migrations 功能。</p><p>定义表结构体：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Product</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>    <span class=nx>Code</span> <span class=nx>sql</span><span class=p>.</span><span class=nx>NullString</span>
</span></span><span class=line><span class=cl>    <span class=nx>Price</span> <span class=kt>uint</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>gorm.Model</code> 是 GORM 内置的一个结构体，存放着数据库表中常用的字段，如 id、创建时间、删除时间、更新时间等，我们可以直接拿来使用，作为表结构体的一部分。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Model</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ID</span>        <span class=kt>uint</span> <span class=s>`gorm:&#34;primarykey&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>CreatedAt</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>    <span class=nx>UpdatedAt</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>    <span class=nx>DeletedAt</span> <span class=nx>DeletedAt</span> <span class=s>`gorm:&#34;index&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>在使用之前不要忘了现在数据库中创建一个 <code>gorm_test</code> 的数据库，选择 <code>utf8mb4</code> 字符集，排序规则选择 <code>utf8mb4_general_ci</code>。</p><p>接着，我们使用 <code>_ = db.AutoMigrate(&amp;Product{})</code> 语句就可以自动在数据库中创建一个空表。由于这段代码会执行多条 SQL 语句。如果设置 logger 正确，会输出执行了什么 SQL 语句。</p><p>整体代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Product</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>    <span class=nx>Code</span>  <span class=nx>sql</span><span class=p>.</span><span class=nx>NullString</span>
</span></span><span class=line><span class=cl>    <span class=nx>Price</span> <span class=kt>uint</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>dsn</span> <span class=o>:=</span> <span class=s>&#34;root:root@tcp(192.168.0.104:3306)/gorm_test?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>newLogger</span> <span class=o>:=</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stdout</span><span class=p>,</span> <span class=s>&#34;\r\n&#34;</span><span class=p>,</span> <span class=nx>log</span><span class=p>.</span><span class=nx>LstdFlags</span><span class=p>),</span> 
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>SlowThreshold</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span>   
</span></span><span class=line><span class=cl>            <span class=nx>LogLevel</span><span class=p>:</span> <span class=nx>logger</span><span class=p>.</span><span class=nx>Info</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>Colorful</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 全局模式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>mysql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>dsn</span><span class=p>),</span> <span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Logger</span><span class=p>:</span> <span class=nx>newLogger</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>AutoMigrate</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>Product</span><span class=p>{})</span> <span class=c1>//此处会有sql语句
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>输出的 SQL 语句：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=k>DATABASE</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>SCHEMA_NAME</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>Information_schema</span><span class=p>.</span><span class=n>SCHEMATA</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>SCHEMA_NAME</span><span class=w> </span><span class=k>LIKE</span><span class=w> </span><span class=s1>&#39;gorm_test%&#39;</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>SCHEMA_NAME</span><span class=o>=</span><span class=s1>&#39;gorm_test&#39;</span><span class=w> </span><span class=k>DESC</span><span class=p>,</span><span class=n>SCHEMA_NAME</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=nf>count</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>information_schema</span><span class=p>.</span><span class=kp>tables</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>table_schema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;gorm_test&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>table_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;products&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>table_type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;BASE TABLE&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=w> </span><span class=kt>bigint</span><span class=w> </span><span class=k>unsigned</span><span class=w> </span><span class=kp>AUTO_INCREMENT</span><span class=p>,</span><span class=o>`</span><span class=n>created_at</span><span class=o>`</span><span class=w> </span><span class=kt>datetime</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span><span class=w> </span><span class=no>NULL</span><span class=p>,</span><span class=o>`</span><span class=n>updated_at</span><span class=o>`</span><span class=w> </span><span class=kt>datetime</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span><span class=w> </span><span class=no>NULL</span><span class=p>,</span><span class=o>`</span><span class=n>deleted_at</span><span class=o>`</span><span class=w> </span><span class=kt>datetime</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span><span class=w> </span><span class=no>NULL</span><span class=p>,</span><span class=o>`</span><span class=n>code</span><span class=o>`</span><span class=w> </span><span class=kt>longtext</span><span class=p>,</span><span class=o>`</span><span class=n>price</span><span class=o>`</span><span class=w> </span><span class=kt>bigint</span><span class=w> </span><span class=k>unsigned</span><span class=p>,</span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=p>),</span><span class=k>INDEX</span><span class=w> </span><span class=o>`</span><span class=n>idx_products_deleted_at</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>deleted_at</span><span class=o>`</span><span class=p>))</span><span class=w>
</span></span></span></code></pre></div><blockquote><p><code>db.AutoMigrate()</code> 可以同时传入两个结构体，同时生成两个数据表，包括关联表。</p></blockquote><h2 id=数据的增删改查>数据的增删改查</h2><p>接着我们可以尝试编写增删改查的语句。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 新增
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>Product</span><span class=p>{</span><span class=nx>Code</span><span class=p>:</span> <span class=nx>sql</span><span class=p>.</span><span class=nx>NullString</span><span class=p>{</span><span class=s>&#34;D42&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>},</span> <span class=nx>Price</span><span class=p>:</span> <span class=mi>100</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 读取
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>product</span> <span class=nx>Product</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=c1>// 根据整形主键查找
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>,</span> <span class=s>&#34;code = ?&#34;</span><span class=p>,</span> <span class=s>&#34;D42&#34;</span><span class=p>)</span> <span class=c1>// 查找 code 字段值为 D42 的记录
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 更新 - 将 product 的 price 更新为 200
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=s>&#34;Price&#34;</span><span class=p>,</span> <span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 更新 - 更新多个字段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>).</span><span class=nf>Updates</span><span class=p>(</span><span class=nx>Product</span><span class=p>{</span><span class=nx>Price</span><span class=p>:</span> <span class=mi>200</span><span class=p>,</span> <span class=nx>Code</span><span class=p>:</span><span class=nx>sql</span><span class=p>.</span><span class=nx>NullString</span><span class=p>{</span><span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>}})</span> <span class=c1>// 仅更新非零值字段
</span></span></span><span class=line><span class=cl><span class=c1>// 如果我们去更新一个product 只设置了price：200
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>).</span><span class=nf>Updates</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;Price&#34;</span><span class=p>:</span> <span class=mi>200</span><span class=p>,</span> <span class=s>&#34;Code&#34;</span><span class=p>:</span> <span class=s>&#34;F42&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Delete - 删除 product
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=c1>// 并没有执行delete语句 执行了update语句 逻辑删除 添加删除时间
</span></span></span></code></pre></div><p>以上 Go 代码转换成的 SQL 语句如下，我们可以发现 GORM 自动为我们加上了很多需求和限制，比如自动更改了数据更新时间，自动加上限制 1 条，使用逻辑删除（所有删除语句都不是真的删除数据而是使用逻辑删除，设置删除标志）等等。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>created_at</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>updated_at</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>deleted_at</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>code</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>price</span><span class=o>`</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;2025-03-03 19:52:46.757&#39;</span><span class=p>,</span><span class=s1>&#39;2025-03-03 19:52:46.757&#39;</span><span class=p>,</span><span class=no>NULL</span><span class=p>,</span><span class=s1>&#39;D42&#39;</span><span class=p>,</span><span class=mi>100</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>deleted_at</span><span class=o>`</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=no>NULL</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=w> </span><span class=k>LIMIT</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>code</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;D42&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>deleted_at</span><span class=o>`</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=no>NULL</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LIMIT</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=w> </span><span class=kt>SET</span><span class=w> </span><span class=o>`</span><span class=n>price</span><span class=o>`=</span><span class=mi>200</span><span class=p>,</span><span class=o>`</span><span class=n>updated_at</span><span class=o>`=</span><span class=s1>&#39;2025-03-03 19:52:46.78&#39;</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>deleted_at</span><span class=o>`</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=no>NULL</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w>       
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=w> </span><span class=kt>SET</span><span class=w> </span><span class=o>`</span><span class=n>updated_at</span><span class=o>`=</span><span class=s1>&#39;2025-03-03 19:52:46.784&#39;</span><span class=p>,</span><span class=o>`</span><span class=n>code</span><span class=o>`=</span><span class=s1>&#39;F42&#39;</span><span class=p>,</span><span class=o>`</span><span class=n>price</span><span class=o>`=</span><span class=mi>200</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>deleted_at</span><span class=o>`</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=no>NULL</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=w> </span><span class=kt>SET</span><span class=w> </span><span class=o>`</span><span class=n>code</span><span class=o>`=</span><span class=s1>&#39;F42&#39;</span><span class=p>,</span><span class=o>`</span><span class=n>price</span><span class=o>`=</span><span class=mi>200</span><span class=p>,</span><span class=o>`</span><span class=n>updated_at</span><span class=o>`=</span><span class=s1>&#39;2025-03-03 19:52:46.787&#39;</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>deleted_at</span><span class=o>`</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=no>NULL</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=w> </span><span class=kt>SET</span><span class=w> </span><span class=o>`</span><span class=n>deleted_at</span><span class=o>`=</span><span class=s1>&#39;2025-03-03 19:52:46.791&#39;</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=o>`</span><span class=n>products</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>deleted_at</span><span class=o>`</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=no>NULL</span><span class=w>
</span></span></span></code></pre></div><h2 id=零值更新问题>零值更新问题</h2><p>在上面的更新语句中，我们了解到 <code>updates</code> 语句只能更新非零值的字段, 而 <code>update</code> 语句则不受影响。为什么需要这样？因为 <code>updates</code> 需要传入 <code>struct</code> 或者 <code>map[string]interface{}</code> 参数，如果使用 <code>struct</code> 更新时，比如在 product 结构体中只传入了 Price 的值，那么其他值就会是默认值（Golang 语法决定的），这样在后续数据库操作过程中可能就会存在问题。</p><p>因此，在 ORM 框架中，使用 <code>updates</code> 方法通过传入 <code>struct</code> 的方式进行更新操作时，只能更新非零值字段，其他默认零值的字段传入，将会被忽略，不会出现在最后的 SQL 语句中。具体介绍见官方文档：<a href=https://gorm.io/zh_CN/docs/update.html#%E6%9B%B4%E6%96%B0%E5%A4%9A%E5%88%97>更新 | GORM</a></p><p>我们将上述语句改成以下的代码，那么 price 和 code 都不会被更新，因为它们都是各自属性的零值 （uint 类型零值为 0，string 类型零值为空字符串）。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>).</span><span class=nf>Updates</span><span class=p>(</span><span class=nx>Product</span><span class=p>{</span><span class=nx>Price</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>Code</span><span class=p>:</span><span class=s>&#34;&#34;</span><span class=p>})</span>
</span></span></code></pre></div><p>那么如果我们需要将零值更新进数据库怎么办？就可以像上一节中的代码一样，将可能传入零值的字段定义为 <code>sql.NullString</code> 这个类型。它通过 <code>Valid</code> 这个变量来指定这个字符串是否为空。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>NullString</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>String</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Valid</span>  <span class=kt>bool</span> <span class=c1>// Valid is true if String is not NULL
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>如果将 <code>Valid</code> 设置为 <code>true</code>，就可以将零值（如 code 的空字符串 <code>""</code>）通过 SQL 语句更新到数据库中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>product</span><span class=p>).</span><span class=nf>Updates</span><span class=p>(</span><span class=nx>Product</span><span class=p>{</span><span class=nx>Price</span><span class=p>:</span> <span class=mi>200</span><span class=p>,</span> <span class=nx>Code</span><span class=p>:</span><span class=nx>sql</span><span class=p>.</span><span class=nx>NullString</span><span class=p>{</span><span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>}})</span>
</span></span></code></pre></div><p>除了 <code>NullString</code> 这个类型外，还有 <code>NullBool</code>、<code>NullFloat64</code>、<code>NullInt32</code>、<code>NullInt64</code>、<code>NullTime</code> 这些类型，因为这些类型都有零值。使用它们时需要引入 <code>database/sql</code> 包。</p><p>还有一种方式可以使零值也能更新，就是将类型设置为指针类型，传入参数时需要传入结构体的指针。比如以下这种方式，在最终的 SQL 语句中也会设置 email 为零值。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>user</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>email</span> <span class=o>*</span><span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>empty</span> <span class=o>:=</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>ID</span><span class=p>:</span><span class=mi>1</span><span class=p>}).</span><span class=nf>Updates</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Email</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>empty</span><span class=p>})</span>
</span></span></code></pre></div><p>总结一下，如果想要在数据库中写入零值，那么对应的字段类型就需要使用以上这几种 <code>NUll~</code> 类型，或者使用该类型的指针类型。</p><ol><li><code>sql.NullString</code></li><li><code>*string</code></li></ol><h2 id=表结构定义的细节>表结构定义的细节</h2><p><a href=https://gorm.io/zh_CN/docs/models.html>模型定义 | GORM</a></p><p>在使用 GORM 时，会有一些默认的约定：</p><ol><li><strong class=chinese>主键</strong>：GORM 使用一个名为 <code>ID</code> 的字段作为每个模型的默认主键。</li><li><strong class=chinese>表名</strong>：默认情况下，GORM 将结构体名称转换为 <code>snake_case</code> （蛇形命名）并为表名加上复数形式。例如，一个 <code>Product</code> 结构体在数据库中的表名变为 <code>products</code> 。</li><li><strong class=chinese>列名</strong>：GORM 自动将结构体字段名称转换为 <code>snake_case</code> （蛇形命令）作为数据库中的列名。例如创建时间 <code>CreatedAt</code> 在数据库的列中变为 <code>created_at</code>。</li><li><strong class=chinese>时间戳字段</strong>：GORM 使用字段 <code>CreatedAt</code> 和 <code>UpdatedAt</code> 来自动跟踪记录的创建和更新时间。</li></ol><p><a href=https://gorm.io/zh_CN/docs/models.html#%E5%AD%97%E6%AE%B5%E6%A0%87%E7%AD%BE>字段标签</a></p><p>通过设置结构体的方式定义一个数据库表时，我们可以通过结构体各个字段的 tag 来对各个字段进行约束。这叫做字段标签，多个字段标签用 <code>;</code> 隔开，比如以下例子：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>UserID</span>        <span class=kt>uint</span> <span class=s>`gorm:&#34;primarykey&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`gorm:&#34;column:user_name;type:varchar(50);index:idx_user_name;unique;default:&#39;bobby&#39;&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>我们将 <code>UserID</code> 设置为主键；将 <code>Name</code> 在数据表中的列名设置为 <code>user_name</code>，将其类型设置为数据库中的 <code>varchar(50)</code> 定长字符，创建索引 <code>idx_user_name</code>，并定义成唯一键，最后将默认值设为 <code>bobby</code>。</p><blockquote><p>这些都是数据库中的知识点，一定要学好数据库，否则难以理解。</p></blockquote><h2 id=创建记录>创建记录</h2><p><a href=https://gorm.io/zh_CN/docs/create.html>创建 | GORM</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>user</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>18</span><span class=p>,</span> <span class=nx>Birthday</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>result</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span> <span class=c1>// 通过数据的指针来创建
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>user</span><span class=p>.</span><span class=nx>ID</span>             <span class=c1>// 返回插入数据的主键
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span><span class=p>.</span><span class=nx>Error</span>        <span class=c1>// 返回 error
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span><span class=p>.</span><span class=nx>RowsAffected</span> <span class=c1>// 返回插入记录的条数
</span></span></span></code></pre></div><p>在 <code>db.Create()</code> 这条语句执行之前，<code>User</code> 这个结构体中是没有 <code>ID</code> 这个字段的，执行 SQL 语句后，会设置一个 ID 值（作为主键），并将其写入 <code>User</code> 中，这也是为什么需要传入 <code>User</code> 的地址，因为要对这个对象进行改动。如果在 <code>User</code> 中已经通过 tag 来设置主键后，就不会自动添加 <code>ID</code> 字段了。</p><p>我们还可以使用 <code>Create()</code> 创建多项记录，但是这样使用并不常见，最常用的方式是下方的批量插入的方式。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>users</span> <span class=o>:=</span> <span class=p>[]</span><span class=o>*</span><span class=nx>User</span><span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>18</span><span class=p>,</span> <span class=nx>Birthday</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()},</span>  
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;Jackson&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>19</span><span class=p>,</span> <span class=nx>Birthday</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()},</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=nx>result</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=nx>users</span><span class=p>)</span> <span class=c1>// pass a slice to insert multiple row  
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl><span class=nx>result</span><span class=p>.</span><span class=nx>Error</span>        <span class=c1>// returns error  
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span><span class=p>.</span><span class=nx>RowsAffected</span> <span class=c1>// returns inserted records count
</span></span></span></code></pre></div><p>如果我们有大量的数据需要插入，那么我们就需要用到批量插入了。</p><p>要高效地插入大量记录，需要切片传递给 <code>Create</code> 方法。 GORM 将生成一条 SQL 来插入所有数据（因此性能较好），以返回所有主键值，并触发 <code>Hook</code> 方法。当这些记录可以被分割成多个批次时，GORM 会开启一个事务 <code>&lt;/0></code> 来处理它们。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>users</span> <span class=p>=</span> <span class=p>[]</span><span class=nx>User</span><span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;bobby1&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;bobby2&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;bobby3&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>user</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>users</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>user</span><span class=p>.</span><span class=nx>ID</span> <span class=c1>// 1,2,3
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>我们可以通过 <code>db.CreateInBatches</code> 方法来指定批量插入的批次大小。比如有 10000 条数据需要插入，批次大小设置为 100，那么 GORM 就会生成 100 条 SQL 语句，分别通过 100 次将这 1000 条数据插入数据库中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>users</span> <span class=p>=</span> <span class=p>[]</span><span class=nx>User</span><span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;bobby_1&#34;</span><span class=p>},</span> <span class=o>...</span><span class=p>.,</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;bobby_10000&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// batch size 100
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>CreateInBatches</span><span class=p>(</span><span class=nx>users</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
</span></span></code></pre></div><p>为什么要分批次呢？因为 SQL 语句有长度限制，太长的 SQL 语句不能被执行，分批次插入的方式在大数据量的情况下更常见。</p><p>还有一种更简便的插入方式是通过 <code>map</code> 类型来插入，不创建结构体实例，直接传入一个 <code>map</code> 即可，比如下方这个例子。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 用 `[]map[string]interface{}` 的方式单行插入
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Create</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;Name&#34;</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=s>&#34;Age&#34;</span><span class=p>:</span> <span class=mi>18</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 用 `[]map[string]interface{}{}` 的方式多行插入
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span><span class=nf>Create</span><span class=p>([]</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=s>&#34;Name&#34;</span><span class=p>:</span> <span class=s>&#34;jinzhu_1&#34;</span><span class=p>,</span> <span class=s>&#34;Age&#34;</span><span class=p>:</span> <span class=mi>18</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=s>&#34;Name&#34;</span><span class=p>:</span> <span class=s>&#34;jinzhu_2&#34;</span><span class=p>,</span> <span class=s>&#34;Age&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><blockquote><p><code>map</code> 方式创建更灵活，<code>struct</code> 方式创建更好维护。各有优缺点。</p></blockquote><p>最后还有一种<span id=关联创建>关联创建</span>，一条创建语句同时可以创建两个表记录。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>CreditCard</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Number</span>   <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>UserID</span>   <span class=kt>uint</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>       <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreditCard</span> <span class=nx>CreditCard</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreditCard</span><span class=p>:</span> <span class=nx>CreditCard</span><span class=p>{</span><span class=nx>Number</span><span class=p>:</span> <span class=s>&#34;123456&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `users` ...
</span></span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `credit_cards` ...
</span></span></span></code></pre></div><p>同时 GORM 会为 <code>CreditCard</code> 中的 <code>UserID</code> 自动创建一个外键，关联到 <code>User</code> 中的 <code>ID</code> 字段。</p><p>这是因为 <code>UserID</code> 是一个 <code>uint</code> 类型的字段，它的命名符合 GORM 的外键命名规则（即 <code>&lt;struct name in singular form>_id</code>）。GORM 会自动识别这个字段为外键，并将其与 <code>User</code> 表的主键 <code>id</code> 关联起来。</p><p>其 SQL 语句为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=o>`</span><span class=n>credit_cards</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>created_at</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>updated_at</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>deleted_at</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>number</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>user_id</span><span class=o>`</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;2025-03-03 21:03:34.475&#39;</span><span class=p>,</span><span class=s1>&#39;2025-03-03 21:03:34.475&#39;</span><span class=p>,</span><span class=no>NULL</span><span class=p>,</span><span class=s1>&#39;123456&#39;</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>DUPLICATE</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=o>`</span><span class=n>user_id</span><span class=o>`=</span><span class=k>VALUES</span><span class=p>(</span><span class=o>`</span><span class=n>user_id</span><span class=o>`</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=o>`</span><span class=n>users</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>created_at</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>updated_at</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>deleted_at</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>name</span><span class=o>`</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;2025-03-03 21:03:34.472&#39;</span><span class=p>,</span><span class=s1>&#39;2025-03-03 21:03:34.472&#39;</span><span class=p>,</span><span class=no>NULL</span><span class=p>,</span><span class=s1>&#39;liuchao&#39;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h2 id=查询记录>查询记录</h2><p><a href=https://gorm.io/zh_CN/docs/query.html>查询 | GORM</a></p><p>GORM 提供了 <code>First</code>、<code>Take</code>、<code>Last</code> 方法，以便从数据库中检索<strong class=chinese>单个对象</strong>。当查询数据库时它添加了 <code>LIMIT 1</code> 条件，且没有找到记录时，它会返回 <code>ErrRecordNotFound</code> 错误。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 获取第一条记录（主键升序）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users ORDER BY id LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 获取一条记录，没有指定排序字段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Take</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 获取最后一条记录（主键降序）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Last</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users ORDER BY id DESC LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>result</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>result</span><span class=p>.</span><span class=nx>RowsAffected</span> <span class=c1>// 返回找到的记录数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span><span class=p>.</span><span class=nx>Error</span>        <span class=c1>// returns error or nil
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 检查 ErrRecordNotFound 错误
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>errors</span><span class=p>.</span><span class=nf>Is</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>Error</span><span class=p>,</span> <span class=nx>gorm</span><span class=p>.</span><span class=nx>ErrRecordNotFound</span><span class=p>)</span>
</span></span></code></pre></div><p><code>errors.Is()</code> 方法可以用于准确判断两者是否是同一种错误类型。</p><p>如果想避免 <code>ErrRecordNotFound</code> 错误，你可以使用 <code>Find</code>，比如 <code>db.Limit(1).Find(&amp;user)</code>，<code>Find</code> 方法可以接受 struct 和 slice的数据。</p><p>也可以通过主键查询。<strong>主键查询时不用指定字段名，默认就为主键查询</strong>。</p><p>如果主键是数字类型，您可以使用 <a href=https://gorm.io/zh_CN/docs/query.html#inline_conditions>内联条件</a> 来检索对象。当使用字符串时，需要额外的注意来避免 SQL 注入；查看 <a href=https://gorm.io/zh_CN/docs/security.html>Security</a> 部分来了解详情。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE id = 10;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>,</span> <span class=s>&#34;10&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE id = 10;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>,</span> <span class=p>[]</span><span class=kt>int</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE id IN (1,2,3);
</span></span></span></code></pre></div><p>如果主键是字符串 (例如像 uuid)，查询将被写成如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>,</span> <span class=s>&#34;id = ?&#34;</span><span class=p>,</span> <span class=s>&#34;1b74413f-f3b8-409f-ac47-e8c062e3472a&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE id = &#34;1b74413f-f3b8-409f-ac47-e8c062e3472a&#34;;
</span></span></span></code></pre></div><blockquote><p>这种方式实际上也能够代替下方的 <code>Where()</code> 语句，但是不太常用，<code>First Find Last</code> 都可以。</p></blockquote><p>当目标对象有一个主键值时，将使用主键构建查询条件，例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>user</span> <span class=p>=</span> <span class=nx>User</span><span class=p>{</span><span class=nx>ID</span><span class=p>:</span> <span class=mi>10</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE id = 10;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>result</span> <span class=nx>User</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>ID</span><span class=p>:</span> <span class=mi>10</span><span class=p>}).</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE id = 10;
</span></span></span></code></pre></div><p>如果需要查询全部对象，则需要使用 <code>Find()</code> 方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Get all records
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>result</span><span class=p>.</span><span class=nx>RowsAffected</span> <span class=c1>// returns found records count, equals `len(users)`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>result</span><span class=p>.</span><span class=nx>Error</span>        <span class=c1>// returns error
</span></span></span></code></pre></div><p>在实际项目中，最常用的还是使用条件查询 <code>Where()</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Get first matched record
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>).</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#39;jinzhu&#39; ORDER BY id LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Get all matched records
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name &lt;&gt; ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name &lt;&gt; &#39;jinzhu&#39;;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// IN
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name IN ?&#34;</span><span class=p>,</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu 2&#34;</span><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name IN (&#39;jinzhu&#39;,&#39;jinzhu 2&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// LIKE
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name LIKE ?&#34;</span><span class=p>,</span> <span class=s>&#34;%jin%&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name LIKE &#39;%jin%&#39;;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// AND
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name = ? AND age &gt;= ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=s>&#34;22&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#39;jinzhu&#39; AND age &gt;= 22;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Time
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;updated_at &gt; ?&#34;</span><span class=p>,</span> <span class=nx>lastWeek</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE updated_at &gt; &#39;2000-01-01 00:00:00&#39;;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// BETWEEN
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;created_at BETWEEN ? AND ?&#34;</span><span class=p>,</span> <span class=nx>lastWeek</span><span class=p>,</span> <span class=nx>today</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE created_at BETWEEN &#39;2000-01-01 00:00:00&#39; AND &#39;2000-01-08 00:00:00&#39;;
</span></span></span></code></pre></div><p>我们通过传入结构体 <code>&amp;users</code> 来指定需要查询的表名，同时需要注意 GORM 中的字段名是大小写不敏感的，也就是说 <code>db.Where("Name = ?", "jinzhu").First(&amp;user)</code> 也是可以正确执行的。</p><p><strong>请注意！</strong><code>db.Where("")</code> 引号中一点要填入数据库表中的字段名，而不是代码结构体中的字段名。比如，有以下结构体</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>MyName</span> <span class=kt>string</span> <span class=s>`gorm:&#34;column:name`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>则需要使用以下方式，才能被正确执行。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>).</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span></code></pre></div><p>如果不想使用数据表字段的名称，而是使用结构体中的名称，这时就需要使用到 struct 和 map 作为查询条件了，可以屏蔽具体的数据库细节。比如以下这几种方式，<strong class=chinese>我们更建议使用这种方式</strong>，当这种情况不能满足需求时，再使用上面的方式，更加灵活，<strong>更接近于直接写 SQL 语句</strong>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Struct
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>20</span><span class=p>}).</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#34;jinzhu&#34; AND age = 20 ORDER BY id LIMIT 1;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Map
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#34;jinzhu&#34; AND age = 20;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Slice of primary keys
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>([]</span><span class=kt>int64</span><span class=p>{</span><span class=mi>20</span><span class=p>,</span> <span class=mi>21</span><span class=p>,</span> <span class=mi>22</span><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE id IN (20, 21, 22);
</span></span></span></code></pre></div><p>使用 struct 时，GORM 是不会处理零值的（忽略零值），也就是如果字段为零值，那么将不会在最终的 SQL 语句中被执行，而 map 方式则不会受到影响。比如以下示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>0</span><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#34;jinzhu&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;Name&#34;</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=s>&#34;Age&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>}).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE name = &#34;jinzhu&#34; AND age = 0;
</span></span></span></code></pre></div><p>除此之外，还有许多的查询语句，具体可以见<a href=https://gorm.io/zh_CN/docs/query.html>官方文档</a>，同时一定要学好数据库，其中 <code>group by</code>、<code>having</code> 和子查询等十分重要。</p><p>总结一下，常用的查询方法：</p><ol><li>string，灵活但不常用，接近 SQL 语句</li><li>struct，推荐使用</li><li>map，解决零值问题</li></ol><blockquote><p><code>Find()</code> 可能会返回多条记录，因此需要使用 <code>[]User</code> 类型来接收，而 <code>First()</code> 和 <code>Last()</code> 都只会返回单条记录，因此可以使用 <code>User</code> 类型来接收。</p></blockquote><h2 id=更新记录>更新记录</h2><p><a href=https://gorm.io/zh_CN/docs/update.html>更新 | GORM</a></p><p>在上方我们已经学习过<a href=#%E9%9B%B6%E5%80%BC%E6%9B%B4%E6%96%B0%E9%97%AE%E9%A2%98>零值更新问题</a>，实际上还有一个 <code>Sava()</code> 方法会保存所有的字段，即使字段是零值。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>user</span><span class=p>.</span><span class=nx>Name</span> <span class=p>=</span> <span class=s>&#34;jinzhu 2&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>user</span><span class=p>.</span><span class=nx>Age</span> <span class=p>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Save</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;jinzhu 2&#39;, age=100, birthday=&#39;2016-01-01&#39;, updated_at = &#39;2013-11-17 21:34:10&#39; WHERE id=111;
</span></span></span></code></pre></div><p><code>Save ()</code> 是一个组合函数。如果保存值不包含主键，它将执行 <code>Create</code>（创建新记录），否则它将执行 <code>Update</code> (包含所有字段，其它字段自动设为零值)。所以如果不想将所有字段都修改，那么不推荐使用 <code>Save ()</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Save</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>100</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// INSERT INTO `users` (`name`,`age`,`birthday`,`update_at`) VALUES (&#34;jinzhu&#34;, 100,&#34;0000-00-00 00:00:00&#34;,&#34;0000-00-00 00:00:00&#34;)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Save</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span><span class=nx>ID</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>100</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE `users` SET `name`=&#34;jinzhu&#34;,`age`=100,`birthday`=&#34;0000-00-00 00:00:00&#34;,`update_at`=&#34;0000-00-00 00:00:00&#34; WHERE `id` = 1
</span></span></span></code></pre></div><p>需要注意，不要将 <code>Save ()</code> 和 <code>Model ()</code> 一同使用, 这是<strong class=chinese>未定义的行为</strong>。因为 <code>Save ()</code> 已经可以通过传入的结构体名称来指定是哪个数据表，比如 <code>Save (&amp;user)</code> 就是修改 <code>user</code> 表，这跟上方的查询语句 <code>Find ()</code>、<code>First ()</code> 等语句一样。</p><p>但是对于接下来的 <code>Update ()</code> 和 <code>Updates ()</code> 方法，它们没有可以传递结构体名的地方，因此需要用到 <code>Model ()</code> 来指定更新哪个数据表的记录。</p><p>更新单个列。</p><p>当使用 <code>Update</code> 更新单列时，需要有一些条件，否则将会引起<code>ErrMissingWhereClause</code> 错误，查看 <a href=https://gorm.io/zh_CN/docs/update.html#block_global_updates>阻止全局更新</a> 了解详情。当使用 <code>Model</code> 方法，并且它有主键值时，主键将会被用于构建条件，例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 根据条件更新
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{}).</span> <span class=nf>Where</span> <span class=p>(</span><span class=s>&#34;active = ?&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>).</span> <span class=nf>Update</span> <span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;hello&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39;, updated_at=&#39;2013-11-17 21:34:10&#39; WHERE active=true;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// User 的 ID 是 `111`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span> <span class=nf>Update</span> <span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;hello&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39;, updated_at=&#39;2013-11-17 21:34:10&#39; WHERE id=111;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 根据条件和 model 的值进行更新
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span> <span class=nf>Where</span> <span class=p>(</span><span class=s>&#34;active = ?&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>).</span> <span class=nf>Update</span> <span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;hello&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39;, updated_at=&#39;2013-11-17 21:34:10&#39; WHERE id=111 AND active=true;
</span></span></span></code></pre></div><blockquote><p>如果传入的 <code>user</code> 结构体中有主键信息，则会自动作为 SQL 语句的条件，如果没有任何数据信息，则会通过 <code>Where ()</code> 中的条件进行查找更新。</p></blockquote><p>更新多个列。</p><p><code>Updates</code> 方法支持 <code>struct</code> 和 <code>map[string]interface{}</code> 参数。当使用 <code>struct</code> 更新时，默认情况下 GORM 只会更新非零值的字段</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 根据 `struct` 更新属性，只会更新非零值的字段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span> <span class=nf>Updates</span> <span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;hello&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>18</span><span class=p>,</span> <span class=nx>Active</span><span class=p>:</span> <span class=kc>false</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39;, age=18, updated_at = &#39;2013-11-17 21:34:10&#39; WHERE id = 111;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 根据 `map` 更新属性
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span> <span class=nf>Updates</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;hello&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>:</span> <span class=mi>18</span><span class=p>,</span> <span class=s>&#34;active&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39;, age=18, active=false, updated_at=&#39;2013-11-17 21:34:10&#39; WHERE id=111;
</span></span></span></code></pre></div><blockquote><p><strong class=chinese>再次注意</strong>，使用 struct 更新时, GORM 将只更新非零值字段。解决方式是用 <code>map</code> 来更新属性，或者使用 <code>Select</code> 声明字段来更新</p></blockquote><p>如果您想要在更新时选择、忽略某些字段，您可以使用 <code>Select</code>、<code>Omit</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 选择 Map 的字段
</span></span></span><span class=line><span class=cl><span class=c1>// User 的 ID 是 `111`:
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span> <span class=nf>Select</span> <span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>).</span> <span class=nf>Updates</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;hello&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>:</span> <span class=mi>18</span><span class=p>,</span> <span class=s>&#34;active&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;hello&#39; WHERE id=111;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span> <span class=nf>Omit</span> <span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>).</span> <span class=nf>Updates</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;hello&#34;</span><span class=p>,</span> <span class=s>&#34;age&#34;</span><span class=p>:</span> <span class=mi>18</span><span class=p>,</span> <span class=s>&#34;active&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET age=18, active=false, updated_at=&#39;2013-11-17 21:34:10&#39; WHERE id=111;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 选择 Struct 的字段（会选中零值的字段）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span> <span class=nf>Select</span> <span class=p>(</span><span class=s>&#34;Name&#34;</span><span class=p>,</span> <span class=s>&#34;Age&#34;</span><span class=p>).</span> <span class=nf>Updates</span> <span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;new_name&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>0</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET name=&#39;new_name&#39;, age=0 WHERE id=111;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 选择所有字段（选择包括零值字段的所有字段）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span> <span class=nf>Select</span> <span class=p>(</span><span class=s>&#34;*&#34;</span><span class=p>).</span> <span class=nf>Updates</span> <span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=nx>Role</span><span class=p>:</span> <span class=s>&#34;admin&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>0</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 选择除 Role 外的所有字段（包括零值字段的所有字段）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Model</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span> <span class=nf>Select</span> <span class=p>(</span><span class=s>&#34;*&#34;</span><span class=p>).</span> <span class=nf>Omit</span> <span class=p>(</span><span class=s>&#34;Role&#34;</span><span class=p>).</span> <span class=nf>Updates</span> <span class=p>(</span><span class=nx>User</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>,</span> <span class=nx>Role</span><span class=p>:</span> <span class=s>&#34;admin&#34;</span><span class=p>,</span> <span class=nx>Age</span><span class=p>:</span> <span class=mi>0</span><span class=p>})</span>
</span></span></code></pre></div><h2 id=删除记录>删除记录</h2><p>删除一条记录时，删除对象需要指定主键，否则会触发 <a href=https://gorm.io/zh_CN/docs/delete.html#batch_delete>批量删除</a>，例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Email 的 ID 是 `10`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Delete</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>email</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE from emails where id = 10;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 带额外条件的删除
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span> <span class=p>(</span><span class=s>&#34;name = ?&#34;</span><span class=p>,</span> <span class=s>&#34;jinzhu&#34;</span><span class=p>).</span> <span class=nf>Delete</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>email</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE from emails where id = 10 AND name = &#34;jinzhu&#34;;
</span></span></span></code></pre></div><p>GORM 允许通过主键（可以是复合主键）和内联条件来删除对象，这与<a href=https://gorm.io/zh_CN/docs/query.html#inline_conditions>查询-内联条件（Query Inline Conditions）</a> 是类似的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Delete</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{},</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE FROM users WHERE id = 10;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Delete</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{},</span> <span class=s>&#34;10&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE FROM users WHERE id = 10;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Delete</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>,</span> <span class=p>[]</span><span class=kt>int</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE FROM users WHERE id IN (1,2,3);
</span></span></span></code></pre></div><p>更为重要的是软删除功能，即逻辑删除（不删除表数据，只是通过删除时间来标记该条记录已被删除）。</p><p>如果你的模型包含了 <code>gorm. DeletedAt</code>字段（该字段也被包含在<code>gorm. Model</code>中），那么该模型将会自动获得软删除的能力！</p><p>当调用 <code>Delete</code> 时，GORM 并不会从数据库中删除该记录，而是将该记录的 <code>DeleteAt</code> 设置为当前时间，而后的一般查询方法也将无法查找到此条记录。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// user&#39;s ID is `111`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Delete</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET deleted_at=&#34;2013-10-29 10:23&#34; WHERE id = 111;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Batch Delete
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span> <span class=p>(</span><span class=s>&#34;age = ?&#34;</span><span class=p>,</span> <span class=mi>20</span><span class=p>).</span> <span class=nf>Delete</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=c1>// UPDATE users SET deleted_at=&#34;2013-10-29 10:23&#34; WHERE age = 20;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Soft deleted records will be ignored when querying
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Where</span> <span class=p>(</span><span class=s>&#34;age = 20&#34;</span><span class=p>).</span> <span class=nf>Find</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SELECT * FROM users WHERE age = 20 AND deleted_at IS NULL;
</span></span></span></code></pre></div><p>如果你并不想嵌套<code>gorm. Model</code>，你也可以像下方例子那样开启软删除特性：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>      <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Deleted</span> <span class=nx>gorm</span><span class=p>.</span> <span class=nx>DeletedAt</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>    <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>如果不想使用软删除，而是使用硬删除，即永久删除。可以使用 <code>Unscoped</code> 来永久删除匹配的记录。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Unscoped</span> <span class=p>().</span> <span class=nf>Delete</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>order</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// DELETE FROM orders WHERE id=10;
</span></span></span></code></pre></div><blockquote><p>无论更新、删除都可以先通过查询记录的方式拿到 <code>user</code>（单个对象）或者 <code>users</code>（对象列表），再将其传入 <code>Model ()</code> 或者 <code>Delete ()</code> 中来确定需要更新或者删除的数据范围。</p></blockquote><h2 id=belong-to>Belong To</h2><p><a href=https://gorm.io/zh_CN/docs/belongs_to.html>Belongs To | GORM</a></p><p>在<a href=#%E5%88%9B%E5%BB%BA%E8%AE%B0%E5%BD%95>创建记录</a>中的关联创建中，我们已经了解过如何将两个表通过外键联系。除此之外，还有很多种方式进行表的关联。</p><p><code>belongs to</code> 会与另一个模型建立了<strong class=chinese>一对一</strong>的连接。这种模型的每一个实例都“属于”另一个模型的一个实例。</p><p>例如，您的应用包含 user 和 company，并且每个 user 能且只能被分配给一个 company。下面的类型就表示这种关系。注意，在 <code>User</code> 对象中，有一个和 <code>Company</code> 一样的 <code>CompanyID</code>。默认情况下， <code>CompanyID</code> 被隐含地用来在 <code>User</code> 和 <code>Company</code> 之间创建一个外键关系，因此必须包含在 <code>User</code> 结构体中才能填充 <code>Company</code> 内部结构体。</p><p>即 <code>CompanyID int</code> 和 <code>Company Company</code> 才可以共同表示一个外键，<code>Company Company</code> 没有实际作用，只是指明了外键连接的是哪张表。</p><p>在 User 表中创建记录时，如果不传入 company 字段则会报错（因为有外键），因此可以使用关联创建。GORM 会自动找到两个表对应的记录，并关联起来。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// `User` 属于 `Company`，`CompanyID` 是外键
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span> <span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>CompanyID</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Company</span>   <span class=nx>Company</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Company</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span> 
</span></span></code></pre></div><p>要定义一个 belongs to 关系，数据库的表中必须存在外键。默认情况下，外键的名字，使用拥有者的类型名称加上表的主键的字段名字</p><p>例如，定义一个 User 实体属于 Company 实体，那么外键的名字一般使用 CompanyID。</p><p>GORM 同时提供自定义外键名字的方式，如下例所示。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span> <span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>         <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>CompanyRefer</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Company</span>      <span class=nx>Company</span> <span class=s>`gorm: &#34;foreignKey: CompanyRefer&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 使用 CompanyRefer 作为外键
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Company</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>对于 belongs to 关系，GORM 通常使用数据库表，主表（拥有者）的主键值作为外键参考。如果不想默认使用主键作为外键，也可以使用标签 <code>references</code> 来更改它，例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span> <span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>CompanyID</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Company</span>   <span class=nx>Company</span> <span class=s>`gorm: &#34;references: Code&#34;`</span> <span class=c1>// 使用 Code 作为引用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Company</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=nx>Code</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>如何解决关联查询的问题，如何同时查询两个表？</p><p>如果对一个关联的表使用之前的查询语句去查询两个表的内容，比如以下情况：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>user</span> <span class=nx>User</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>First</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span> <span class=p>(</span><span class=nx>user</span><span class=p>.</span> <span class=nx>Name</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span> <span class=nx>Company</span><span class=p>.</span> <span class=nx>Name</span><span class=p>)</span>
</span></span></code></pre></div><p>则只会输出 <code>user. Name</code> 的值，而 <code>user. Company. Name</code> 的值为<strong class=chinese>零值</strong>。这是因为 <code>user. Company. Name</code> 的数据属于另外一个表 <code>company</code>，使用以上方式查询记录，在 SQL 语句中指定了数据表为 <code>users</code>，<code>SELECT * FROM users WHERE ……</code>，所以查询不到数据。</p><p>如果想查询出两个表的数据，需要使用 <code>Preload</code> 和 <code>Joins</code> 预加载 belongs to 关联的记录，查看 <a href=https://gorm.io/zh_CN/docs/preload.html>预加载</a> 获取详情。</p><p>创建多条记录。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Create</span> <span class=p>(</span><span class=o>&amp;</span><span class=p>[]</span><span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao 1&#34;</span><span class=p>,</span> <span class=nx>Company</span><span class=p>:</span> <span class=nx>Company</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;company 1&#34;</span><span class=p>}},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao 2&#34;</span><span class=p>,</span> <span class=nx>Company</span><span class=p>:</span> <span class=nx>Company</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;company 2&#34;</span><span class=p>}},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao 3&#34;</span><span class=p>,</span> <span class=nx>Company</span><span class=p>:</span> <span class=nx>Company</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;company 3&#34;</span><span class=p>}},</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p>使用 <code>Preload</code> 方法查询。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>user</span> <span class=nx>User</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Preload</span> <span class=p>(</span><span class=s>&#34;Company&#34;</span><span class=p>).</span> <span class=nf>First</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span> <span class=p>(</span><span class=nx>user</span><span class=p>.</span> <span class=nx>Name</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span> <span class=nx>Company</span><span class=p>.</span> <span class=nx>Name</span><span class=p>)</span>
</span></span></code></pre></div><p>使用 <code>Joins</code> 方法查询。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>user</span> <span class=nx>User</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Joins</span> <span class=p>(</span><span class=s>&#34;Company&#34;</span><span class=p>).</span> <span class=nf>First</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span> <span class=p>(</span><span class=nx>user</span><span class=p>.</span> <span class=nx>Name</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span> <span class=nx>Company</span><span class=p>.</span> <span class=nx>Name</span><span class=p>)</span>
</span></span></code></pre></div><p>两者的区别在于 <code>Preload</code> 方法会执行多条 SQL 语句，而 <code>Joins</code> 方法只会执行一条 SQL 语句（使用 JOIN 操作 ）。</p><h2 id=has-many>Has Many</h2><p><a href=https://gorm.io/zh_CN/docs/has_many.html>Has Many | GORM</a></p><p><code>has many</code> 与另一个模型建立了一对多的连接。不同于 <code>has one</code>，拥有者可以有零或多个关联模型。</p><p>例如，您的应用包含 user 和 credit card 模型，且每个 user 可以有多张 credit card。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// User 有多张 CreditCard，UserID 是外键
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span> <span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreditCards</span> <span class=p>[]</span><span class=nx>CreditCard</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>CreditCard</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span> <span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Number</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>UserID</span> <span class=kt>uint</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><blockquote><p>与 Belong To 类型不同，此时的外键必须设置在 <code>CreditCard</code> 中，这是因为只有一张信用卡才能唯一对应一个用户，反之则不行。</p></blockquote><p>要定义 <code>has many</code> 关系，同样必须存在外键。默认的外键名是拥有者的类型名加上其主键字段名</p><p>例如，要定义一个属于 <code>User</code> 的模型，则其外键应该是 <code>UserID</code>。</p><p>此外，想要使用另一个字段作为外键，您可以使用 <code>foreignKey</code> 标签自定义它：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span> <span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreditCards</span> <span class=p>[]</span><span class=nx>CreditCard</span> <span class=s>`gorm: &#34;foreignKey: UserRefer&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>CreditCard</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span> <span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Number</span>    <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>UserRefer</span> <span class=kt>uint</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>GORM 通常使用拥有者的主键作为外键的值。对于上面的例子，它是 <code>User</code> 的 <code>ID</code> 字段。</p><p>为 user 添加 credit card 时，GORM 会将 user 的 <code>ID</code> 字段保存到 credit card 的 <code>UserID</code> 字段。</p><p>同样的，您也可以使用标签 <code>references</code> 来更改它，例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span> <span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>MemberNumber</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>CreditCards</span>  <span class=p>[]</span><span class=nx>CreditCard</span> <span class=s>`gorm: &#34;foreignKey: UserNumber; references: MemberNumber&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>CreditCard</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span> <span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Number</span>     <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>UserNumber</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>在大型的系统、高并发的系统中一般不使用外键约束，因为外键约束对数据库性能有很大的影响，所以一般是在业务层面保证数据的一致性。同时外键约束也有很大的优点：，可以保持数据的完整性，即使是业务代码考虑不严谨。</p><p>创建测试记录。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Create</span> <span class=p>(</span><span class=o>&amp;</span><span class=p>[]</span><span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao 1&#34;</span><span class=p>,</span> <span class=nx>CreditCart</span><span class=p>:</span> <span class=p>[]</span><span class=nx>CreditCart</span> <span class=p>{{</span><span class=nx>Number</span><span class=p>:</span> <span class=s>&#34;123456&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Number</span><span class=p>:</span> <span class=s>&#34;654321&#34;</span><span class=p>}}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao 2&#34;</span><span class=p>,</span> <span class=nx>CreditCart</span><span class=p>:</span> <span class=p>[]</span><span class=nx>CreditCart</span> <span class=p>{{</span><span class=nx>Number</span><span class=p>:</span> <span class=s>&#34;abcdef&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Number</span><span class=p>:</span> <span class=s>&#34;fedcba&#34;</span><span class=p>}}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao 3&#34;</span><span class=p>,</span> <span class=nx>CreditCart</span><span class=p>:</span> <span class=p>[]</span><span class=nx>CreditCart</span> <span class=p>{{</span><span class=nx>Number</span><span class=p>:</span> <span class=s>&#34;qwerty&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Number</span><span class=p>:</span> <span class=s>&#34;ytrewq&#34;</span><span class=p>}}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p>查询两个表的数据，同样可以使用 <code>Preload</code> 方法，但不能使用 <code>Joins</code> 方法（会报错）。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>user</span> <span class=nx>User</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Preload</span> <span class=p>(</span><span class=s>&#34;CreditCards&#34;</span><span class=p>).</span> <span class=nf>First</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>card</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>user</span><span class=p>.</span> <span class=nx>CreditCards</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span> <span class=p>(</span><span class=nx>card</span><span class=p>.</span> <span class=nx>Number</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>为什么不能使用 <code>Joins</code> 方法？</p><p>在 Belongs To 关系中，主表（如 <code>User</code>）通过外键（如 <code>CompanyID</code>）指向从表（如 <code>Company</code>）。这种关系的特点是：</p><ul><li>主表包含外键：<code>User</code> 表中有一个外键 <code>CompanyID</code>，指向 <code>Company</code> 表的主键。</li><li>一对一关系：每个 <code>User</code> 只能关联一个 <code>Company</code>。</li></ul><p>但是在 Has Many 关系中，主表（如 <code>User</code>）可以关联多个从表记录（如 <code>CreditCart</code>）。这种关系的特点是：</p><ul><li>从表包含外键：<code>CreditCart</code> 表中有一个外键 <code>UserID</code>，指向 <code>User</code> 表的主键。</li><li>一对多关系：一个 <code>User</code> 可以关联多个 <code>CreditCart</code>。</li></ul><p><code>Joins ("CreditCard")</code>会生成类似这样的 SQL：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>credit_cards</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>users</span><span class=p>.</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>credit_cards</span><span class=p>.</span><span class=w> </span><span class=n>user_id</span><span class=w>
</span></span></span></code></pre></div><p>对于有多个 CreditCard 的用户，会产生多条记录（每个 CreditCard 对应一行）。而 GORM 的 <code>First ()</code> 方法期望只处理单条记录，无法将多行 JOIN 结果正确映射到切片字段，导致反射错误。</p><p><code>Joins ("Company")</code>生成的 SQL：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>companies</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>users</span><span class=p>.</span><span class=w> </span><span class=n>company_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>companies</span><span class=p>.</span><span class=w> </span><span class=n>id</span><span class=w>
</span></span></span></code></pre></div><p>由于是一对一关系，JOIN 结果始终只有单行，可以完美映射到结构体的单个嵌套对象。</p><p>而<code>Preload ("CreditCards")</code>会执行两条 SQL：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=p>;</span><span class=w> </span><span class=c1>-- 先查询主表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>credit_cards</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>user_id</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(...);</span><span class=w> </span><span class=c1>-- 再批量查询关联表
</span></span></span></code></pre></div><p>这种方式将关联数据以切片形式正确填充，避免了 JOIN 带来的行数膨胀问题。</p><p>当尝试用<code>Joins ()</code>加载 Has Many 关联时，GORM 的反射机制试图将多行 JOIN 结果映射到切片字段，但由于<code>First ()</code>只取第一条记录，导致：</p><ul><li>反射试图操作切片值时出现类型不匹配</li><li>最终抛出 <code>reflect: call of reflect. Value. Field on slice Value</code></li></ul><p>所以</p><ul><li>对于<strong>Has Many</strong>关系，坚持使用 <code>Preload ()</code></li><li>对于<strong>Belongs To</strong>/<strong>Has One</strong>关系，可以安全使用 <code>Preload ()</code> 或 <code>Joins ()</code></li><li>对于<strong>Many To Many</strong>关系，需要使用 <code>Association ()</code></li></ul><h2 id=many-to-many>Many To Many</h2><p><a href=https://gorm.io/zh_CN/docs/many_to_many.html>Many To Many | GORM</a></p><p>Many To Many 多对多的关系会在很多实际开发的场景被用到。</p><p>Many to Many 会在两个 model 中添加一张连接表。</p><p>例如，您的应用包含了 user 和 language，且一个 user 可以说多种 language，多个 user 也可以说一种 language。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// User 拥有并属于多种 language，`user_languages` 是连接表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span> <span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Languages</span> <span class=p>[]</span><span class=nx>Language</span> <span class=s>`gorm: &#34;many 2 many: user_languages;&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Language</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gorm</span><span class=p>.</span> <span class=nx>Model</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 连接表：user_languages  
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: user_id, reference: users. id  
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: language_id, reference: languages. id
</span></span></span></code></pre></div><p>当使用 GORM 的 <code>AutoMigrate</code> 为 <code>User</code> 创建表时，GORM 会自动创建连接表。</p><p>对于 <code>many 2 many</code> 关系，连接表会同时拥有两个模型的外键，若要重写它们，可以使用标签 <code>foreignKey</code>、<code>references</code>、<code>joinforeignKey</code>、<code>joinReferences</code>。当然，您不需要使用全部的标签，你可以仅使用其中的一个重写部分的外键、引用。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>gorm</span><span class=p>.</span> <span class=nx>Model</span>
</span></span><span class=line><span class=cl>    <span class=nx>Profiles</span> <span class=p>[]</span><span class=nx>Profile</span> <span class=s>`gorm: &#34;many 2 many: user_profiles; foreignKey: Refer; joinForeignKey: UserReferID; References: UserRefer; joinReferences: ProfileRefer&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Refer</span>    <span class=kt>uint</span>      <span class=s>`gorm: &#34;index:, unique&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Profile</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>gorm</span><span class=p>.</span> <span class=nx>Model</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>UserRefer</span> <span class=kt>uint</span> <span class=s>`gorm: &#34;index:, unique&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 连接表：user_profiles
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: user_refer_id, reference: users. refer
</span></span></span><span class=line><span class=cl><span class=c1>//   foreign key: profile_refer, reference: profiles. user_refer
</span></span></span></code></pre></div><p>创建测试记录。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>Create</span> <span class=p>(</span><span class=o>&amp;</span><span class=p>[]</span><span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao 1&#34;</span><span class=p>,</span> <span class=nx>Languages</span><span class=p>:</span> <span class=p>[]</span><span class=nx>Language</span> <span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;chinese&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;english&#34;</span><span class=p>}}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao 2&#34;</span><span class=p>,</span> <span class=nx>Languages</span><span class=p>:</span> <span class=p>[]</span><span class=nx>Language</span> <span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;chinese&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;japanese&#34;</span><span class=p>}}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao 3&#34;</span><span class=p>,</span> <span class=nx>Languages</span><span class=p>:</span> <span class=p>[]</span><span class=nx>Language</span> <span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;chinese&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;korean&#34;</span><span class=p>}}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao 4&#34;</span><span class=p>,</span> <span class=nx>Languages</span><span class=p>:</span> <span class=p>[]</span><span class=nx>Language</span> <span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;english&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;french&#34;</span><span class=p>}}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p>如果直接使用以上方式创建记录，那么 language 表中就会出现如下图所示的重复数据，这是因为<strong>每次创建用户时都直接新建了 <code>Language</code> 实例，而没有检测数据库中是否已存在同名语言记录</strong>（GORM 不会自动检测）。</p><p><img src=https://cdn.pi3.fun/blog/202503042356190.png alt=image.png></p><p><strong class=chinese>第一种解决方式</strong>是在插入记录之前，先使用 <code>FirstOrCreate</code> 检查是否有同名的 language，如果有就不会创建新数据，直接使用数据表中的已有数据。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Languages</span> <span class=p>[]</span><span class=nx>Language</span> <span class=s>`gorm:&#34;many2many:user_languages;&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Language</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`gorm:&#34;index:,unique&#34;`</span> <span class=c1>// 关键点：唯一约束
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>sqlite</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;test.db&#34;</span><span class=p>),</span> <span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Config</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>.</span><span class=nf>AutoMigrate</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{},</span> <span class=o>&amp;</span><span class=nx>Language</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 批量创建用户
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>users</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao1&#34;</span><span class=p>,</span> <span class=nx>Languages</span><span class=p>:</span> <span class=nf>getOrCreateLanguages</span><span class=p>(</span><span class=nx>db</span><span class=p>,</span> <span class=s>&#34;chinese&#34;</span><span class=p>,</span> <span class=s>&#34;english&#34;</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao2&#34;</span><span class=p>,</span> <span class=nx>Languages</span><span class=p>:</span> <span class=nf>getOrCreateLanguages</span><span class=p>(</span><span class=nx>db</span><span class=p>,</span> <span class=s>&#34;chinese&#34;</span><span class=p>,</span> <span class=s>&#34;japanese&#34;</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao3&#34;</span><span class=p>,</span> <span class=nx>Languages</span><span class=p>:</span> <span class=nf>getOrCreateLanguages</span><span class=p>(</span><span class=nx>db</span><span class=p>,</span> <span class=s>&#34;chinese&#34;</span><span class=p>,</span> <span class=s>&#34;korean&#34;</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao4&#34;</span><span class=p>,</span> <span class=nx>Languages</span><span class=p>:</span> <span class=nf>getOrCreateLanguages</span><span class=p>(</span><span class=nx>db</span><span class=p>,</span> <span class=s>&#34;english&#34;</span><span class=p>,</span> <span class=s>&#34;french&#34;</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>getOrCreateLanguages</span><span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>,</span> <span class=nx>names</span> <span class=o>...</span><span class=kt>string</span><span class=p>)</span> <span class=p>[]</span><span class=nx>Language</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>languages</span> <span class=p>[]</span><span class=nx>Language</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>name</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>names</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>lang</span> <span class=nx>Language</span>
</span></span><span class=line><span class=cl>        <span class=nx>db</span><span class=p>.</span><span class=nf>FirstOrCreate</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>lang</span><span class=p>,</span> <span class=nx>Language</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>name</span><span class=p>})</span> <span class=c1>// 关键点：查询或创建
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>languages</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>languages</span><span class=p>,</span> <span class=nx>lang</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>languages</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong class=chinese>第二种解决方式</strong>就是在第一种方法的基础上使用 <code>BeforeCreate</code> 钩子，<a href=#Before%20Create>Before Create</a>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Languages</span> <span class=p>[]</span><span class=nx>Language</span> <span class=s>`gorm:&#34;many2many:user_languages;&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Language</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`gorm:&#34;index:,unique&#34;`</span> <span class=c1>// 仍然建议加唯一约束
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// BeforeCreate 钩子：自动处理语言记录的唯一性
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>BeforeCreate</span><span class=p>(</span><span class=nx>tx</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Languages</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>lang</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>u</span><span class=p>.</span><span class=nx>Languages</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>tx</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=nx>Language</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>lang</span><span class=p>.</span><span class=nx>Name</span><span class=p>}).</span><span class=nf>FirstOrCreate</span><span class=p>(</span><span class=nx>lang</span><span class=p>).</span><span class=nx>Error</span><span class=p>;</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>sqlite</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;test.db&#34;</span><span class=p>),</span> <span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Config</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>.</span><span class=nf>AutoMigrate</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>User</span><span class=p>{},</span> <span class=o>&amp;</span><span class=nx>Language</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 直接创建用户，无需手动处理语言
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=p>[]</span><span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao1&#34;</span><span class=p>,</span> <span class=nx>Languages</span><span class=p>:</span> <span class=p>[]</span><span class=nx>Language</span><span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;chinese&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;english&#34;</span><span class=p>}}},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao2&#34;</span><span class=p>,</span> <span class=nx>Languages</span><span class=p>:</span> <span class=p>[]</span><span class=nx>Language</span><span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;chinese&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;japanese&#34;</span><span class=p>}}},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao3&#34;</span><span class=p>,</span> <span class=nx>Languages</span><span class=p>:</span> <span class=p>[]</span><span class=nx>Language</span><span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;chinese&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;korean&#34;</span><span class=p>}}},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;liuchao4&#34;</span><span class=p>,</span> <span class=nx>Languages</span><span class=p>:</span> <span class=p>[]</span><span class=nx>Language</span><span class=p>{{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;english&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;french&#34;</span><span class=p>}}},</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>两种方式都是相同的原理，都能够实现下图的效果。</p><p><img src=https://cdn.pi3.fun/blog/202503042356836.png alt=image.png></p><p>查询两个表中的数据，同样只能使用 <code>Preload</code> ，而不能使用 <code>Joins</code> 方法。原理与 <a href=#Has%20Many>Has Many</a> 相同。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>user</span> <span class=nx>User</span>
</span></span><span class=line><span class=cl><span class=c1>// 查找第一个user的languages
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nf>Preload</span><span class=p>(</span><span class=s>&#34;Languages&#34;</span><span class=p>).</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>language</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>user</span><span class=p>.</span><span class=nx>Languages</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>language</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>如果我已经取出一个 user，但是这个 user 我们之前没有使用 <code>Preload</code> 来加载对应的 Languages，即只有 <code>user</code> 的 <code>gorm.Model</code> 字段（如使用 <code>db.First(&amp;user)</code> 单独对 user 表查询 ），那么可以使用 <code>Association</code>，比如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>user</span> <span class=nx>User</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span> <span class=c1>// 只有user的数据，没有language的数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>laguages</span> <span class=p>[]</span><span class=nx>Language</span>
</span></span><span class=line><span class=cl><span class=nx>_</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Languages&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>languages</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>language</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>laguages</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>language</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=自定义表名>自定义表名</h2><p>前面我们都是使用 GORM 自动根据结构体创建的蛇形表名，实际上表名也可以自定义。自定义表名通常有两种情况：</p><ol><li>我们自己定义表名是什么</li><li>统一的给所有的表名加上一个前缀</li></ol><p>在 GORM 中可以通过给某一个 struct 添加 <code>TableName</code> 方法来自定义表名：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>User</span><span class=p>)</span> <span class=nf>TableName</span><span class=p>()</span> <span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s>&#34;my_user&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>如果想统一给所有表名都加上前缀，则可以在打开数据库时传入 <code>NamingStrategy</code> 参数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>mysql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>dsn</span><span class=p>),</span> <span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>NamingStrategy</span><span class=p>:</span><span class=nx>schema</span><span class=p>.</span><span class=nx>NamingStrategy</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>TablePrefix</span><span class=p>:</span> <span class=s>&#34;mxshop_&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>Logger</span><span class=p>:</span> <span class=nx>newLogger</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><blockquote><p>需要注意，<code>TableName</code> 和 <code>NamingStrategy</code> 不能同时生效，<code>TableName</code> 优先级更大。</p></blockquote><h2 id=before-create>Before Create</h2><p><a href=https://gorm.io/zh_CN/docs/hooks.html>Hook | GORM</a></p><p>有一种需求，比如在下方的表结构中，我们希望每个记录创建的时候自动加上当前时间，即加入到 AddTime 中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>AddTime</span> <span class=nx>sql</span><span class=p>.</span><span class=nx>NullTime</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><blockquote><p><code>AddTime</code> 使用 <code>sql.NullTime</code> 而不使用 <code>time.time</code> 的原因同样在于防止未传值导致零值报错问题。<a href=#%E9%9B%B6%E5%80%BC%E6%9B%B4%E6%96%B0%E9%97%AE%E9%A2%98>零值更新问题</a></p></blockquote><p>这时我们可以使用 <code>BeforeCreate</code> 这个钩子，除此之外还有 <code>AfterCreate</code>，同理保存、更新、删除都有类似的钩子方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>BeforeCreate</span><span class=p>(</span><span class=nx>tx</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nx>u</span><span class=p>.</span><span class=nx>AddTime</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=完整示例代码>完整示例代码</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;gorm.io/driver/mysql&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;gorm.io/gorm&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;gorm.io/gorm/logger&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 增删改查
</span></span></span><span class=line><span class=cl><span class=c1>// type User struct {
</span></span></span><span class=line><span class=cl><span class=c1>//     gorm.Model
</span></span></span><span class=line><span class=cl><span class=c1>//     Name string
</span></span></span><span class=line><span class=cl><span class=c1>//     Age  uint
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Belongs TO
</span></span></span><span class=line><span class=cl><span class=c1>// type User struct {
</span></span></span><span class=line><span class=cl><span class=c1>//     gorm.Model
</span></span></span><span class=line><span class=cl><span class=c1>//     Name      string
</span></span></span><span class=line><span class=cl><span class=c1>//     CompanyID int
</span></span></span><span class=line><span class=cl><span class=c1>//     Company   Company
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// type Company struct {
</span></span></span><span class=line><span class=cl><span class=c1>//     ID   int
</span></span></span><span class=line><span class=cl><span class=c1>//     Name string
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Has Many
</span></span></span><span class=line><span class=cl><span class=c1>// type User struct {
</span></span></span><span class=line><span class=cl><span class=c1>//     gorm.Model
</span></span></span><span class=line><span class=cl><span class=c1>//     Name       string
</span></span></span><span class=line><span class=cl><span class=c1>//     CreditCart []CreditCart
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// type CreditCart struct {
</span></span></span><span class=line><span class=cl><span class=c1>//     gorm.Model
</span></span></span><span class=line><span class=cl><span class=c1>//     Number string
</span></span></span><span class=line><span class=cl><span class=c1>//     UserID uint
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Many To Many
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Languages</span> <span class=p>[]</span><span class=nx>Language</span> <span class=s>`gorm:&#34;many2many:user_languages;&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Language</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>gorm</span><span class=p>.</span><span class=nx>Model</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`gorm:&#34;index:,unique&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>dsn</span> <span class=o>:=</span> <span class=s>&#34;root:123456@tcp(192.168.101.134:3306)/gorm_test?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>newlogger</span> <span class=o>:=</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stdout</span><span class=p>,</span> <span class=s>&#34;\r\n&#34;</span><span class=p>,</span> <span class=nx>log</span><span class=p>.</span><span class=nx>LstdFlags</span><span class=p>),</span> <span class=c1>// io writer
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>logger</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>SlowThreshold</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=c1>// Slow SQL threshold
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>LogLevel</span><span class=p>:</span>      <span class=nx>logger</span><span class=p>.</span><span class=nx>Info</span><span class=p>,</span> <span class=c1>// Log level
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>Colorful</span><span class=p>:</span>      <span class=kc>true</span><span class=p>,</span>        <span class=c1>// Disable color
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gorm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>mysql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>dsn</span><span class=p>),</span> <span class=o>&amp;</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Logger</span><span class=p>:</span> <span class=nx>newlogger</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建记录
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.AutoMigrate(&amp;User{})
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// users := []User{
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     {Name: &#34;liuchao1&#34;, Age: 19},
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     {Name: &#34;liuchao2&#34;, Age: 20},
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     {Name: &#34;liuchao3&#34;, Age: 21},
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.Create(&amp;users)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// 查询记录
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// var user User
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// var users []User
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.First(&amp;user, &#34;age = ?&#34;, &#34;21&#34;) // 查询id为1的user
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(user.ID, user.Name, user.Age)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.Where(&#34;age = ?&#34;, &#34;21&#34;).First(&amp;user)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(user.ID, user.Name, user.Age)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.Where(&amp;User{Name: &#34;liuchao3&#34;}).First(&amp;users)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(user.ID, user.Name, user.Age)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.Where(map[string]interface{}{&#34;name&#34;: &#34;liuchao2&#34;}).Find(&amp;users)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// for _, user := range users {
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     fmt.Println(user.ID, user.Name, user.Age)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// 更新记录
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.Model(&amp;User{}).Where(&#34;name = ?&#34;, &#34;liuchao1&#34;).Update(&#34;age&#34;, 100)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.Model(&amp;User{}).Where(&#34;id = ?&#34;, &#34;1&#34;).Updates(User{Name: &#34;liuchao5&#34;, Age: 200})
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// 删除记录
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.Delete(&amp;User{}, []int{4, 5, 6, 7})
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.Where(&#34;age &lt; ?&#34;, 100).Delete(&amp;User{})
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Belongs TO
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.AutoMigrate(&amp;User{}, &amp;Company{})
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.Create(&amp;[]User{
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     {Name: &#34;liuchao1&#34;, Company: Company{Name: &#34;company1&#34;}},
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     {Name: &#34;liuchao2&#34;, Company: Company{Name: &#34;company2&#34;}},
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     {Name: &#34;liuchao3&#34;, Company: Company{Name: &#34;company3&#34;}},
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// })
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// var user User
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.Preload(&#34;Company&#34;).First(&amp;user, 1)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(user.Name, user.Company.Name)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.Joins(&#34;Company&#34;).First(&amp;user, 2)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(user.Name, user.Company.Name)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Has Many
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.AutoMigrate(&amp;User{}, &amp;CreditCart{})
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.Create(&amp;[]User{
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     {Name: &#34;liuchao1&#34;, CreditCart: []CreditCart{{Number: &#34;123456&#34;}, {Number: &#34;654321&#34;}}},
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     {Name: &#34;liuchao2&#34;, CreditCart: []CreditCart{{Number: &#34;abcdef&#34;}, {Number: &#34;fedcba&#34;}}},
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     {Name: &#34;liuchao3&#34;, CreditCart: []CreditCart{{Number: &#34;qwerty&#34;}, {Number: &#34;ytrewq&#34;}}},
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// })
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// var user User
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.Preload(&#34;CreditCart&#34;).First(&amp;user)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// for _, cart := range user.CreditCart {
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     fmt.Println(user.Name, cart.Number, cart.UserID)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Many To Many
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.AutoMigrate(&amp;User{}, &amp;Language{})
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// db.Create(&amp;[]User{
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     {Name: &#34;liuchao1&#34;, Languages: []Language{{Name: &#34;chinese&#34;}, {Name: &#34;english&#34;}}},
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     {Name: &#34;liuchao2&#34;, Languages: []Language{{Name: &#34;chinese&#34;}, {Name: &#34;japanese&#34;}}},
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     {Name: &#34;liuchao3&#34;, Languages: []Language{{Name: &#34;chinese&#34;}, {Name: &#34;korean&#34;}}},
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     {Name: &#34;liuchao4&#34;, Languages: []Language{{Name: &#34;english&#34;}, {Name: &#34;french&#34;}}},
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// })
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>user</span> <span class=nx>User</span>
</span></span><span class=line><span class=cl>    <span class=c1>// db.Preload(&#34;Languages&#34;).First(&amp;user)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// for _, language := range user.Languages{
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//     fmt.Println(language.Name)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>db</span><span class=p>.</span><span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>languages</span> <span class=p>[]</span><span class=nx>Language</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Model</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>).</span><span class=nf>Association</span><span class=p>(</span><span class=s>&#34;Languages&#34;</span><span class=p>).</span><span class=nf>Find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>languages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>language</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>languages</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>language</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>BeforeCreate</span><span class=p>(</span><span class=nx>tx</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Languages</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>lang</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>u</span><span class=p>.</span><span class=nx>Languages</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>tx</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=nx>Language</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>lang</span><span class=p>.</span><span class=nx>Name</span><span class=p>}).</span><span class=nf>FirstOrCreate</span><span class=p>(</span><span class=nx>lang</span><span class=p>).</span><span class=nx>Error</span><span class=p>;</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></article><div class=paginator><a class=link href=https://blog.pi3.fun/post/2025/03/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/>← prev</a>
<a class=link href=https://blog.pi3.fun/post/2025/03/go%E8%AF%AD%E8%A8%80import%E6%9C%AC%E5%9C%B0%E5%8C%85%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F/>next →</a></div><div class=comment><div id=tcomment></div><script src=https://registry.npmmirror.com/twikoo/1.6.39/files/dist/twikoo.min.js></script><script async>twikoo.init({envId:"https://twikoo.pi3.fun/.netlify/functions/twikoo",el:"#tcomment",lang:"zh-CN"})</script></div></main><footer id=footer><div><span style=display:flex;align-items:center><span style=margin-right:.5rem>© 2021 - 2025</span><img src=https://cdn.pi3.fun/static/rainbow.gif loading=lazy width=20 alt=rainbow><span style=margin-left:.5rem>By Liu Chao</span></span></div><div class=footnote><span><a href=https://www.foreverblog.cn/ target=_blank><img src=https://img.foreverblog.cn/logo_en_default.png style=width:auto;height:16px></a> | <a class=link href=https://blogscn.fun/ target=_blank><img src=https://photo.xiangming.site/img/blogscn.png style=width:auto;height:15px></a><br><a class=link href=/index.xml><span class="iconfont icon-RSS"></span></a> | <a class=link href=https://github.com/Pi3-l22 target=_ blank><span class="iconfont icon-GitHub"></span></a> | <a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener><span class="iconfont icon-creative-commons-fill"></span></a></span></div><div class=blog-icon></div></footer></div><script>document.addEventListener("DOMContentLoaded",function(){const n=localStorage.getItem("theme")||"light",e=document.querySelector('link[data-theme-style="light"]'),t=document.querySelector('link[data-theme-style="dark"]'),i=window.matchMedia("(prefers-color-scheme: dark)");i.addListener(function(n){if(!localStorage.getItem("theme")){const s=n.matches?"dark":"light";document.documentElement.setAttribute("data-theme",s),localStorage.setItem("theme",s),s==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");const o=document.querySelector("iframe.giscus-frame");if(o){const e=s==="light"?"light_tritanopia":"dark_tritanopia";o.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}}}),n==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");function o(){const e=document.querySelector("iframe.giscus-frame");if(e){const t=n==="light"?"light_tritanopia":"dark_tritanopia";e.contentWindow.postMessage({giscus:{setConfig:{theme:t}}},"https://giscus.app")}else setTimeout(o,1e3)}o();const s=document.querySelector(".theme-toggle");s&&(s.textContent=n==="light"?"黑暗":"明亮",s.addEventListener("click",function(){const o=document.documentElement.getAttribute("data-theme"),n=o==="light"?"dark":"light";document.documentElement.setAttribute("data-theme",n),localStorage.setItem("theme",n),n==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");const s=document.querySelector("iframe.giscus-frame");if(s){const e=n==="light"?"light_tritanopia":"dark_tritanopia";s.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}this.textContent=n==="light"?"黑暗":"明亮"}))})</script><script src=https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){confetti({particleCount:150,spread:100})})</script></body></html>