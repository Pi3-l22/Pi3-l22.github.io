<!doctype html><html lang=zh-cn><head><script>(function(){const e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)})()</script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=author content="LiuChao"><meta name=description content="gRPC进阶学习笔记"><link rel=icon href=https://blog.pi3.fun/favicon.ico><meta name=keywords content=" study  latex  life  academic "><meta property="og:url" content="https://blog.pi3.fun/post/2025/02/grpc-notes-advanced/"><meta property="og:site_name" content="Pi3's Notes"><meta property="og:title" content="gRPC进阶学习"><meta property="og:description" content="gRPC进阶学习笔记"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2025-02-28T00:00:00+00:00"><meta property="article:modified_time" content="2025-02-28T00:00:00+00:00"><meta property="article:tag" content="技术"><meta property="article:tag" content="Golang"><meta property="article:tag" content="GRPC"><link rel=canonical href=https://blog.pi3.fun/post/2025/02/grpc-notes-advanced/><meta itemprop=name content="gRPC进阶学习"><meta itemprop=description content="gRPC进阶学习笔记"><meta itemprop=datePublished content="2025-02-28T00:00:00+00:00"><meta itemprop=dateModified content="2025-02-28T00:00:00+00:00"><meta itemprop=wordCount content="9372"><meta itemprop=keywords content="技术,Golang,GRPC"><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/common.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/content.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/theme.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/iconfont/iconfont.css><link rel=stylesheet href=https://blog.pi3.fun/css/syntax/xcode.css data-theme-style=light media="(prefers-color-scheme: light)"><link rel=stylesheet href=https://blog.pi3.fun/css/syntax/catppuccin-mocha.css data-theme-style=dark media="not all"><title>gRPC进阶学习 - Pi3's Notes</title>
<link rel=stylesheet href=https://blog.pi3.fun/css/single.css><link href=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/katex.min.css rel=stylesheet><script defer src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/katex.min.js></script><script defer src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}],ignoredTags:["script","noscript","style","textarea","pre","code","option"],throwOnError:!1})})</script></head><body><div id=wrapper><header id=header><link rel=stylesheet href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Regular/result.css><link rel=stylesheet href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Italic/result.css><link rel=stylesheet href=https://chinese-fonts-cdn.deno.dev/packages/maple-mono-cn/dist/MapleMono-CN-Regular/result.css><h1><a href=https://blog.pi3.fun/>Pi3's Notes</a></h1><nav><span class=nav-bar-item><a class=link href=/>文章</a>
</span><span class=nav-bar-item><a class=link href=https://www.boyouquan.com/planet-shuttle>穿梭</a>
</span><span class=nav-bar-item><a class=link href=/about/>关于</a>
</span><span class=nav-bar-item><a class=link href=/links/>友链</a>
</span><span class=nav-bar-item><a class="link theme-toggle" href=javascript:void(0);>黑暗</a></span></nav></header><main id=main class=post><h1>gRPC进阶学习</h1><div><b>Keywords: </b><a class=link href=https://blog.pi3.fun/tags/%E6%8A%80%E6%9C%AF>#技术</a>
<a class=link href=https://blog.pi3.fun/tags/golang>#Golang</a>
<a class=link href=https://blog.pi3.fun/tags/grpc>#gRPC</a></div><div><b>Release Date: </b><span>2025-02-28</span></div><details><summary><b>Table of Contents</b></summary><div class=toc><nav id=TableOfContents><ul><li><a href=#protobuf-进阶知识>protobuf 进阶知识</a><ul><li><a href=#基础类型与默认值>基础类型与默认值</a></li><li><a href=#option-package-的作用>option package 的作用</a></li><li><a href=#proto-文件同步的问题>proto 文件同步的问题</a></li><li><a href=#proto-文件相互导入>proto 文件相互导入</a></li><li><a href=#嵌套-message-对象>嵌套 message 对象</a></li><li><a href=#enum-枚举类型>enum 枚举类型</a></li><li><a href=#map-类型>map 类型</a></li><li><a href=#timestamp-类型>timestamp 类型</a></li><li><a href=#protoc-生成的源码阅读>protoc 生成的源码阅读</a></li></ul></li><li><a href=#grpc-进阶知识>gRPC 进阶知识</a><ul><li><a href=#metadata-机制>metadata 机制</a></li><li><a href=#grpc-拦截器>gRPC 拦截器</a></li><li><a href=#metadata--拦截器的应用>metadata + 拦截器的应用</a></li><li><a href=#grpc-验证器>gRPC 验证器</a></li><li><a href=#grpc-异常处理>gRPC 异常处理</a></li><li><a href=#grpc-超时机制>gRPC 超时机制</a></li></ul></li></ul></nav></div></details><article class=content><p>gRPC 进阶学习知识点笔记</p><h2 id=protobuf-进阶知识>protobuf 进阶知识</h2><p>官方文档： <a href=https://developers.google.com/protocol-buffers/docs/proto3>https://developers.google.com/protocol-buffers/docs/proto3</a></p><h3 id=基础类型与默认值>基础类型与默认值</h3><p>以下是 protobuf 与 Go 的基础类型对照表：</p><table><thead><tr><th>proto Type</th><th>Notes</th><th>Go Type</th></tr></thead><tbody><tr><td>double</td><td></td><td>float 64</td></tr><tr><td>float</td><td></td><td>float 32</td></tr><tr><td>int 32</td><td>使用变长编码，对于负值的效率很低，如果你的域有可能有负值，请使用 sint 64 替代</td><td>int 32</td></tr><tr><td>uint 32</td><td>使用变长编码</td><td>uint 32</td></tr><tr><td>uint 64</td><td>使用变长编码</td><td>uint 64</td></tr><tr><td>sint 32</td><td>使用变长编码，这些编码在负值时比 int 32 高效的多</td><td>int 32</td></tr><tr><td>sint 64</td><td>使用变长编码，有符号的整型值。编码时比通常的 int 64 高效。</td><td>int 64</td></tr><tr><td>fixed 32</td><td>总是 4 个字节，如果数值总是比总是比 228 大的话，这个类型会比 uint 32 高效。</td><td>uint 32</td></tr><tr><td>fixed 64</td><td>总是 8 个字节，如果数值总是比总是比 256 大的话，这个类型会比 uint 64 高效。</td><td>uint 64</td></tr><tr><td>sfixed 32</td><td>总是 4 个字节</td><td>int 32</td></tr><tr><td>sfixed 64</td><td>总是 8 个字节</td><td>int 64</td></tr><tr><td>bool</td><td></td><td>bool</td></tr><tr><td>string</td><td>一个字符串必须是 UTF-8 编码或者 7-bit ASCII 编码的文本。</td><td>string</td></tr><tr><td>bytes</td><td>可能包含任意顺序的字节数据。</td><td>[]byte</td></tr></tbody></table><p>其对应的默认值为：</p><ul><li>对于 strings，默认是一个空 string</li><li>对于 bytes，默认是一个空的 bytes</li><li>对于 bools，默认是 false</li><li>对于数值类型，默认是 0</li><li>对于枚举，默认是第一个定义的枚举值，必须为 0;- 对于消息类型（message），域没有被设置，确切的消息是根据语言确定的，详见 <a href="https://developers.google.com/protocol-buffers/docs/reference/overview?hl=zh-cn">generated code guide</a></li><li>对于可重复域的默认值是空（通常情况下是对应语言中空列表）。</li></ul><p><strong class=chinese>注意</strong>：对于标量消息域，一旦消息被解析，就无法判断域释放被设置为默认值（例如，例如 boolean 值是否被设置为 false）还是根本没有被设置。你应该在定义你的消息类型时非常注意。</p><h3 id=option-package-的作用>option package 的作用</h3><p>对于 proto 文件中 <code>option go_package=".;proto";</code> 作用，它指定了生成的 Go 语言文件的存放路径（<code>.</code> 代表当前目录）与包名（<code>proto</code> 代表 <code>package proto</code>）。</p><p>比如，我想在 <code>./common/stream/proto/v1</code> 生成对应的 Go 语言文件，则可以编写：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=k>option</span> <span class=n>go_package</span><span class=o>=</span><span class=s>&#34;./common/stream/proto/v1;proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span></code></pre></div><p><strong class=chinese>注意</strong>：如果没有指定包名，则默认使用最近一级的目录名称。比如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=k>option</span> <span class=n>go_package</span><span class=o>=</span><span class=s>&#34;./common/stream/proto/v1&#34;</span><span class=p>;</span><span class=err>
</span></span></span></code></pre></div><p>其生成的 Go 语言文件的包名为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>v1</span>
</span></span></code></pre></div><h3 id=proto-文件同步的问题>proto 文件同步的问题</h3><p>当我们的一个项目比较大时，有好多服务需要使用到 proto 生成的接口，就像上方的例子中的那样，服务端和客户端都需要使用到这个接口，那么我们应该如何处理？</p><p>在上面的处理方式中，我们是建立了一个单独的 proto 文件夹，让服务端和客户端都可以访问到这个文件夹。</p><p>但是如果项目比较大的话，比如服务端和客户端在两台不同的服务器上，它们需要使用相同的 proto 文件生成的接口，那么此时最好的办法就是将 proto 文件复制一份，就可以在两边都使用上相同的接口。</p><p>然而与此同时，就会出现了另外一个问题，<strong>proto 文件同步的问题</strong>。如果 proto 文件在复制的过程中，不小心被修改了，导致两个 proto 文件并不完全一致，比如以下这种情况</p><p>在服务端的 proto 文件中，name 字段序号为 1，url 字段序号为 2：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=kd>message</span> <span class=nc>HelloRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>url</span> <span class=o>=</span><span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p>而在客户端的 proto 文件中，name 字段序号被改为 2，url 字段序号改为 1：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=kd>message</span> <span class=nc>HelloRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>url</span> <span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p>那么此时，运行两边的程序不会报错，但是服务端和客户端的相互通信就会出现问题，name 和 url 的值会被<strong class=chinese>互换</strong>。</p><p>这是由于 protobuf 的编码顺序格式，一定要注意 proto 文件中字段 <code>=</code> 后方代表的是<strong>序号（编号）</strong>，需要保证相同文件中字段序号的一致性。这与 Json 中的 key-value 模式有着明显不同，这是为了缩短编码长度。</p><h3 id=proto-文件相互导入>proto 文件相互导入</h3><p>在很大的项目中，一个 proto 文件中可能会有很多的 message，并且不同的 proto 文件中的 message 可能通用，因此就需要将另外通用的 message 通过导入的方式来使用，减少 proto 文件的代码量。</p><p>比如在项目中，我们常常需要一个接口用于检测服务是否可用，我们就可以在 proto 文件中定义一个 Ping 方法接口，返回 Pong 的 message。</p><p>所以，我们可以将所有公用的 message 都写在一个 proto 文件中，在其他需要该 message 的 proto 中引入该文件。</p><p>比如下面是一个 <code>hello.proto</code> 文件设置了一个 Ping 方法接口，需要使用到 Empty 和 Pong 的 message，这两个 message 存放在公用的 <code>base.proto</code> 文件中。</p><p><code>hello.proto</code> ：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>import</span> <span class=s>&#34;base.proto&#34;</span><span class=p>;</span> <span class=c1>// 引入公用的Empty和Pong message
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;.;proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>service</span> <span class=n>Greeter</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>SayHello</span> <span class=p>(</span><span class=n>HelloRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>HelloReply</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>Ping</span> <span class=p>(</span><span class=n>Empty</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>Pong</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>HelloRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>HelloReply</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=kd>message</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p><code>base.proto</code> ：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Pong</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>id</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Empty</span> <span class=p>{</span> <span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p>由于方法必须要有一个参数传入，所以我们需要创建一个空的 message <code>Empty</code>。</p><p>实际上官方也提供了一个 Empty 的 message，只需要通过 <code>import "google/protobuf/empty.proto"</code> 引入（会下载到本地 protoc 根目录的 <code>include</code> 文件夹中），通过 <code>google.protobuf.Empty</code> 在 proto 文件中使用。并且在 Go 语言文件中 <code>import github.com/golang/protobuf/ptypes/empty</code> 引入，通过 <code>empty.Empty</code> 在 Go 语言文件中使用该生成后的结构体。</p><p><code>google/protobuf</code> 也提供了很多其他公用的 message，可以阅读源码得知。</p><p>这时其他服务中也需要一个 Ping 方法用于检测服务是否连通，则无需再重复写这两个 message，同样将上方的 <code>base.proto</code> 文件使用 <code>import</code> 引入其中即可。</p><p><strong class=chinese>值得注意的是</strong>，如果需要在 Go 语言代码中使用外部引入的 message，如上面例子中的 <code>Pong</code> ，则依旧需要通过 protoc 指令将 <code>base.proto</code> 生成 Go 语言代码，并在程序中引入这个文件。</p><blockquote><p>如果 <code>base.proto</code> 和 <code>hello.proto</code> 文件生成的 <code>base.pb.go</code>（<code>base_grpc.pb.go</code>） 和 <code>hello.pb.go</code> （<code>hello_grpc.pb.go</code>） 文件在同一个目录中，则需要保持其 <code>package</code> 一致，同时在使用时只需要引入这个包，就可以同时访问到这两个 Go 语言文件，这是 Go 的包管理方式决定的。</p></blockquote><p>如果需要导入的 proto 文件不在当前目录，则可以选择将其拷贝到当前目录中，这是常见的方式。另一种可行的方式，就是通过在 protoc 生成指令中使用 <code>--proto_path</code> 或 <code>-I</code> 参数来指定 proto 文件的目录，该参数可以有多个，比如常见方式为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>protoc -I . -I D://tmp/proto ……
</span></span></code></pre></div><p>但是，这样的方式，不利于项目的共享，因此大型项目，依旧推荐将所有用到的 proto 文件都放置在一个统一的文件夹中。</p><p>同时，通常建议的方式是将 <code>--proto_path</code> / <code>-I</code> 参数设置为项目的根目录，而 <code>.proto </code>文件中的 <code>import</code> 则从根目录的次级目录开始。</p><h3 id=嵌套-message-对象>嵌套 message 对象</h3><p>proto 为了满足复杂的 message 类型，同时减少 message 的数量，可以支持 message 的嵌套，比如以下的例子：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>import</span> <span class=s>&#34;base.proto&#34;</span> <span class=c1>// 引入公用的Empty和Pong message
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;.;proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>service</span> <span class=n>Greeter</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>SayHello</span> <span class=p>(</span><span class=n>HelloRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>HelloReply</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>Ping</span> <span class=p>(</span><span class=n>Empty</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>Pong</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>HelloRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>HelloReply</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=kd>message</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kd>message</span> <span class=nc>Result</span> <span class=p>{</span> <span class=c1>// 嵌套的message
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=kt>string</span> <span class=n>url</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>repeated</span> <span class=n>Result</span> <span class=n>data</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p>需要注意的是，嵌套的 message 的序号依旧是独立的，不会互相影响。</p><p>同时，在 Go 语言中调用和实例化 Result，则需要使用以下方式来访问。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>proto</span><span class=p>.</span><span class=nx>HelloReply_Result</span><span class=p>{}</span>
</span></span></code></pre></div><h3 id=enum-枚举类型>enum 枚举类型</h3><p>proto 也是支持枚举类型的，使用方式如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;.;proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>service</span> <span class=n>Greeter</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>SayHello</span> <span class=p>(</span><span class=n>HelloRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>HelloReply</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>enum</span> <span class=n>Gender</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>MALE</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>FEMALE</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>HelloRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>url</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>Gender</span> <span class=n>g</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>HelloReply</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=kd>message</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p>只需要使用 <code>enum</code> 关键字定义一个枚举类型，在 message 中使用即可。</p><p>使用 protoc 命令生成 Go 文件后，<code>enum</code> 枚举类型会变为一个 <code>int32</code> 的类型，并且其中的类别会变为一个常量，如上方的 proto 文件转成 Go 语言代码会变为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Gender</span> <span class=kt>int32</span>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>Gender_MALE</span> <span class=nx>Gender</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=nx>Gender_FEMALE</span> <span class=nx>Gender</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>因此，我们使用的时候可以使用以下的方式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>proto</span><span class=p>.</span><span class=nx>Gender_MALE</span>
</span></span><span class=line><span class=cl><span class=nx>proto</span><span class=p>.</span><span class=nx>Gender_FEMALE</span>
</span></span></code></pre></div><h3 id=map-类型>map 类型</h3><p>proto 文件中的 map 类型使用方法如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;.;proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>service</span> <span class=n>Greeter</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>SayHello</span> <span class=p>(</span><span class=n>HelloRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>HelloReply</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>HelloRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>url</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>map</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>,</span> <span class=kt>string</span><span class=p>&gt;</span> <span class=n>mp</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>HelloReply</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=kd>message</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p>map 类型需要指定 key 和 value 的类型，这与其他静态语言类似。</p><p>在生成 Go 语言之后，map 类型会自动转换为 Go 中的 map 类型，如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>Mp</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span>
</span></span></code></pre></div><p>在使用时，就与 Go 语言的 map 类型使用方式一样，传递时也只需要转递 map 类型：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>rsp</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>SayHello</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span><span class=o>&amp;</span><span class=nx>proto</span><span class=p>.</span><span class=nx>HelloRequest</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;bobby&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Url</span><span class=p>:</span> <span class=s>&#34;https://baidu.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Mp</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;bobby&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;url&#34;</span><span class=p>:</span> <span class=s>&#34;https://baidu.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p>虽然 map 类型也可以存放像上方的 name 和 url 等信息，但是我们却并不推荐大量使用 map 类型，因为 proto 文件在项目开发中，大多扮演着<strong class=chinese>开发文档</strong>的角色，以上 name 和 url 在 proto 文件中都有明确的定义，同时也可以写一些注释作为文档。但是对于 map 中的各种 key-value 在 proto 中并没有规定，可以随意书写，只需保证类型一致，开发者不知道这个 map 中会传什么值，<strong class=chinese>这样不对的</strong>。</p><h3 id=timestamp-类型>timestamp 类型</h3><p>proto 中也扩展了 timestamp 时间戳类型，这样的类型并没有内置，而是需要通过引入官方提供的 proto 文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=k>import</span> <span class=s>&#34;google/protobuf/timestamp.proto&#34;</span><span class=err>
</span></span></span></code></pre></div><p>使用时同样需要像上方 <a href=#proto%20%E6%96%87%E4%BB%B6%E7%9B%B8%E4%BA%92%E5%AF%BC%E5%85%A5>proto 文件相互导入</a>中讲解的那样，引入完整的路径：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>import</span> <span class=s>&#34;google/protobuf/timestamp.proto&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;.;proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>service</span> <span class=n>Greeter</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>SayHello</span> <span class=p>(</span><span class=n>HelloRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>HelloReply</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>HelloRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>url</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>map</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>,</span> <span class=kt>string</span><span class=p>&gt;</span> <span class=n>mp</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>google.protobuf.Timestamp</span> <span class=n>addTime</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>HelloReply</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=kd>message</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p>由于导入了外部的 proto 文件，因此在 Go 中使用 proto 中的内容，不仅需要引入上方这段代码生成的 Go 文件，还需要引入 <code>"google/protobuf/timestamp.proto"</code> 生成的 Go 文件，那么如何找到它生成的 Go 源码路径呢？</p><p>可以通过进入 <code>google/protobuf/timestamp.proto</code> 文件中，根据 <code>option go_package</code> 后的路径找到生成的源码路径。因此我们可以找到路径为 <code>github.com/golang/protobuf/ptypes/timestamp</code>。</p><p>通过 <code>github.com/golang/protobuf/ptypes/timestamp</code> 打开源码 <code>timestamp.pb.go</code> 发现其中又引入了 <code>google.golang.org/protobuf/types/known/timestamppb</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=err>……</span>
</span></span><span class=line><span class=cl>    <span class=nx>timestamppb</span> <span class=s>&#34;google.golang.org/protobuf/types/known/timestamppb&#34;</span>
</span></span><span class=line><span class=cl>    <span class=err>……</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Timestamp</span> <span class=p>=</span> <span class=nx>timestamppb</span><span class=p>.</span><span class=nx>Timestamp</span>
</span></span></code></pre></div><p>因此再打开 <code>timestamppb</code> 的源码 <code>timestamppb.pb.go</code>，发现其中有实例化 timestamp 的 New 方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// New constructs a new Timestamp from the provided time.Time.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>New</span><span class=p>(</span><span class=nx>t</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>)</span> <span class=o>*</span><span class=nx>Timestamp</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=o>&amp;</span><span class=nx>Timestamp</span><span class=p>{</span><span class=nx>Seconds</span><span class=p>:</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nf>Unix</span><span class=p>()),</span> <span class=nx>Nanos</span><span class=p>:</span> <span class=nb>int32</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nf>Nanosecond</span><span class=p>())}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>因此，在我们的 Go 文件中可以直接引入这个包，通过这个方法来使用 timestamp，使用方式如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=err>……</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>timestamppb</span> <span class=s>&#34;google.golang.org/protobuf/types/known/timestamppb&#34;</span>
</span></span><span class=line><span class=cl>    <span class=err>……</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>……</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>rsp</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>SayHello</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span><span class=o>&amp;</span><span class=nx>proto</span><span class=p>.</span><span class=nx>HelloRequest</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;bobby&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Url</span><span class=p>:</span> <span class=s>&#34;https://baidu.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Mp</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;bobby&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;url&#34;</span><span class=p>:</span> <span class=s>&#34;https://baidu.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>AddTime</span><span class=p>:</span> <span class=nx>timestamppb</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><h3 id=protoc-生成的源码阅读>protoc 生成的源码阅读</h3><p>上述学习了许多关于 protobuf 的知识，最终我们的目标是希望通过 protobuf 这个工具，帮助我们快捷地生成各种语言，方便使用的代码。</p><p>那么具体 protoc 生成的 Go 源码中，到底写了些什么代码呢？</p><p>回顾 RPC 架构技术要点，server 端最好帮助我们生成好接口，我们只需要去每个接口中实现对应的业务逻辑即可。同时，client 端最好帮助我们生成对应的方法，并且将这个方法都绑定到一个结构体上，生成的时候</p><p>比如，我们编写了一个 <code>helloworld.proto</code> 文件，内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;.;proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>service</span> <span class=n>Greeter</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>SayHello</span> <span class=p>(</span><span class=n>HelloRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>HelloReply</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>HelloRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>HelloReply</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=kd>message</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p>这其中定义了一个 <code>SayHello</code> 的 rpc 方法（<code>Greeter</code> 是一个方法集），以及 <code>HelloRequest</code> 和 <code>HelloReply</code> 两个 message。</p><p>那么当我们使用 protoc 根据这个 proto 文件生成对应的 Go 文件，它们会转换成什么呢？</p><p>事实上，message 会变为 Go 的结构体，方法集会变为 Go 的接口，而 rpc 方法会称为该接口中的方法。</p><p>我们使用以下命令来生成 <code>helloworld.pb.go</code> 和 <code>helloworld_grpc.pb.go</code> 文件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>protoc</span> <span class=o>-</span><span class=nx>I</span> <span class=p>.</span> <span class=o>--</span><span class=nx>go_out</span><span class=p>=.</span> <span class=o>--</span><span class=k>go</span><span class=o>-</span><span class=nx>grpc_out</span><span class=p>=</span><span class=nx>require_unimplemented_servers</span><span class=p>=</span><span class=kc>false</span><span class=p>:.</span> <span class=p>.</span><span class=err>\</span><span class=nx>helloworld</span><span class=p>.</span><span class=nx>proto</span>
</span></span></code></pre></div><p>在 <code>helloworld.pb.go</code> 中，可以找到 <code>HelloRequest</code> 和 <code>HelloReply</code> 结构体：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>HelloRequest</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>state</span>         <span class=nx>protoimpl</span><span class=p>.</span><span class=nx>MessageState</span> <span class=s>`protogen:&#34;open.v1&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span>          <span class=kt>string</span>                 <span class=s>`protobuf:&#34;bytes,1,opt,name=name,proto3&#34; json:&#34;name,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>unknownFields</span> <span class=nx>protoimpl</span><span class=p>.</span><span class=nx>UnknownFields</span>
</span></span><span class=line><span class=cl>    <span class=nx>sizeCache</span>     <span class=nx>protoimpl</span><span class=p>.</span><span class=nx>SizeCache</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>HelloReply</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>state</span>         <span class=nx>protoimpl</span><span class=p>.</span><span class=nx>MessageState</span> <span class=s>`protogen:&#34;open.v1&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Message</span>       <span class=kt>string</span>                 <span class=s>`protobuf:&#34;bytes,1,opt,name=message,proto3&#34; json:&#34;message,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>unknownFields</span> <span class=nx>protoimpl</span><span class=p>.</span><span class=nx>UnknownFields</span>
</span></span><span class=line><span class=cl>    <span class=nx>sizeCache</span>     <span class=nx>protoimpl</span><span class=p>.</span><span class=nx>SizeCache</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>在 <code>helloworld_grpc.pb.go</code> 中，可以找到 <code>GreeterServer</code> 和 <code>GreeterClient</code> 接口和 <code>SayHello</code> 方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>GreeterClient</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>HelloRequest</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>HelloReply</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>GreeterServer</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>SayHello</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=o>*</span><span class=nx>HelloRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>HelloReply</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><blockquote><p>由于 client 端在调用 <code>SayHello()</code> 时可能会传递一些调用参数，因此与 server 端的接口方法并不一致。</p></blockquote><p>为了完成 RPC 方法的注册，代码中还生成了一个 <code>RegisterGreeterServer</code> 注册方法，方便我们使用。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>RegisterGreeterServer</span><span class=p>(</span><span class=nx>s</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>ServiceRegistrar</span><span class=p>,</span> <span class=nx>srv</span> <span class=nx>GreeterServer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>t</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.(</span><span class=kd>interface</span><span class=p>{</span> <span class=nf>testEmbeddedByValue</span><span class=p>()</span> <span class=p>});</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>t</span><span class=p>.</span><span class=nf>testEmbeddedByValue</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span><span class=p>.</span><span class=nf>RegisterService</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>Greeter_ServiceDesc</span><span class=p>,</span> <span class=nx>srv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>在 <code>helloworld_grpc.pb.go</code> 这个代码中，依旧蕴含着 Go 语言最关键的设计理念：<strong class=chinese>面向接口的编程</strong>，比如观察下面这段代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>GreeterClient</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>HelloRequest</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>HelloReply</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>greeterClient</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>cc</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientConnInterface</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewGreeterClient</span><span class=p>(</span><span class=nx>cc</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientConnInterface</span><span class=p>)</span> <span class=nx>GreeterClient</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>greeterClient</span><span class=p>{</span><span class=nx>cc</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>greeterClient</span><span class=p>)</span> <span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>HelloRequest</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>HelloReply</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>cOpts</span> <span class=o>:=</span> <span class=nb>append</span><span class=p>([]</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>{</span><span class=nx>grpc</span><span class=p>.</span><span class=nf>StaticMethod</span><span class=p>()},</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>out</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>HelloReply</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>cc</span><span class=p>.</span><span class=nf>Invoke</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>Greeter_SayHello_FullMethodName</span><span class=p>,</span> <span class=nx>in</span><span class=p>,</span> <span class=nx>out</span><span class=p>,</span> <span class=nx>cOpts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>out</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>在这段代码中，<code>NewGreeterClient</code> 用于新建一个 <code>greeterClient</code> 结构体对象，但是在标明返回值时，它却使用的是 <code>GreeterClient</code> 这一个接口类型，为什么呢？</p><p>因为，<code>greeterClient</code> 这个结构拥有一个 <code>SayHello()</code> 方法，即 <code>GreeterClient</code> 中定义的所有方法，因此这个结构体就实现了 <code>GreeterClient</code> 这也一个接口，所以 <code>NewGreeterClient</code> 函数中可以返回这个结构体实例。</p><p>这样<strong class=chinese>面向接口的编程</strong>是为了实现多态，也可以说是让代码编写更加灵活。只要是实现了 <code>GreeterClient</code> 接口的所有结构体都可以通过 <code>NewGreeterClient</code> 方法来获得一个实例对象。如果只是写为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewGreeterClient</span><span class=p>(</span><span class=nx>cc</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientConnInterface</span><span class=p>)</span> <span class=nx>greeterClient</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>greeterClient</span><span class=p>{</span><span class=nx>cc</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>那么只有这个结构体可以使用这个函数了。</p><h2 id=grpc-进阶知识>gRPC 进阶知识</h2><h3 id=metadata-机制>metadata 机制</h3><p>gRPC 让我们可以像本地调用一样实现远程调用，对于每一次的 RPC 调用中，都可能会有一些有用的数据，而这些数据就可以通过 metadata 来传递。</p><p>metadata 是以 key-value 的形式存储数据的，其中 key 是 <code>string</code> 类型，而 value 是 <code>[]string</code>，即一个字符串数组类型。</p><p>metadata 使得 client 和 server 能够为对方提供关于本次调用的一些信息，就像一次<strong>http 请求的 RequestHeader 和 ResponseHeader</strong> 一样。http 中 header 的生命周周期是一次 http 请求，那么 metadata 的生命周期就是一次 RPC 调用。</p><p>所以，gRPC 中的 metadata 就如同 http 中的 header，message 就如同 http 中的 post 数据。</p><p>同时，由于在 Web 开发中通过 http 的 header 可以传递 token、cookie、session 等认证信息，因此 gRPC 也可以利用 metadata 机制来实现 RPC 的<strong class=chinese>权限认证</strong>等功能。</p><p>那么在 gRPC 中如何使用 metadata 呢？</p><ul><li>源码：<a href=https://github.com/grpc/grpc-go/tree/master/metadata>源码</a></li><li>项目文档：<a href=https://github.com/grpc/grpc-go/blob/master/Documentation/grpc-metadata.md>文档</a></li></ul><p>metadata 类型实际上是 Go 中的 map 类型，key 是 <strong>string</strong>，value 是 <strong>string 类型的 slice</strong>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>MD</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>][]</span><span class=kt>string</span>
</span></span></code></pre></div><p>创建 metadata 时，可以像创建普通的 map 类型一样使用 new 关键字进行创建：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>//第一种方式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>md</span> <span class=o>:=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;key1&#34;</span><span class=p>:</span> <span class=s>&#34;val1&#34;</span><span class=p>,</span> <span class=s>&#34;key2&#34;</span><span class=p>:</span> <span class=s>&#34;val2&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>//第二种方式 key不区分大小写，会被统一转成小写。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>md</span> <span class=o>:=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nf>Pairs</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;key1&#34;</span><span class=p>,</span> <span class=s>&#34;val1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// &#34;key1&#34; will have map value []string{&#34;val1&#34;, &#34;val1-2&#34;}
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s>&#34;key1&#34;</span><span class=p>,</span> <span class=s>&#34;val1-2&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=s>&#34;key2&#34;</span><span class=p>,</span> <span class=s>&#34;val2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>发送 metadata 时可以使用以下方式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>md</span> <span class=o>:=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nf>Pairs</span><span class=p>(</span><span class=s>&#34;key&#34;</span><span class=p>,</span> <span class=s>&#34;val&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 新建一个有 metadata 的 context
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nf>NewOutgoingContext</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>md</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 单向 RPC
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>response</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>SomeRPC</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>someRequest</span><span class=p>)</span>
</span></span></code></pre></div><p>接收 metadata 时可以使用以下方式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>server</span><span class=p>)</span> <span class=nf>SomeRPC</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>SomeRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>SomeResponse</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>md</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nf>FromIncomingContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// do something with metadata
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><hr><p>接下来是 gRPC 的 metadata 的实际案例，首先同样在项目根目录创建三个文件夹，分别是 proto、client 和 server，对应三个模块功能。</p><p>我们依旧是以之前最简单的 gRPC 代码为例，加上 metadata 的使用。</p><p>首先创建一个 <code>proto/metadata.proto</code> 文件，编写以下内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;.;proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>service</span> <span class=n>Greeter</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>SayHello</span> <span class=p>(</span><span class=n>HelloRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>HelloReply</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>HelloRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>HelloReply</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=kd>message</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p>执行以下命令，生成对应的 Go 文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>protoc --go_out<span class=o>=</span>. --go-grpc_out<span class=o>=</span><span class=nv>require_unimplemented_servers</span><span class=o>=</span>false:. metadata.proto
</span></span></code></pre></div><p>创建一个 <code>client/client.go</code> 文件，编写以下内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>conn</span><span class=p>,</span><span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span><span class=s>&#34;127.0.0.1:8088&#34;</span><span class=p>,</span><span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span> <span class=o>:=</span> <span class=nx>proto</span><span class=p>.</span><span class=nf>NewGreeterClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建 metadata
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>md</span> <span class=o>:=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;name&#34;</span><span class=p>:</span><span class=s>&#34;bobby&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;pasword&#34;</span><span class=p>:</span><span class=s>&#34;123456&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 新建一个有 metadata 的 context
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nf>NewOutgoingContext</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>md</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>proto</span><span class=p>.</span><span class=nx>HelloRequest</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span><span class=s>&#34;bobby&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Message</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>最后创建一个 <code>server/server.go</code> 文件，编写以下内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Server</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>request</span> <span class=o>*</span><span class=nx>proto</span><span class=p>.</span><span class=nx>HelloRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>proto</span><span class=p>.</span><span class=nx>HelloReply</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 接收 metadata
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>md</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nf>FromIncomingContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;get metadata error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 输出切片中的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>nameSlice</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>md</span><span class=p>[</span><span class=s>&#34;name&#34;</span><span class=p>];</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>nameSlice</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nameSlice</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>i</span><span class=p>,</span> <span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>proto</span><span class=p>.</span><span class=nx>HelloReply</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Message</span><span class=p>:</span> <span class=s>&#34;hello &#34;</span> <span class=o>+</span> <span class=nx>request</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 1. 实例化一个服务
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>g</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 2. 注册处理逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>proto</span><span class=p>.</span><span class=nf>RegisterGreeterServer</span><span class=p>(</span><span class=nx>g</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>Server</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 3. 启动服务
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=s>&#34;0.0.0.0:8088&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;failed to listen:&#34;</span> <span class=o>+</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>g</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>lis</span><span class=p>)</span> <span class=c1>// 不会直接退出
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;failed to start grpc:&#34;</span> <span class=o>+</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>以上就完成了一个简单的 metadata 的使用案例。服务端输出结果如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>bobby<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=m>0</span> bobby
</span></span></code></pre></div><p>如果将上述 server 端的输出代码改为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>md</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nf>FromIncomingContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;get metadata error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>val</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>md</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>那么输出结果可能就会如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>name <span class=o>[</span>bobby<span class=o>]</span>
</span></span><span class=line><span class=cl>password <span class=o>[</span>123456<span class=o>]</span>
</span></span><span class=line><span class=cl>:authority <span class=o>[</span>127.0.0.1:8088<span class=o>]</span>
</span></span><span class=line><span class=cl>content-type <span class=o>[</span>application/grpc<span class=o>]</span>
</span></span><span class=line><span class=cl>user-agent <span class=o>[</span>grpc-go/1.70.0<span class=o>]</span>
</span></span></code></pre></div><p>我们观察以上输出格式，除了我们自行放置的 name 和 password 的字段值，还会同时传递 authority、content-type 和 user-agent 等重要的字段和值，这些都是系统框架默认生成的，这与 http 传输过程的 header 十分类似！</p><h3 id=grpc-拦截器>gRPC 拦截器</h3><p>拦截器是 gRPC 的一个重要部分，在实际的项目开发中也会经常使用到，类似于在 Web 开发框架中，拦截器也是必不可少的一部分。</p><p>比如，在 Web 开发中，我们时常需要对用户的各种请求进行检测和预处理，比如反爬虫等等，这些逻辑并不适合直接写在 API 接口中，这样会污染 API 接口，因此需要一个专门的拦截器模块，微服务中也是同样的道理。</p><p>gRPC 框架中已经实现了拦截器的功能逻辑，我们只需要会配置和使用。</p><p>服务端的 gRPC 拦截器的使用实际上十分简单，我们只需要在原先 <code>server.go</code> 代码中实例化一个服务的 <code>grpc.NewServer()</code> 中传递一个拦截器选项，同时实现这个拦截器的配置函数逻辑即可，比如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>interceptor</span> <span class=p>=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>info</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>UnaryServerInfo</span><span class=p>,</span> <span class=nx>handler</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>UnaryHandler</span><span class=p>)</span> <span class=p>(</span><span class=nx>resp</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 继续处理请求
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=err>……</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>opt</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>UnaryInterceptor</span><span class=p>(</span><span class=nx>interceptor</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>g</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>(</span><span class=nx>opt</span><span class=p>)</span>
</span></span></code></pre></div><p>除了服务端的拦截器，客户端也可以设置拦截器，类似的原理，我们只需要将 <code>client.go</code> 代码中启动监听的 <code>grpc.Dial()</code> 方法中传递一个 <code>grpc.WithUnaryInterceptor()</code> 拦截器选项，并且实现拦截器配置函数逻辑，比如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>interceptor</span> <span class=o>:=</span> <span class=kd>func</span> <span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>method</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>reply</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>cc</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientConn</span><span class=p>,</span> <span class=nx>invoker</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>UnaryInvoker</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=err>……</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>opt</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithUnaryInterceptor</span><span class=p>(</span><span class=nx>interceptor</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span><span class=s>&#34;localhost:8088&#34;</span><span class=p>,</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span><span class=p>(),</span> <span class=nx>opt</span><span class=p>)</span>
</span></span></code></pre></div><p>由于 <code>grpc.Dial()</code> 定义的参数是不定长的，因此下面传入多个参数的方式也十分常见：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>interceptor</span> <span class=o>:=</span> <span class=kd>func</span> <span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>method</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>reply</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>cc</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientConn</span><span class=p>,</span> <span class=nx>invoker</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>UnaryInvoker</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=err>……</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>opts</span> <span class=p>[]</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>DialOption</span>
</span></span><span class=line><span class=cl><span class=nx>opts</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>opts</span><span class=p>,</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>opts</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>opts</span><span class=p>,</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithUnaryInterceptor</span><span class=p>(</span><span class=nx>interceptor</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span><span class=s>&#34;localhost:50051&#34;</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span></code></pre></div><p>当然，以上服务端和客户端中的 <code>interceptor</code> 都可以提取成一个公用的函数。</p><p>完成的示例代码如下，proto 文件代码如 <a href=#metadata%20%E6%9C%BA%E5%88%B6>metadata 机制</a> 中的一样，无需修改。</p><p><code>client/client.go</code> 的代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>interceptor</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>method</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>reply</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>cc</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientConn</span><span class=p>,</span> <span class=nx>invoker</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>UnaryInvoker</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>start</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nf>invoker</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>reply</span><span class=p>,</span> <span class=nx>cc</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;耗时：%s\n&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>opts</span> <span class=p>[]</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>DialOption</span>
</span></span><span class=line><span class=cl>    <span class=nx>opts</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>opts</span><span class=p>,</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nx>opts</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>opts</span><span class=p>,</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithUnaryInterceptor</span><span class=p>(</span><span class=nx>interceptor</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span><span class=s>&#34;127.0.0.1:8088&#34;</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span> <span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span> <span class=o>:=</span> <span class=nx>proto</span><span class=p>.</span><span class=nf>NewGreeterClient</span> <span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>SayHello</span> <span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span> <span class=p>(),</span> <span class=o>&amp;</span><span class=nx>proto</span><span class=p>.</span> <span class=nx>HelloRequest</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;bobby&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span> <span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Message</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>server/server. go</code> 的代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Server</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>SayHello</span> <span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span> <span class=nx>Context</span><span class=p>,</span> <span class=nx>request</span> <span class=o>*</span><span class=nx>proto</span><span class=p>.</span> <span class=nx>HelloRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>proto</span><span class=p>.</span> <span class=nx>HelloReply</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>proto</span><span class=p>.</span> <span class=nx>HelloReply</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Message</span><span class=p>:</span> <span class=s>&#34;hello &#34;</span> <span class=o>+</span> <span class=nx>request</span><span class=p>.</span> <span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>interceptor</span> <span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span> <span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>info</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span> <span class=nx>UnaryServerInfo</span><span class=p>,</span> <span class=nx>handler</span> <span class=nx>grpc</span><span class=p>.</span> <span class=nx>UnaryHandler</span><span class=p>)</span> <span class=p>(</span><span class=nx>resp</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span> <span class=p>(</span><span class=s>&#34;接收到了一个新的请求&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>handler</span> <span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span> <span class=p>(</span><span class=s>&#34;请求已经完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>opt</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>UnaryInterceptor</span> <span class=p>(</span><span class=nx>interceptor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 1. 实例化一个服务
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>g</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span> <span class=p>(</span><span class=nx>opt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 2. 注册处理逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>proto</span><span class=p>.</span><span class=nf>RegisterGreeterServer</span> <span class=p>(</span><span class=nx>g</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>Server</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 3. 启动服务
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span> <span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=s>&#34;0.0.0.0:8088&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=s>&#34;failed to listen: &#34;</span> <span class=o>+</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>g</span><span class=p>.</span><span class=nf>Serve</span> <span class=p>(</span><span class=nx>lis</span><span class=p>)</span> <span class=c1>// 不会直接退出
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=s>&#34;failed to start grpc: &#34;</span> <span class=o>+</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>在服务端的 <code>interceptor</code> 函数中，通过 <code>handler</code> 方法来实现原本服务端的调用逻辑。在客户端的 <code>interceptor</code> 函数中，通过 <code>invoker</code> 方法来实现原本客户端的调用逻辑。</p><p>对于拦截器的其他应用场景， <a href=https://github.com/grpc-ecosystem/go-grpc-middleware>go-grpc-middleware</a> 这个项目十分不错，建议能够读懂源码。</p><h3 id=metadata--拦截器的应用>metadata + 拦截器的应用</h3><p>现在我们想完成一个功能：让我们的 gRPC 在提供服务时有一个验证机制，为了保证安全性。因此，我们可以使用 metadata 机制加上 gRPC 的拦截器来实现。</p><p>具体的实现逻辑十分简单，就是用户在调用 gRPC 服务时，需要通过 metadata 带上用户的验证信息（token）, 再利用拦截器来处理用户的验证信息是否通过，这是一种常见的应用场景。</p><p>具体实现代码如下，同样以最开始的项目示例为例，proto 文件不需要改动。</p><p><code>client/client. go</code> 代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>interceptor</span> <span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span> <span class=nx>Context</span><span class=p>,</span> <span class=nx>method</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>reply</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>cc</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span> <span class=nx>ClientConn</span><span class=p>,</span> <span class=nx>invoker</span> <span class=nx>grpc</span><span class=p>.</span> <span class=nx>UnaryInvoker</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span> <span class=nx>grpc</span><span class=p>.</span> <span class=nx>CallOption</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>start</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span> <span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 通过 metadata 传递认证信息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>md</span> <span class=o>:=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nf>New</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;ID&#34;</span><span class=p>:</span> <span class=s>&#34;123&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;key&#34;</span><span class=p>:</span> <span class=s>&#34;this is a key&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span> <span class=p>=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nf>NewOutgoingContext</span> <span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span> <span class=p>(),</span> <span class=nx>md</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nf>invoker</span> <span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>reply</span><span class=p>,</span> <span class=nx>cc</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span> <span class=p>(</span><span class=s>&#34;耗时：%s\n&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Since</span> <span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span> <span class=p>()</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>opts</span> <span class=p>[]</span><span class=nx>grpc</span><span class=p>.</span> <span class=nx>DialOption</span>
</span></span><span class=line><span class=cl>    <span class=nx>opts</span> <span class=p>=</span> <span class=nf>append</span> <span class=p>(</span><span class=nx>opts</span><span class=p>,</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nx>opts</span> <span class=p>=</span> <span class=nf>append</span> <span class=p>(</span><span class=nx>opts</span><span class=p>,</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithUnaryInterceptor</span> <span class=p>(</span><span class=nx>interceptor</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span> <span class=p>(</span><span class=s>&#34;127.0.0.1:8088&#34;</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span> <span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span> <span class=o>:=</span> <span class=nx>proto</span><span class=p>.</span><span class=nf>NewGreeterClient</span> <span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>SayHello</span> <span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span> <span class=p>(),</span> <span class=o>&amp;</span><span class=nx>proto</span><span class=p>.</span> <span class=nx>HelloRequest</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;bobby&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span> <span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Message</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>server/server. go</code> 代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Server</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>SayHello</span> <span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span> <span class=nx>Context</span><span class=p>,</span> <span class=nx>request</span> <span class=o>*</span><span class=nx>proto</span><span class=p>.</span> <span class=nx>HelloRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>proto</span><span class=p>.</span> <span class=nx>HelloReply</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>proto</span><span class=p>.</span> <span class=nx>HelloReply</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Message</span><span class=p>:</span> <span class=s>&#34;hello &#34;</span> <span class=o>+</span> <span class=nx>request</span><span class=p>.</span> <span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>interceptor</span> <span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span> <span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>info</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span> <span class=nx>UnaryServerInfo</span><span class=p>,</span> <span class=nx>handler</span> <span class=nx>grpc</span><span class=p>.</span> <span class=nx>UnaryHandler</span><span class=p>)</span> <span class=p>(</span><span class=nx>resp</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span> <span class=p>(</span><span class=s>&#34;接收到了一个新的请求&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 接收 metadata 认证信息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>md</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nf>FromIncomingContext</span> <span class=p>(</span><span class=nx>ctx</span><span class=p>);</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>resp</span><span class=p>,</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Error</span> <span class=p>(</span><span class=nx>codes</span><span class=p>.</span> <span class=nx>Unauthenticated</span><span class=p>,</span> <span class=s>&#34;无 token 认证信息&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>ID</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=nx>key</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>va</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>md</span><span class=p>[</span><span class=s>&#34;ID&#34;</span><span class=p>];</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span> <span class=p>=</span> <span class=nx>va</span> <span class=mi>1</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>va</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>md</span><span class=p>[</span><span class=s>&#34;key&#34;</span><span class=p>];</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>key</span> <span class=p>=</span> <span class=nx>va</span> <span class=mi>1</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 模拟 token 信息验证
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>id</span> <span class=o>!=</span> <span class=s>&#34;123&#34;</span> <span class=o>||</span> <span class=nx>key</span> <span class=o>!=</span> <span class=s>&#34;this is a key&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>resp</span><span class=p>,</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Error</span> <span class=p>(</span><span class=nx>codes</span><span class=p>.</span> <span class=nx>Unauthenticated</span><span class=p>,</span> <span class=s>&#34;token 认证失败&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>handler</span> <span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span> <span class=p>(</span><span class=s>&#34;请求已经完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>opt</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>UnaryInterceptor</span> <span class=p>(</span><span class=nx>interceptor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 1. 实例化一个服务
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>g</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span> <span class=p>(</span><span class=nx>opt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 2. 注册处理逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>proto</span><span class=p>.</span><span class=nf>RegisterGreeterServer</span> <span class=p>(</span><span class=nx>g</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>Server</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 3. 启动服务
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span> <span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=s>&#34;0.0.0.0:8088&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=s>&#34;failed to listen: &#34;</span> <span class=o>+</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>g</span><span class=p>.</span><span class=nf>Serve</span> <span class=p>(</span><span class=nx>lis</span><span class=p>)</span> <span class=c1>// 不会直接退出
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=s>&#34;failed to start grpc: &#34;</span> <span class=o>+</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>需要注意服务端代码中的 <code>status.Error ()</code> 是 gRPC 内部自带的错误处理方法，同时也内置了一些常用的错误信息提示码，如 <code>codes. Unauthenticated</code> 就是未认证错误。</p><p>诚然，以上在客户端代码的 <code>interceptor</code> 中设置 metadata 是正确的，但是它却不够好。事实上，gRPC 本身就提供了 <code>grpc.WithPerRPCCredentials ()</code> 方法和 <code>PerRPCCredentials</code> 接口，其中内置了拦截器和 metadata 的传递机制。我们只需要使用 <code>grpc.WithPerRPCCredentials ()</code> 这个方法，并实现 <code>PerRPCCredentials</code> 这个接口。</p><p>通过实现 <code>PerRPCCredentials</code> 这个接口的 <code>GetRequestMetadata ()</code> 和 <code>RequireTransportSecurity ()</code> 这两个方法，在 <code>GetRequestMetadata ()</code> 中返回 metadata 信息，而 <code>RequireTransportSecurity ()</code> 暂时使用不到。</p><p>这样就不需要自己实现拦截器 <code>interceptor ()</code> 这个函数，同时也不用考虑 metadata 信息该如何传递。</p><p>因此，更加简单优秀的 <code>client/client. go</code> 写法，如下所示。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>customCredential</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=nx>customCredential</span><span class=p>)</span> <span class=nf>GetRequestMetadata</span> <span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span> <span class=nx>Context</span><span class=p>,</span> <span class=nx>uri</span> <span class=o>...</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;ID&#34;</span><span class=p>:</span> <span class=s>&#34;123&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;key&#34;</span><span class=p>:</span> <span class=s>&#34;this is a key&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=nx>customCredential</span><span class=p>)</span> <span class=nf>RequireTransportSecurity</span> <span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span> <span class=p>()</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>opts</span> <span class=p>[]</span><span class=nx>grpc</span><span class=p>.</span> <span class=nx>DialOption</span>
</span></span><span class=line><span class=cl>    <span class=nx>opts</span> <span class=p>=</span> <span class=nf>append</span> <span class=p>(</span><span class=nx>opts</span><span class=p>,</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nx>opts</span> <span class=p>=</span> <span class=nf>append</span> <span class=p>(</span><span class=nx>opts</span><span class=p>,</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithPerRPCCredentials</span> <span class=p>(</span><span class=nx>customCredential</span><span class=p>{}))</span>
</span></span><span class=line><span class=cl>    <span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span> <span class=p>(</span><span class=s>&#34;127.0.0.1:8088&#34;</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span> <span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span> <span class=o>:=</span> <span class=nx>proto</span><span class=p>.</span><span class=nf>NewGreeterClient</span> <span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>SayHello</span> <span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span> <span class=p>(),</span> <span class=o>&amp;</span><span class=nx>proto</span><span class=p>.</span> <span class=nx>HelloRequest</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;bobby&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span> <span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Message</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=grpc-验证器>gRPC 验证器</h3><p>proto 文件虽然写起来比较麻烦，但是它实际上相当于文档的功能，在这个文件中，清晰的标识出了接口的参数与返回类型，同时也指明了客户端和服务端互相传递信息具体的字段类型。</p><p>但是，只有以上这些功能还不够，当客户端通过 API 接口请求服务端时，最好在响应之前对客户端的请求参数进行验证，如果参数不对（类型或数量不匹配）那么可以直接取消响应，这就如同 Web 开发框架中的表单验证功能。</p><p>这就是 gRPC 验证器所需要完成的功能。我们将使用 <a href=https://github.com/envoyproxy/protoc-gen-validate>protoc-gen_validate</a> 这个项目进行演示 (该项目只适合演示)。这个项目将通过编写 proto 文件代码，使项目具有一定的 <strong>message 验证功能</strong>，它同时支持 Go、Java、C 等语言。</p><p>在项目 Github 的 Release 页面下载对应版本的 protoc-gen_validate 可执行文件，最好将该文件移动到 Go 的根目录 <code>GOPATH</code> 的 <code>bin</code> 目录下。</p><p>使用以下命令，可以将所需要的 proto 与 go 代码下载到本地的 <code>GOPATH\pkg\mod\github. com\envoyproxy\ protoc-gen-validate@v1.2.1 \</code> 目录中：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>go get -d github. com/envoyproxy/protoc-gen-validate
</span></span></code></pre></div><p>接着就可以在 <code>validate</code> 目录中找到 <code>validate. proto</code> 与 <code>validate. pb. go</code> 文件，这是我们编写 proto 文件和 Go 代码需要引入的文件。</p><p>最好将 <code>validate. proto</code> 拷贝一份放置在项目中的 <code>proto</code> 目录中，方便编写 proto 文件时引入使用。</p><p>或者也可以不拷贝，在使用 protoc 生成时代码时，通过 <code>-I</code> 或者 <code>--proto_path</code> 来指定 <code>validate. proto</code> 的存放路径。</p><p>这样就可以编写 proto 文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto 3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>import</span> <span class=s>&#34;validate. proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;.; proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>service</span> <span class=n>Greeter</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>SayHello</span> <span class=p>(</span><span class=n>Person</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>Person</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Person</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=c1>// id &gt; 999
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>uint</span> <span class=mi>64</span> <span class=n>id</span> <span class=o>=</span> <span class=mi>1</span> <span class=p>[(</span><span class=n>validate.</span> <span class=n>rules</span><span class=p>)</span><span class=o>.</span> <span class=n>uint</span> <span class=mf>64.</span> <span class=n>gt</span> <span class=o>=</span> <span class=mi>999</span><span class=p>];</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=c1>// 内置的 email 规则
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>string</span> <span class=n>email</span> <span class=o>=</span> <span class=mi>2</span> <span class=p>[(</span><span class=n>validate.</span> <span class=n>rules</span><span class=p>)</span><span class=o>.</span> <span class=kt>string</span><span class=o>.</span> <span class=n>email</span> <span class=o>=</span> <span class=kc>true</span><span class=p>];</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=c1>// 电话号码正则表达式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>string</span> <span class=n>mobile</span> <span class=o>=</span> <span class=mi>3</span> <span class=p>[(</span><span class=n>validate.</span> <span class=n>rules</span><span class=p>)</span><span class=o>.</span> <span class=kt>string</span> <span class=o>=</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=n>pattern</span><span class=o>:</span>   <span class=s>&#34;^1[3-9]\\d{9}$&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=p>}];</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p>除了以上演示的规则，实际上还有很多种<strong class=chinese>规则</strong>，可以参加<a href="https://github.com/bufbuild/protoc-gen-validate?tab=readme-ov-file#constraint-rules">官方的文档</a>。</p><p>使用 protoc 命令来生成 Go 代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>protoc -I . -I D:<span class=se>\P</span>ersonal_Data<span class=se>\G</span>o_file<span class=se>\p</span>kg<span class=se>\m</span>od<span class=se>\g</span>ithub. com<span class=se>\e</span>nvoyproxy<span class=se>\ </span>protoc-gen-validate@v1.2.1 <span class=se>\v</span>alidate --go_out<span class=o>=</span>. --go-grpc_out<span class=o>=</span><span class=nv>require_unimplemented_servers</span><span class=o>=</span>false:. --validate_out<span class=o>=</span><span class=s2>&#34;lang=go:.&#34;</span> helloworld. proto
</span></span></code></pre></div><p>这样在当前目录下就会生成三个文件，分别时 <code>helloworld. pb. go</code> 、<code>helloworld_grpc. pb. go</code> 以及 <code>helloworld. pb. validate. go</code>。</p><p>使用这个验证器十分简单，通过 <code>New ()</code> 创建一个对象，调用 <code>Validate ()</code> 会返回一个 error，指明不符合 proto 文件中规定的情况：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>p</span> <span class=o>:=</span> <span class=nf>new</span> <span class=p>(</span><span class=nx>Person</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>Validate</span> <span class=p>()</span> <span class=c1>// err: Id must be greater than 999
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>p</span><span class=p>.</span><span class=nx>Id</span> <span class=p>=</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>err</span> <span class=p>=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>Validate</span> <span class=p>()</span> <span class=c1>// err: Email must be a valid email address
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>p</span><span class=p>.</span><span class=nx>Email</span> <span class=p>=</span> <span class=s>&#34; example@bufbuild.com &#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>err</span> <span class=p>=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>Validate</span> <span class=p>()</span> <span class=c1>// err: Mobile must match pattern &#39;^1[3-9]\\d{9}$&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>p</span><span class=p>.</span><span class=nx>Mobile</span> <span class=p>=</span> <span class=s>&#34;13577889900&#34;</span>
</span></span></code></pre></div><p>但是，如果在代码中使用这个<strong class=chinese>验证器</strong>还需要结合<strong class=chinese>拦截器</strong>。并定义一个 <code>Validator</code> 接口，方便拦截器进行调用。</p><p>接下来就可以在 <code>server/server. go</code> 中配合拦截器来验证客户端传递的值是否符合规范。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Server</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Validator</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>Validate</span> <span class=p>()</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>SayHello</span> <span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span> <span class=nx>Context</span><span class=p>,</span> <span class=nx>request</span> <span class=o>*</span><span class=nx>proto</span><span class=p>.</span> <span class=nx>HelloRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>proto</span><span class=p>.</span> <span class=nx>HelloReply</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>proto</span><span class=p>.</span> <span class=nx>Person</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Id</span><span class=p>:</span> <span class=mi>32</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>interceptor</span> <span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span> <span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>info</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span> <span class=nx>UnaryServerInfo</span><span class=p>,</span> <span class=nx>handler</span> <span class=nx>grpc</span><span class=p>.</span> <span class=nx>UnaryHandler</span><span class=p>)</span> <span class=p>(</span><span class=nx>resp</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>req</span><span class=p>.</span> <span class=p>(</span><span class=nx>Validator</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Validate</span> <span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Error</span> <span class=p>(</span><span class=nx>codes</span><span class=p>.</span> <span class=nx>InvalidArygument</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>handler</span> <span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>opt</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>UnaryInterceptor</span> <span class=p>(</span><span class=nx>interceptor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 1. 实例化一个服务
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>g</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span> <span class=p>(</span><span class=nx>opt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 2. 注册处理逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>proto</span><span class=p>.</span><span class=nf>RegisterGreeterServer</span> <span class=p>(</span><span class=nx>g</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>Server</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 3. 启动服务
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span> <span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=s>&#34;0.0.0.0:8088&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=s>&#34;failed to listen: &#34;</span> <span class=o>+</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>g</span><span class=p>.</span><span class=nf>Serve</span> <span class=p>(</span><span class=nx>lis</span><span class=p>)</span> <span class=c1>// 不会直接退出
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=s>&#34;failed to start grpc: &#34;</span> <span class=o>+</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>而对于 <code>client/client. go</code> 的代码，也就是针对我们的业务代码，则不需要进行任何更改。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span> <span class=p>()</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>opts</span> <span class=p>[]</span><span class=nx>grpc</span><span class=p>.</span> <span class=nx>DialOption</span>
</span></span><span class=line><span class=cl>    <span class=nx>opts</span> <span class=p>=</span> <span class=nf>append</span> <span class=p>(</span><span class=nx>opts</span><span class=p>,</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 不使用客户端的拦截器
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// opts = append (opts, grpc.WithUnaryInterceptor (interceptor))
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span> <span class=p>(</span><span class=s>&#34;127.0.0.1:8088&#34;</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span> <span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span> <span class=o>:=</span> <span class=nx>proto</span><span class=p>.</span><span class=nf>NewGreeterClient</span> <span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>SayHello</span> <span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span> <span class=p>(),</span> <span class=o>&amp;</span><span class=nx>proto</span><span class=p>.</span> <span class=nx>Person</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=p>:</span> <span class=s>&#34;800&#34;</span><span class=p>,</span> <span class=c1>// 报错
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>email</span><span class=p>:</span> <span class=s>&#34; example@pie.fun &#34;</span> <span class=c1>// 正确
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>mobile</span><span class=p>:</span> <span class=s>&#34;13566779900&#34;</span> <span class=c1>// 正确
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span> <span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Message</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=grpc-异常处理>gRPC 异常处理</h3><p>gRPC 中自带了许多常见情况的状态码，可以直接非常方便地使用。具体见<a href=https://github.com/grpc/grpc/blob/master/doc/statuscodes.md>官方文档</a>。</p><p>在实际开发中，很多时候我们会自己定义状态码，一些开发框架可能会提供一些简单的状态码，我们可以选择遵守这些规则，也可以选择不遵守。</p><p>遵守的好处在于，所有人都清楚这些状态码，迁移更加方便，迁移成本更低，对于爬虫也更加友好。然而对于一些大型公司，不在意百度爬虫，甚至不希望别人来爬取公司数据，因此它们会自定义一套状态码。</p><p>gRPC 中给出的状态码，方便我们开发者在多语言的环境中进行开发，它对于不同的编程语言都提供了一套通用完整的状态码，不需要我们单独维护。</p><p>那么我们如何使用 gRPC 提供的这个<strong class=chinese>状态码</strong>和<strong class=chinese>错误处理</strong>呢？</p><p>实际上很简单，只需要使用 gRPC 的 status 包来返回一个错误信息，利用 codes 包来使用定义好的状态码。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>err</span> <span class=o>:=</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Error</span> <span class=p>(</span><span class=nx>codes</span><span class=p>.</span> <span class=nx>NotFound</span><span class=p>,</span> <span class=s>&#34;记录未找到&#34;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>err</span> <span class=o>:=</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Errorf</span> <span class=p>(</span><span class=nx>codes</span><span class=p>.</span> <span class=nx>NotFound</span><span class=p>,</span> <span class=s>&#34;记录未找到：%s&#34;</span><span class=p>,</span> <span class=nx>request</span><span class=p>.</span> <span class=nx>Name</span><span class=p>)</span>
</span></span></code></pre></div><p>比如 <code>server/server. go</code> 通过 <code>status.Errorf ()</code> 方法，返回错误信息。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Server</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 实现 helloworld_grpc. pb. go 中的 GreeterServer 接口
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>SayHello</span> <span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span> <span class=nx>Context</span><span class=p>,</span> <span class=nx>request</span> <span class=o>*</span><span class=nx>proto</span><span class=p>.</span> <span class=nx>HelloRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>proto</span><span class=p>.</span> <span class=nx>HelloReply</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Errorf</span> <span class=p>(</span><span class=nx>codes</span><span class=p>.</span> <span class=nx>NotFound</span><span class=p>,</span> <span class=s>&#34;记录未找到：%s&#34;</span><span class=p>,</span> <span class=nx>request</span><span class=p>.</span> <span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 1. 实例化一个服务
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>g</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span> <span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 2. 注册处理逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>proto</span><span class=p>.</span><span class=nf>RegisterGreeterServer</span> <span class=p>(</span><span class=nx>g</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>Server</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 3. 启动服务
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span> <span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=s>&#34;0.0.0.0:8088&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=s>&#34;failed to listen: &#34;</span> <span class=o>+</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>g</span><span class=p>.</span><span class=nf>Serve</span> <span class=p>(</span><span class=nx>lis</span><span class=p>)</span> <span class=c1>// 不会直接退出
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=s>&#34;failed to start grpc: &#34;</span> <span class=o>+</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>而 <code>client/client. go</code> 通过 <code>status.FromError ()</code> 方法，将服务端发送的错误信息再转换为 status，并取出其中的状态码与提示文字。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span> <span class=p>()</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span> <span class=p>(</span><span class=s>&#34;127.0.0.1:8088&#34;</span><span class=p>,</span><span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span> <span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>c</span> <span class=o>:=</span> <span class=nx>proto</span><span class=p>.</span><span class=nf>NewGreeterClient</span> <span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>SayHello</span> <span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span> <span class=p>(),</span><span class=o>&amp;</span><span class=nx>proto</span><span class=p>.</span> <span class=nx>HelloRequest</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;bobby&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>st</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>status</span><span class=p>.</span><span class=nf>FromError</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Error was not a status error
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>panic</span> <span class=p>(</span><span class=s>&#34;解析 error 失败&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span> <span class=p>(</span><span class=nx>st</span><span class=p>.</span><span class=nf>Message</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span> <span class=p>(</span><span class=nx>st</span><span class=p>.</span><span class=nf>Code</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><blockquote><p>gRPC 提供的这一套状态码与错误处理机制是<strong class=chinese>跨语言通用</strong>的。</p></blockquote><h3 id=grpc-超时机制>gRPC 超时机制</h3><p>当一个客户端访问服务端时，可能会出现一些异常，比如<strong>网络拥塞/抖动</strong>、<strong>服务器压力大/处理慢</strong>等问题，可能会使客户端请求很慢，需要一直等待服务器返回，导致客户端后续的操作一直无法进行，执行队列被阻塞，引起一连串的反应与错误，因此客户端一定需要一个<strong class=chinese>超时机制</strong>。</p><p>牵扯到 Go 语言的超时机制，那么一定绕不开的就是 Go 语言的 Context（<strong>十分重要!!!</strong>）。</p><p>客户端想要实现超时机制其实十分简单，利用 Context 设置超时时间，同时 gRPC 的错误处理会自动给其加上错误提示，具体方式如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span> <span class=p>()</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span> <span class=p>(</span><span class=s>&#34;127.0.0.1:8088&#34;</span><span class=p>,</span><span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>panic</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span> <span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>c</span> <span class=o>:=</span> <span class=nx>proto</span><span class=p>.</span><span class=nf>NewGreeterClient</span> <span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置超时时间为 3 秒
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>ctx</span><span class=p>,</span> <span class=nx>_</span> <span class=p>=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span> <span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span> <span class=p>(),</span> <span class=nx>time</span><span class=p>.</span> <span class=nx>Second</span> <span class=o>*</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>SayHello</span> <span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>proto</span><span class=p>.</span> <span class=nx>HelloRequest</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;bobby&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>st</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>status</span><span class=p>.</span><span class=nf>FromError</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Error was not a status error
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>panic</span> <span class=p>(</span><span class=s>&#34;解析 error 失败&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span> <span class=p>(</span><span class=nx>st</span><span class=p>.</span><span class=nf>Message</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span> <span class=p>(</span><span class=nx>st</span><span class=p>.</span><span class=nf>Code</span> <span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>如果超时，会返回错误信息为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>context deadline exceeded
</span></span><span class=line><span class=cl>DeadlineExceeded
</span></span></code></pre></div></article><div class=paginator><a class=link href=https://blog.pi3.fun/post/2025/02/grpc-notes-basics/>← prev</a>
<a class=link href=https://blog.pi3.fun/post/2025/03/microservices-architecture-design/>next →</a></div><div class=comment><div id=tcomment></div><script src=https://registry.npmmirror.com/twikoo/1.6.39/files/dist/twikoo.min.js></script><script async>twikoo.init({envId:"https://twikoo.pi3.fun/.netlify/functions/twikoo",el:"#tcomment",lang:"zh-CN"})</script></div></main><footer id=footer><div><span style=display:flex;align-items:center><span style=margin-right:.5rem>© 2021 - 2025</span><img src=https://cdn.pi3.fun/static/rainbow.gif loading=lazy width=20 alt=rainbow><span style=margin-left:.5rem>By Liu Chao</span></span></div><div class=footnote><span><a href=https://www.foreverblog.cn/ target=_blank><img src=https://img.foreverblog.cn/logo_en_default.png style=width:auto;height:16px></a> | <a data-accent-color href=https://www.boyouquan.com/ style="font-size:16px;background-image:linear-gradient(to right,#14100f,#d55b5b,#4d14e6);background-clip:text;color:transparent">博友圈</a><br><a class=link href=/index.xml><span class="iconfont icon-RSS"></span></a> | <a class=link href=https://github.com/Pi3-l22 target=_ blank><span class="iconfont icon-GitHub"></span></a> | <a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener><span class="iconfont icon-creative-commons-fill"></span></a></span></div><div class=blog-icon></div></footer></div><script>document.addEventListener("DOMContentLoaded",function(){const n=localStorage.getItem("theme")||"light",e=document.querySelector('link[data-theme-style="light"]'),t=document.querySelector('link[data-theme-style="dark"]'),i=window.matchMedia("(prefers-color-scheme: dark)");i.addListener(function(n){if(!localStorage.getItem("theme")){const s=n.matches?"dark":"light";document.documentElement.setAttribute("data-theme",s),localStorage.setItem("theme",s),s==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");const o=document.querySelector("iframe.giscus-frame");if(o){const e=s==="light"?"light_tritanopia":"dark_tritanopia";o.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}}}),n==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");function o(){const e=document.querySelector("iframe.giscus-frame");if(e){const t=n==="light"?"light_tritanopia":"dark_tritanopia";e.contentWindow.postMessage({giscus:{setConfig:{theme:t}}},"https://giscus.app")}else setTimeout(o,1e3)}o();const s=document.querySelector(".theme-toggle");s&&(s.textContent=n==="light"?"黑暗":"明亮",s.addEventListener("click",function(){const o=document.documentElement.getAttribute("data-theme"),n=o==="light"?"dark":"light";document.documentElement.setAttribute("data-theme",n),localStorage.setItem("theme",n),n==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");const s=document.querySelector("iframe.giscus-frame");if(s){const e=n==="light"?"light_tritanopia":"dark_tritanopia";s.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}this.textContent=n==="light"?"黑暗":"明亮"}))})</script><script src=https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){confetti({particleCount:150,spread:100})})</script></body></html>