<!doctype html><html lang=zh-cn><head><script>(function(){const e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)})()</script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=author content="LiuChao"><meta name=description content="AES-128算法的经典实现知识点笔记"><link rel=icon href=https://blog.pi3.fun/favicon.ico><meta name=keywords content=" study  latex  life  academic "><meta property="og:url" content="https://blog.pi3.fun/post/2025/05/aes-128-classic-implementation/"><meta property="og:site_name" content="Pi3's Notes"><meta property="og:title" content="AES-128算法的经典实现"><meta property="og:description" content="AES-128算法的经典实现知识点笔记"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2025-05-17T00:00:00+00:00"><meta property="article:modified_time" content="2025-05-17T00:00:00+00:00"><meta property="article:tag" content="技术"><meta property="article:tag" content="AES"><meta property="article:tag" content="Python"><link rel=canonical href=https://blog.pi3.fun/post/2025/05/aes-128-classic-implementation/><meta itemprop=name content="AES-128算法的经典实现"><meta itemprop=description content="AES-128算法的经典实现知识点笔记"><meta itemprop=datePublished content="2025-05-17T00:00:00+00:00"><meta itemprop=dateModified content="2025-05-17T00:00:00+00:00"><meta itemprop=wordCount content="3786"><meta itemprop=keywords content="技术,AES,Python"><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/common.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/content.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/theme.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/iconfont/iconfont.css><link rel=stylesheet href=https://blog.pi3.fun/css/syntax/xcode.css data-theme-style=light media="(prefers-color-scheme: light)"><link rel=stylesheet href=https://blog.pi3.fun/css/syntax/catppuccin-mocha.css data-theme-style=dark media="not all"><title>AES-128算法的经典实现 - Pi3's Notes</title>
<link rel=stylesheet href=https://blog.pi3.fun/css/single.css><link href=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/katex.min.css rel=stylesheet><script defer src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/katex.min.js></script><script defer src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}],ignoredTags:["script","noscript","style","textarea","pre","code","option"],throwOnError:!1})})</script></head><body><div id=wrapper><header id=header><link rel=stylesheet href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Regular/result.css><link rel=stylesheet href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Italic/result.css><link rel=stylesheet href=https://chinese-fonts-cdn.deno.dev/packages/maple-mono-cn/dist/MapleMono-CN-Regular/result.css><h1><a href=https://blog.pi3.fun/>Pi3's Notes</a></h1><nav><span class=nav-bar-item><a class=link href=/>文章</a>
</span><span class=nav-bar-item><a class=link href=https://www.boyouquan.com/planet-shuttle>穿梭</a>
</span><span class=nav-bar-item><a class=link href=/about/>关于</a>
</span><span class=nav-bar-item><a class=link href=/links/>友链</a>
</span><span class=nav-bar-item><a class="link theme-toggle" href=javascript:void(0);>黑暗</a></span></nav></header><main id=main class=post><h1>AES-128算法的经典实现</h1><div><b>Keywords: </b><a class=link href=https://blog.pi3.fun/tags/%E6%8A%80%E6%9C%AF>#技术</a>
<a class=link href=https://blog.pi3.fun/tags/aes>#AES</a>
<a class=link href=https://blog.pi3.fun/tags/python>#Python</a></div><div><b>Release Date: </b><span>2025-05-17</span></div><details><summary><b>Table of Contents</b></summary><div class=toc><nav id=TableOfContents><ul><li><a href=#原理>原理</a></li><li><a href=#实现>实现</a></li></ul></nav></div></details><article class=content><p>使用 Python 对 AES-128 密码算法加解密流程进行经典实现，所谓经典就是使用普通计算机和编程语言将算法流程实现。算法采用 ECB 模式，即将明文/密文分为16个字节一组（不足的0填充），每组分别独立进行AES加解密，最后拼接在一起。</p><h2 id=原理>原理</h2><p>AES-128 算法共 11 轮，输入输出均为 128 bit，通过</p><ol><li>字节代换（SubBytes）</li><li>行移位（ShiftRows）</li><li>列混淆（MixColumns）</li><li>轮密钥加（AddRoundKey）</li></ol><p>共 4 个操作完成每轮的运算流程。</p><p>整体流程如下图所示：</p><p><img src=https://cdn.pi3.fun/blog/202505171512255.png alt=image.png></p><p>其中字节代换操作为：</p><p><img src=https://cdn.pi3.fun/blog/202505171516861.png alt=image.png></p><p>行移位操作为：</p><p><img src=https://cdn.pi3.fun/blog/202505171516608.png alt=image.png></p><p>列混淆操作为：</p><p><img src=https://cdn.pi3.fun/blog/202505171516018.png alt=image.png></p><p>轮密钥加操作为：</p><p><img src=https://cdn.pi3.fun/blog/202505171517158.png alt=image.png></p><p>此外，初始密钥也需要通过密钥扩展流程，生成 11 轮的轮密钥，密钥扩展具体流程如下图所示：</p><p><img src=https://cdn.pi3.fun/blog/202505171514303.png alt=image.png></p><p>了解以上 AES-128 算法具体的流程，下面就可以开始使用 Python 编写经典实现代码。</p><h2 id=实现>实现</h2><p>首先需要定义一些常量，如 RC 轮常数、S 盒、逆 S 盒、MC 列混淆常熟矩阵以及逆 MC 矩阵。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 轮常数</span>
</span></span><span class=line><span class=cl><span class=n>RC</span> <span class=o>=</span> <span class=p>[</span><span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x08</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x40</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x1b</span><span class=p>,</span> <span class=mh>0x36</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># S盒，改为16x16的二维数组形式 </span>
</span></span><span class=line><span class=cl><span class=n>S</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x63</span><span class=p>,</span> <span class=mh>0x7c</span><span class=p>,</span> <span class=mh>0x77</span><span class=p>,</span> <span class=mh>0x7b</span><span class=p>,</span> <span class=mh>0xf2</span><span class=p>,</span> <span class=mh>0x6b</span><span class=p>,</span> <span class=mh>0x6f</span><span class=p>,</span> <span class=mh>0xc5</span><span class=p>,</span> <span class=mh>0x30</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x67</span><span class=p>,</span> <span class=mh>0x2b</span><span class=p>,</span> <span class=mh>0xfe</span><span class=p>,</span> <span class=mh>0xd7</span><span class=p>,</span> <span class=mh>0xab</span><span class=p>,</span> <span class=mh>0x76</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0xca</span><span class=p>,</span> <span class=mh>0x82</span><span class=p>,</span> <span class=mh>0xc9</span><span class=p>,</span> <span class=mh>0x7d</span><span class=p>,</span> <span class=mh>0xfa</span><span class=p>,</span> <span class=mh>0x59</span><span class=p>,</span> <span class=mh>0x47</span><span class=p>,</span> <span class=mh>0xf0</span><span class=p>,</span> <span class=mh>0xad</span><span class=p>,</span> <span class=mh>0xd4</span><span class=p>,</span> <span class=mh>0xa2</span><span class=p>,</span> <span class=mh>0xaf</span><span class=p>,</span> <span class=mh>0x9c</span><span class=p>,</span> <span class=mh>0xa4</span><span class=p>,</span> <span class=mh>0x72</span><span class=p>,</span> <span class=mh>0xc0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0xb7</span><span class=p>,</span> <span class=mh>0xfd</span><span class=p>,</span> <span class=mh>0x93</span><span class=p>,</span> <span class=mh>0x26</span><span class=p>,</span> <span class=mh>0x36</span><span class=p>,</span> <span class=mh>0x3f</span><span class=p>,</span> <span class=mh>0xf7</span><span class=p>,</span> <span class=mh>0xcc</span><span class=p>,</span> <span class=mh>0x34</span><span class=p>,</span> <span class=mh>0xa5</span><span class=p>,</span> <span class=mh>0xe5</span><span class=p>,</span> <span class=mh>0xf1</span><span class=p>,</span> <span class=mh>0x71</span><span class=p>,</span> <span class=mh>0xd8</span><span class=p>,</span> <span class=mh>0x31</span><span class=p>,</span> <span class=mh>0x15</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x04</span><span class=p>,</span> <span class=mh>0xc7</span><span class=p>,</span> <span class=mh>0x23</span><span class=p>,</span> <span class=mh>0xc3</span><span class=p>,</span> <span class=mh>0x18</span><span class=p>,</span> <span class=mh>0x96</span><span class=p>,</span> <span class=mh>0x05</span><span class=p>,</span> <span class=mh>0x9a</span><span class=p>,</span> <span class=mh>0x07</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0xe2</span><span class=p>,</span> <span class=mh>0xeb</span><span class=p>,</span> <span class=mh>0x27</span><span class=p>,</span> <span class=mh>0xb2</span><span class=p>,</span> <span class=mh>0x75</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x09</span><span class=p>,</span> <span class=mh>0x83</span><span class=p>,</span> <span class=mh>0x2c</span><span class=p>,</span> <span class=mh>0x1a</span><span class=p>,</span> <span class=mh>0x1b</span><span class=p>,</span> <span class=mh>0x6e</span><span class=p>,</span> <span class=mh>0x5a</span><span class=p>,</span> <span class=mh>0xa0</span><span class=p>,</span> <span class=mh>0x52</span><span class=p>,</span> <span class=mh>0x3b</span><span class=p>,</span> <span class=mh>0xd6</span><span class=p>,</span> <span class=mh>0xb3</span><span class=p>,</span> <span class=mh>0x29</span><span class=p>,</span> <span class=mh>0xe3</span><span class=p>,</span> <span class=mh>0x2f</span><span class=p>,</span> <span class=mh>0x84</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x53</span><span class=p>,</span> <span class=mh>0xd1</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0xed</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0xfc</span><span class=p>,</span> <span class=mh>0xb1</span><span class=p>,</span> <span class=mh>0x5b</span><span class=p>,</span> <span class=mh>0x6a</span><span class=p>,</span> <span class=mh>0xcb</span><span class=p>,</span> <span class=mh>0xbe</span><span class=p>,</span> <span class=mh>0x39</span><span class=p>,</span> <span class=mh>0x4a</span><span class=p>,</span> <span class=mh>0x4c</span><span class=p>,</span> <span class=mh>0x58</span><span class=p>,</span> <span class=mh>0xcf</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0xd0</span><span class=p>,</span> <span class=mh>0xef</span><span class=p>,</span> <span class=mh>0xaa</span><span class=p>,</span> <span class=mh>0xfb</span><span class=p>,</span> <span class=mh>0x43</span><span class=p>,</span> <span class=mh>0x4d</span><span class=p>,</span> <span class=mh>0x33</span><span class=p>,</span> <span class=mh>0x85</span><span class=p>,</span> <span class=mh>0x45</span><span class=p>,</span> <span class=mh>0xf9</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x7f</span><span class=p>,</span> <span class=mh>0x50</span><span class=p>,</span> <span class=mh>0x3c</span><span class=p>,</span> <span class=mh>0x9f</span><span class=p>,</span> <span class=mh>0xa8</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x51</span><span class=p>,</span> <span class=mh>0xa3</span><span class=p>,</span> <span class=mh>0x40</span><span class=p>,</span> <span class=mh>0x8f</span><span class=p>,</span> <span class=mh>0x92</span><span class=p>,</span> <span class=mh>0x9d</span><span class=p>,</span> <span class=mh>0x38</span><span class=p>,</span> <span class=mh>0xf5</span><span class=p>,</span> <span class=mh>0xbc</span><span class=p>,</span> <span class=mh>0xb6</span><span class=p>,</span> <span class=mh>0xda</span><span class=p>,</span> <span class=mh>0x21</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>,</span> <span class=mh>0xff</span><span class=p>,</span> <span class=mh>0xf3</span><span class=p>,</span> <span class=mh>0xd2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0xcd</span><span class=p>,</span> <span class=mh>0x0c</span><span class=p>,</span> <span class=mh>0x13</span><span class=p>,</span> <span class=mh>0xec</span><span class=p>,</span> <span class=mh>0x5f</span><span class=p>,</span> <span class=mh>0x97</span><span class=p>,</span> <span class=mh>0x44</span><span class=p>,</span> <span class=mh>0x17</span><span class=p>,</span> <span class=mh>0xc4</span><span class=p>,</span> <span class=mh>0xa7</span><span class=p>,</span> <span class=mh>0x7e</span><span class=p>,</span> <span class=mh>0x3d</span><span class=p>,</span> <span class=mh>0x64</span><span class=p>,</span> <span class=mh>0x5d</span><span class=p>,</span> <span class=mh>0x19</span><span class=p>,</span> <span class=mh>0x73</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x60</span><span class=p>,</span> <span class=mh>0x81</span><span class=p>,</span> <span class=mh>0x4f</span><span class=p>,</span> <span class=mh>0xdc</span><span class=p>,</span> <span class=mh>0x22</span><span class=p>,</span> <span class=mh>0x2a</span><span class=p>,</span> <span class=mh>0x90</span><span class=p>,</span> <span class=mh>0x88</span><span class=p>,</span> <span class=mh>0x46</span><span class=p>,</span> <span class=mh>0xee</span><span class=p>,</span> <span class=mh>0xb8</span><span class=p>,</span> <span class=mh>0x14</span><span class=p>,</span> <span class=mh>0xde</span><span class=p>,</span> <span class=mh>0x5e</span><span class=p>,</span> <span class=mh>0x0b</span><span class=p>,</span> <span class=mh>0xdb</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0xe0</span><span class=p>,</span> <span class=mh>0x32</span><span class=p>,</span> <span class=mh>0x3a</span><span class=p>,</span> <span class=mh>0x0a</span><span class=p>,</span> <span class=mh>0x49</span><span class=p>,</span> <span class=mh>0x06</span><span class=p>,</span> <span class=mh>0x24</span><span class=p>,</span> <span class=mh>0x5c</span><span class=p>,</span> <span class=mh>0xc2</span><span class=p>,</span> <span class=mh>0xd3</span><span class=p>,</span> <span class=mh>0xac</span><span class=p>,</span> <span class=mh>0x62</span><span class=p>,</span> <span class=mh>0x91</span><span class=p>,</span> <span class=mh>0x95</span><span class=p>,</span> <span class=mh>0xe4</span><span class=p>,</span> <span class=mh>0x79</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0xe7</span><span class=p>,</span> <span class=mh>0xc8</span><span class=p>,</span> <span class=mh>0x37</span><span class=p>,</span> <span class=mh>0x6d</span><span class=p>,</span> <span class=mh>0x8d</span><span class=p>,</span> <span class=mh>0xd5</span><span class=p>,</span> <span class=mh>0x4e</span><span class=p>,</span> <span class=mh>0xa9</span><span class=p>,</span> <span class=mh>0x6c</span><span class=p>,</span> <span class=mh>0x56</span><span class=p>,</span> <span class=mh>0xf4</span><span class=p>,</span> <span class=mh>0xea</span><span class=p>,</span> <span class=mh>0x65</span><span class=p>,</span> <span class=mh>0x7a</span><span class=p>,</span> <span class=mh>0xae</span><span class=p>,</span> <span class=mh>0x08</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0xba</span><span class=p>,</span> <span class=mh>0x78</span><span class=p>,</span> <span class=mh>0x25</span><span class=p>,</span> <span class=mh>0x2e</span><span class=p>,</span> <span class=mh>0x1c</span><span class=p>,</span> <span class=mh>0xa6</span><span class=p>,</span> <span class=mh>0xb4</span><span class=p>,</span> <span class=mh>0xc6</span><span class=p>,</span> <span class=mh>0xe8</span><span class=p>,</span> <span class=mh>0xdd</span><span class=p>,</span> <span class=mh>0x74</span><span class=p>,</span> <span class=mh>0x1f</span><span class=p>,</span> <span class=mh>0x4b</span><span class=p>,</span> <span class=mh>0xbd</span><span class=p>,</span> <span class=mh>0x8b</span><span class=p>,</span> <span class=mh>0x8a</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x70</span><span class=p>,</span> <span class=mh>0x3e</span><span class=p>,</span> <span class=mh>0xb5</span><span class=p>,</span> <span class=mh>0x66</span><span class=p>,</span> <span class=mh>0x48</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>,</span> <span class=mh>0xf6</span><span class=p>,</span> <span class=mh>0x0e</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x35</span><span class=p>,</span> <span class=mh>0x57</span><span class=p>,</span> <span class=mh>0xb9</span><span class=p>,</span> <span class=mh>0x86</span><span class=p>,</span> <span class=mh>0xc1</span><span class=p>,</span> <span class=mh>0x1d</span><span class=p>,</span> <span class=mh>0x9e</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0xe1</span><span class=p>,</span> <span class=mh>0xf8</span><span class=p>,</span> <span class=mh>0x98</span><span class=p>,</span> <span class=mh>0x11</span><span class=p>,</span> <span class=mh>0x69</span><span class=p>,</span> <span class=mh>0xd9</span><span class=p>,</span> <span class=mh>0x8e</span><span class=p>,</span> <span class=mh>0x94</span><span class=p>,</span> <span class=mh>0x9b</span><span class=p>,</span> <span class=mh>0x1e</span><span class=p>,</span> <span class=mh>0x87</span><span class=p>,</span> <span class=mh>0xe9</span><span class=p>,</span> <span class=mh>0xce</span><span class=p>,</span> <span class=mh>0x55</span><span class=p>,</span> <span class=mh>0x28</span><span class=p>,</span> <span class=mh>0xdf</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x8c</span><span class=p>,</span> <span class=mh>0xa1</span><span class=p>,</span> <span class=mh>0x89</span><span class=p>,</span> <span class=mh>0x0d</span><span class=p>,</span> <span class=mh>0xbf</span><span class=p>,</span> <span class=mh>0xe6</span><span class=p>,</span> <span class=mh>0x42</span><span class=p>,</span> <span class=mh>0x68</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x99</span><span class=p>,</span> <span class=mh>0x2d</span><span class=p>,</span> <span class=mh>0x0f</span><span class=p>,</span> <span class=mh>0xb0</span><span class=p>,</span> <span class=mh>0x54</span><span class=p>,</span> <span class=mh>0xbb</span><span class=p>,</span> <span class=mh>0x16</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 逆S盒，改为16x16的二维数组形式</span>
</span></span><span class=line><span class=cl><span class=n>INV_S</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x52</span><span class=p>,</span> <span class=mh>0x09</span><span class=p>,</span> <span class=mh>0x6a</span><span class=p>,</span> <span class=mh>0xd5</span><span class=p>,</span> <span class=mh>0x30</span><span class=p>,</span> <span class=mh>0x36</span><span class=p>,</span> <span class=mh>0xa5</span><span class=p>,</span> <span class=mh>0x38</span><span class=p>,</span> <span class=mh>0xbf</span><span class=p>,</span> <span class=mh>0x40</span><span class=p>,</span> <span class=mh>0xa3</span><span class=p>,</span> <span class=mh>0x9e</span><span class=p>,</span> <span class=mh>0x81</span><span class=p>,</span> <span class=mh>0xf3</span><span class=p>,</span> <span class=mh>0xd7</span><span class=p>,</span> <span class=mh>0xfb</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x7c</span><span class=p>,</span> <span class=mh>0xe3</span><span class=p>,</span> <span class=mh>0x39</span><span class=p>,</span> <span class=mh>0x82</span><span class=p>,</span> <span class=mh>0x9b</span><span class=p>,</span> <span class=mh>0x2f</span><span class=p>,</span> <span class=mh>0xff</span><span class=p>,</span> <span class=mh>0x87</span><span class=p>,</span> <span class=mh>0x34</span><span class=p>,</span> <span class=mh>0x8e</span><span class=p>,</span> <span class=mh>0x43</span><span class=p>,</span> <span class=mh>0x44</span><span class=p>,</span> <span class=mh>0xc4</span><span class=p>,</span> <span class=mh>0xde</span><span class=p>,</span> <span class=mh>0xe9</span><span class=p>,</span> <span class=mh>0xcb</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x54</span><span class=p>,</span> <span class=mh>0x7b</span><span class=p>,</span> <span class=mh>0x94</span><span class=p>,</span> <span class=mh>0x32</span><span class=p>,</span> <span class=mh>0xa6</span><span class=p>,</span> <span class=mh>0xc2</span><span class=p>,</span> <span class=mh>0x23</span><span class=p>,</span> <span class=mh>0x3d</span><span class=p>,</span> <span class=mh>0xee</span><span class=p>,</span> <span class=mh>0x4c</span><span class=p>,</span> <span class=mh>0x95</span><span class=p>,</span> <span class=mh>0x0b</span><span class=p>,</span> <span class=mh>0x42</span><span class=p>,</span> <span class=mh>0xfa</span><span class=p>,</span> <span class=mh>0xc3</span><span class=p>,</span> <span class=mh>0x4e</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x08</span><span class=p>,</span> <span class=mh>0x2e</span><span class=p>,</span> <span class=mh>0xa1</span><span class=p>,</span> <span class=mh>0x66</span><span class=p>,</span> <span class=mh>0x28</span><span class=p>,</span> <span class=mh>0xd9</span><span class=p>,</span> <span class=mh>0x24</span><span class=p>,</span> <span class=mh>0xb2</span><span class=p>,</span> <span class=mh>0x76</span><span class=p>,</span> <span class=mh>0x5b</span><span class=p>,</span> <span class=mh>0xa2</span><span class=p>,</span> <span class=mh>0x49</span><span class=p>,</span> <span class=mh>0x6d</span><span class=p>,</span> <span class=mh>0x8b</span><span class=p>,</span> <span class=mh>0xd1</span><span class=p>,</span> <span class=mh>0x25</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x72</span><span class=p>,</span> <span class=mh>0xf8</span><span class=p>,</span> <span class=mh>0xf6</span><span class=p>,</span> <span class=mh>0x64</span><span class=p>,</span> <span class=mh>0x86</span><span class=p>,</span> <span class=mh>0x68</span><span class=p>,</span> <span class=mh>0x98</span><span class=p>,</span> <span class=mh>0x16</span><span class=p>,</span> <span class=mh>0xd4</span><span class=p>,</span> <span class=mh>0xa4</span><span class=p>,</span> <span class=mh>0x5c</span><span class=p>,</span> <span class=mh>0xcc</span><span class=p>,</span> <span class=mh>0x5d</span><span class=p>,</span> <span class=mh>0x65</span><span class=p>,</span> <span class=mh>0xb6</span><span class=p>,</span> <span class=mh>0x92</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x6c</span><span class=p>,</span> <span class=mh>0x70</span><span class=p>,</span> <span class=mh>0x48</span><span class=p>,</span> <span class=mh>0x50</span><span class=p>,</span> <span class=mh>0xfd</span><span class=p>,</span> <span class=mh>0xed</span><span class=p>,</span> <span class=mh>0xb9</span><span class=p>,</span> <span class=mh>0xda</span><span class=p>,</span> <span class=mh>0x5e</span><span class=p>,</span> <span class=mh>0x15</span><span class=p>,</span> <span class=mh>0x46</span><span class=p>,</span> <span class=mh>0x57</span><span class=p>,</span> <span class=mh>0xa7</span><span class=p>,</span> <span class=mh>0x8d</span><span class=p>,</span> <span class=mh>0x9d</span><span class=p>,</span> <span class=mh>0x84</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x90</span><span class=p>,</span> <span class=mh>0xd8</span><span class=p>,</span> <span class=mh>0xab</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x8c</span><span class=p>,</span> <span class=mh>0xbc</span><span class=p>,</span> <span class=mh>0xd3</span><span class=p>,</span> <span class=mh>0x0a</span><span class=p>,</span> <span class=mh>0xf7</span><span class=p>,</span> <span class=mh>0xe4</span><span class=p>,</span> <span class=mh>0x58</span><span class=p>,</span> <span class=mh>0x05</span><span class=p>,</span> <span class=mh>0xb8</span><span class=p>,</span> <span class=mh>0xb3</span><span class=p>,</span> <span class=mh>0x45</span><span class=p>,</span> <span class=mh>0x06</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0xd0</span><span class=p>,</span> <span class=mh>0x2c</span><span class=p>,</span> <span class=mh>0x1e</span><span class=p>,</span> <span class=mh>0x8f</span><span class=p>,</span> <span class=mh>0xca</span><span class=p>,</span> <span class=mh>0x3f</span><span class=p>,</span> <span class=mh>0x0f</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0xc1</span><span class=p>,</span> <span class=mh>0xaf</span><span class=p>,</span> <span class=mh>0xbd</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x13</span><span class=p>,</span> <span class=mh>0x8a</span><span class=p>,</span> <span class=mh>0x6b</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x3a</span><span class=p>,</span> <span class=mh>0x91</span><span class=p>,</span> <span class=mh>0x11</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x4f</span><span class=p>,</span> <span class=mh>0x67</span><span class=p>,</span> <span class=mh>0xdc</span><span class=p>,</span> <span class=mh>0xea</span><span class=p>,</span> <span class=mh>0x97</span><span class=p>,</span> <span class=mh>0xf2</span><span class=p>,</span> <span class=mh>0xcf</span><span class=p>,</span> <span class=mh>0xce</span><span class=p>,</span> <span class=mh>0xf0</span><span class=p>,</span> <span class=mh>0xb4</span><span class=p>,</span> <span class=mh>0xe6</span><span class=p>,</span> <span class=mh>0x73</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x96</span><span class=p>,</span> <span class=mh>0xac</span><span class=p>,</span> <span class=mh>0x74</span><span class=p>,</span> <span class=mh>0x22</span><span class=p>,</span> <span class=mh>0xe7</span><span class=p>,</span> <span class=mh>0xad</span><span class=p>,</span> <span class=mh>0x35</span><span class=p>,</span> <span class=mh>0x85</span><span class=p>,</span> <span class=mh>0xe2</span><span class=p>,</span> <span class=mh>0xf9</span><span class=p>,</span> <span class=mh>0x37</span><span class=p>,</span> <span class=mh>0xe8</span><span class=p>,</span> <span class=mh>0x1c</span><span class=p>,</span> <span class=mh>0x75</span><span class=p>,</span> <span class=mh>0xdf</span><span class=p>,</span> <span class=mh>0x6e</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x47</span><span class=p>,</span> <span class=mh>0xf1</span><span class=p>,</span> <span class=mh>0x1a</span><span class=p>,</span> <span class=mh>0x71</span><span class=p>,</span> <span class=mh>0x1d</span><span class=p>,</span> <span class=mh>0x29</span><span class=p>,</span> <span class=mh>0xc5</span><span class=p>,</span> <span class=mh>0x89</span><span class=p>,</span> <span class=mh>0x6f</span><span class=p>,</span> <span class=mh>0xb7</span><span class=p>,</span> <span class=mh>0x62</span><span class=p>,</span> <span class=mh>0x0e</span><span class=p>,</span> <span class=mh>0xaa</span><span class=p>,</span> <span class=mh>0x18</span><span class=p>,</span> <span class=mh>0xbe</span><span class=p>,</span> <span class=mh>0x1b</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0xfc</span><span class=p>,</span> <span class=mh>0x56</span><span class=p>,</span> <span class=mh>0x3e</span><span class=p>,</span> <span class=mh>0x4b</span><span class=p>,</span> <span class=mh>0xc6</span><span class=p>,</span> <span class=mh>0xd2</span><span class=p>,</span> <span class=mh>0x79</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x9a</span><span class=p>,</span> <span class=mh>0xdb</span><span class=p>,</span> <span class=mh>0xc0</span><span class=p>,</span> <span class=mh>0xfe</span><span class=p>,</span> <span class=mh>0x78</span><span class=p>,</span> <span class=mh>0xcd</span><span class=p>,</span> <span class=mh>0x5a</span><span class=p>,</span> <span class=mh>0xf4</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x1f</span><span class=p>,</span> <span class=mh>0xdd</span><span class=p>,</span> <span class=mh>0xa8</span><span class=p>,</span> <span class=mh>0x33</span><span class=p>,</span> <span class=mh>0x88</span><span class=p>,</span> <span class=mh>0x07</span><span class=p>,</span> <span class=mh>0xc7</span><span class=p>,</span> <span class=mh>0x31</span><span class=p>,</span> <span class=mh>0xb1</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>,</span> <span class=mh>0x59</span><span class=p>,</span> <span class=mh>0x27</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0xec</span><span class=p>,</span> <span class=mh>0x5f</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x60</span><span class=p>,</span> <span class=mh>0x51</span><span class=p>,</span> <span class=mh>0x7f</span><span class=p>,</span> <span class=mh>0xa9</span><span class=p>,</span> <span class=mh>0x19</span><span class=p>,</span> <span class=mh>0xb5</span><span class=p>,</span> <span class=mh>0x4a</span><span class=p>,</span> <span class=mh>0x0d</span><span class=p>,</span> <span class=mh>0x2d</span><span class=p>,</span> <span class=mh>0xe5</span><span class=p>,</span> <span class=mh>0x7a</span><span class=p>,</span> <span class=mh>0x9f</span><span class=p>,</span> <span class=mh>0x93</span><span class=p>,</span> <span class=mh>0xc9</span><span class=p>,</span> <span class=mh>0x9c</span><span class=p>,</span> <span class=mh>0xef</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0xa0</span><span class=p>,</span> <span class=mh>0xe0</span><span class=p>,</span> <span class=mh>0x3b</span><span class=p>,</span> <span class=mh>0x4d</span><span class=p>,</span> <span class=mh>0xae</span><span class=p>,</span> <span class=mh>0x2a</span><span class=p>,</span> <span class=mh>0xf5</span><span class=p>,</span> <span class=mh>0xb0</span><span class=p>,</span> <span class=mh>0xc8</span><span class=p>,</span> <span class=mh>0xeb</span><span class=p>,</span> <span class=mh>0xbb</span><span class=p>,</span> <span class=mh>0x3c</span><span class=p>,</span> <span class=mh>0x83</span><span class=p>,</span> <span class=mh>0x53</span><span class=p>,</span> <span class=mh>0x99</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x17</span><span class=p>,</span> <span class=mh>0x2b</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x7e</span><span class=p>,</span> <span class=mh>0xba</span><span class=p>,</span> <span class=mh>0x77</span><span class=p>,</span> <span class=mh>0xd6</span><span class=p>,</span> <span class=mh>0x26</span><span class=p>,</span> <span class=mh>0xe1</span><span class=p>,</span> <span class=mh>0x69</span><span class=p>,</span> <span class=mh>0x14</span><span class=p>,</span> <span class=mh>0x63</span><span class=p>,</span> <span class=mh>0x55</span><span class=p>,</span> <span class=mh>0x21</span><span class=p>,</span> <span class=mh>0x0c</span><span class=p>,</span> <span class=mh>0x7d</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 列混淆常数矩阵</span>
</span></span><span class=line><span class=cl><span class=n>MC</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x03</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>INV_MC</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x0e</span><span class=p>,</span> <span class=mh>0x0b</span><span class=p>,</span> <span class=mh>0x0d</span><span class=p>,</span> <span class=mh>0x09</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x09</span><span class=p>,</span> <span class=mh>0x0e</span><span class=p>,</span> <span class=mh>0x0b</span><span class=p>,</span> <span class=mh>0x0d</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x0d</span><span class=p>,</span> <span class=mh>0x09</span><span class=p>,</span> <span class=mh>0x0e</span><span class=p>,</span> <span class=mh>0x0b</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mh>0x0b</span><span class=p>,</span> <span class=mh>0x0d</span><span class=p>,</span> <span class=mh>0x09</span><span class=p>,</span> <span class=mh>0x0e</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><p>接着是编写一些工具方法，比如将明文按 128 bit 分组，将 128 bit 数据转成 4 x 4 矩阵等等，方便后续加密流程操作。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>明文按照16字节分组, 不足16字节用0填充
</span></span></span><span class=line><span class=cl><span class=s2>密钥长度必须为16字节, 不足16字节用0填充, 超过16字节截断
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 将明文按照16字节分组</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>plaintext_to_blocks</span><span class=p>(</span><span class=n>plaintext</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>blocks</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>plaintext</span><span class=p>),</span> <span class=mi>16</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>block</span> <span class=o>=</span> <span class=n>plaintext</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span> <span class=o>+</span> <span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>block</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>16</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>block</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>16</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>block</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>blocks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>blocks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 确保密钥长度为16字节</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>key_to_16bytes</span><span class=p>(</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>16</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>16</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>key</span><span class=p>[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>无论明文还是密钥都需要将16字节数据转成4*4的矩阵
</span></span></span><span class=line><span class=cl><span class=s2>16字节数据: D1 D2 D3 D4 D5 D6 D7 D8 D9 D10 D11 D12 D13 D14 D15 D16
</span></span></span><span class=line><span class=cl><span class=s2>4*4矩阵数据: D1 D5 D9  D13
</span></span></span><span class=line><span class=cl><span class=s2>            D2 D6 D10 D14
</span></span></span><span class=line><span class=cl><span class=s2>            D3 D7 D11 D15
</span></span></span><span class=line><span class=cl><span class=s2>            D4 D8 D12 D16
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 将16字节数据转成4*4的矩阵</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>bytes_to_matrix</span><span class=p>(</span><span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>matrix</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=n>append</span><span class=p>([])</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>matrix</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>bytes</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>4</span> <span class=o>*</span> <span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>matrix</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将4*4的矩阵转成16字节数据</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>matrix_to_bytes</span><span class=p>(</span><span class=n>matrix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>bytes</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>bytes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>matrix</span><span class=p>[</span><span class=n>j</span><span class=p>][</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>bytes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将4*4矩阵转成1*4的字列表</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>matrix_to_words</span><span class=p>(</span><span class=n>matrix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>words</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>words</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>matrix</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;&lt;</span> <span class=mi>24</span> <span class=o>|</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;&lt;</span> <span class=mi>16</span> <span class=o>|</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span> <span class=o>|</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>words</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将1*4的字列表转成4*4矩阵</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>words_to_matrix</span><span class=p>(</span><span class=n>words</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>matrix</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>matrix</span><span class=o>.</span><span class=n>append</span><span class=p>([])</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>matrix</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>words</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=p>(</span><span class=mi>24</span> <span class=o>-</span> <span class=mi>8</span> <span class=o>*</span> <span class=n>i</span><span class=p>))</span> <span class=o>&amp;</span> <span class=mh>0xff</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>matrix</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将一个字转成4个字节列表</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>word_to_bytes</span><span class=p>(</span><span class=n>word</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>bytes</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>bytes</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>word</span> <span class=o>&gt;&gt;</span> <span class=p>(</span><span class=mi>24</span> <span class=o>-</span> <span class=mi>8</span> <span class=o>*</span> <span class=n>i</span><span class=p>))</span> <span class=o>&amp;</span> <span class=mh>0xff</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>bytes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将4个字节列表转成一个字</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>bytes_to_word</span><span class=p>(</span><span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>word</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>word</span> <span class=o>|=</span> <span class=nb>bytes</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=mi>24</span> <span class=o>-</span> <span class=mi>8</span> <span class=o>*</span> <span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>word</span>
</span></span></code></pre></div><hr><p>做好以上这些准备操作，下面开始编写算法流程，第一步先编写密钥扩展流程。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>1. 密钥扩展: 将初始16字节密钥扩展成R0-R10共11个16字节的轮密钥
</span></span></span><span class=line><span class=cl><span class=s2>将初始密钥转成4*4的矩阵, 按列排列得到4个4字节的字 w0 w1 w2 w3
</span></span></span><span class=line><span class=cl><span class=s2>将w3的每个字节左移一位, b0 b1 b2 b3 -&gt; b1 b2 b3 b0
</span></span></span><span class=line><span class=cl><span class=s2>将w3的每个字节高4位作为行索引, 低4位作为列索引, 进行S盒替换得到 b1&#39; b2&#39; b3&#39; b0&#39;
</span></span></span><span class=line><span class=cl><span class=s2>将b1&#39; b2&#39; b3&#39; b0&#39; 与轮常量RC[j/4] 0 0 0进行异或得到 w3&#39;
</span></span></span><span class=line><span class=cl><span class=s2>w4 = w0 ^ w3&#39;, w5 = w1 ^ w4, w6 = w2 ^ w5, w7 = w3 ^ w6, ...
</span></span></span><span class=line><span class=cl><span class=s2>不断循环重复上述过程, 直到得到11个16字节的轮密钥, w44 w45 w46 w47
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>key_expansion</span><span class=p>(</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 确保密钥长度为16字节</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>key_to_16bytes</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 将密钥转成4*4的矩阵</span>
</span></span><span class=line><span class=cl>    <span class=n>key_matrix</span> <span class=o>=</span> <span class=n>bytes_to_matrix</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 按列排列得到4个4字节的字 w0 w1 w2 w3</span>
</span></span><span class=line><span class=cl>    <span class=n>old_words</span> <span class=o>=</span> <span class=n>matrix_to_words</span><span class=p>(</span><span class=n>key_matrix</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># R0-R10共11个16字节的轮密钥</span>
</span></span><span class=line><span class=cl>    <span class=n>round_keys</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>round_keys</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>key_matrix</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>words</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>old_bytes</span> <span class=o>=</span> <span class=n>word_to_bytes</span><span class=p>(</span><span class=n>old_words</span><span class=p>[</span><span class=mi>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=c1># 将w3每个字节左移一位, b0 b1 b2 b3 -&gt; b1 b2 b3 b0</span>
</span></span><span class=line><span class=cl>        <span class=n>old_bytes</span> <span class=o>=</span> <span class=p>[</span><span class=n>old_bytes</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>old_bytes</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>old_bytes</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span> <span class=n>old_bytes</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>        <span class=c1># 字节代换</span>
</span></span><span class=line><span class=cl>        <span class=nb>bytes</span> <span class=o>=</span> <span class=n>sub_bytes_bytes</span><span class=p>(</span><span class=n>old_bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 将b1&#39; b2&#39; b3&#39; b0&#39; 与轮常量RC[j/4] 0 0 0进行异或得到 w3&#39;</span>
</span></span><span class=line><span class=cl>        <span class=nb>bytes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>^</span> <span class=n>RC</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1># w4 = w0 ^ w0&#39;, w5 = w1 ^ w4, w6 = w2 ^ w5, w7 = w3 ^ w6,...</span>
</span></span><span class=line><span class=cl>        <span class=n>words</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=n>bytes_to_word</span><span class=p>(</span><span class=nb>bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>words</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>old_words</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>^</span> <span class=n>words</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>words</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>old_words</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>^</span> <span class=n>words</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>words</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>old_words</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>^</span> <span class=n>words</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>  
</span></span><span class=line><span class=cl>        <span class=n>words</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=n>old_words</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>^</span> <span class=n>words</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1># 将w4 w5 w6 w7 转成4*4的矩阵, 得到轮密钥</span>
</span></span><span class=line><span class=cl>        <span class=n>round_keys</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>words_to_matrix</span><span class=p>(</span><span class=n>words</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=c1># 将w4 w5 w6 w7 作为下一轮的w0 w1 w2 w3</span>
</span></span><span class=line><span class=cl>        <span class=n>old_words</span> <span class=o>=</span> <span class=n>words</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>round_keys</span>
</span></span></code></pre></div><p>第二步是编写字节代换流程。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>2. 字节代换: 将4*4的矩阵中的每个字节进行S盒替换
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 4*4的矩阵中的每个字节进行S盒替换</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sub_bytes</span><span class=p>(</span><span class=n>matrix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 将每个字节中的高4位作为行索引, 低4位作为列索引, 进行S盒替换</span>
</span></span><span class=line><span class=cl>            <span class=n>matrix</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>S</span><span class=p>[</span><span class=n>matrix</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=mi>4</span><span class=p>][</span><span class=n>matrix</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mh>0x0f</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>matrix</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 密钥扩展中 将 1*4 bytes列表中的每个字节进行S盒替换</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sub_bytes_bytes</span><span class=p>(</span><span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>bytes</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>S</span><span class=p>[</span><span class=nb>bytes</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=mi>4</span><span class=p>][</span><span class=nb>bytes</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mh>0x0f</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>bytes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 逆S盒替换</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>inv_sub_bytes</span><span class=p>(</span><span class=n>matrix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 将每个字节中的高4位作为行索引, 低4位作为列索引, 进行逆S盒替换</span>
</span></span><span class=line><span class=cl>            <span class=n>matrix</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>INV_S</span><span class=p>[</span><span class=n>matrix</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=mi>4</span><span class=p>][</span><span class=n>matrix</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mh>0x0f</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>matrix</span>
</span></span></code></pre></div><p>接着编写行移位流程。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>3. 行移位: 将4*4的矩阵中的每一行进行循环左移
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 4*4的矩阵中 第一行不变, 第二行左移1位, 第三行左移2位, 第四行左移3位</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>shift_rows</span><span class=p>(</span><span class=n>matrix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>matrix</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>matrix</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=n>matrix</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>matrix</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>1</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=n>matrix</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>matrix</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>2</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>matrix</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 逆行移位</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>inv_shift_rows</span><span class=p>(</span><span class=n>matrix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>matrix</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>matrix</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>2</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=n>matrix</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>matrix</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>1</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=n>matrix</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>matrix</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>0</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>matrix</span>
</span></span></code></pre></div><p>这些流程都比较简单，根据各个部分的原理图就可以很简单地编写出来，下面应该整个 AES 算法中最复杂的部分之一，<strong class=chinese>列混淆</strong>。</p><p>列混淆的难点在于其中的乘法运算是在 GF (2^8) 上进行的，这在代码中实现还是有一些难度的，下面提供了两种 GF (2^8) 乘法运算的实现方式。</p><ul><li>思路 1（<code>multiply1</code>）：看成移动比特串</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>左乘 0x01 表示不变
</span></span><span class=line><span class=cl>左乘 0x02 表示左移1位
</span></span><span class=line><span class=cl>左乘 0x03 表示左移1位, 再异或自己<span class=o>(</span><span class=nv>0x03</span> <span class=o>=</span> 0x01 + 0x02<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nv>a</span> <span class=o>=</span> <span class=nv>0x02</span> <span class=o>=</span> 左移1位, <span class=nv>b</span> <span class=o>=</span> <span class=nv>0xc9</span> <span class=o>=</span> 0b11001001
</span></span><span class=line><span class=cl>a * <span class=nv>b</span> <span class=o>=</span> 0b11001001左移一位, 且因为最高位为1, 还需模2^8 <span class=o>=</span> 0b10010010 ^ <span class=nv>0x11b</span> <span class=o>=</span> <span class=nv>0b10001001</span> <span class=o>=</span> 0x89
</span></span></code></pre></div><ul><li>思路 2（<code>multiply2</code>）：逐位处理，模拟乘法</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>将 b 不断右移取最低位, a 不断左移
</span></span><span class=line><span class=cl><span class=nv>a</span> <span class=o>=</span> <span class=nv>0x03</span> <span class=o>=</span> 0b00000011, <span class=nv>b</span> <span class=o>=</span> <span class=nv>0x07</span> <span class=o>=</span> 0b00000111
</span></span><span class=line><span class=cl>a <span class=nv>左移0位</span> <span class=o>=</span> 0b00000011, <span class=nv>左移1位</span> <span class=o>=</span> 0b00000110, <span class=nv>左移2位</span> <span class=o>=</span> 0b00001100
</span></span><span class=line><span class=cl>b <span class=nv>右边第1位</span> <span class=o>=</span> 1, <span class=nv>右边第2位</span> <span class=o>=</span> 1, <span class=nv>右边第3位</span> <span class=o>=</span> 1, 其次为0
</span></span><span class=line><span class=cl><span class=m>1</span> * 0b00000011 ^ <span class=m>1</span> * 0b00000110 ^ <span class=m>1</span> * <span class=nv>0b00001100</span> <span class=o>=</span> <span class=nv>0b00001001</span> <span class=o>=</span> 0x09
</span></span><span class=line><span class=cl>如果 a 左移后最高位为1, 则需要模2^8 <span class=o>=</span> 0x11b
</span></span><span class=line><span class=cl>模拟乘法:
</span></span><span class=line><span class=cl>    0b00000011
</span></span><span class=line><span class=cl>  * 0b00000111
</span></span><span class=line><span class=cl>    ----------
</span></span><span class=line><span class=cl>    0b00000011
</span></span><span class=line><span class=cl>  ^ 0b00000110
</span></span><span class=line><span class=cl>  ^ 0b00001100
</span></span><span class=line><span class=cl>    ----------
</span></span><span class=line><span class=cl>  <span class=o>=</span> <span class=nv>0b00001001</span> <span class=o>=</span> 0x09
</span></span></code></pre></div><p>整体代码实现：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>4. 列混淆: 将4*4的矩阵中的每一列进行列混合运算
</span></span></span><span class=line><span class=cl><span class=s2>4*4的矩阵左乘一个固定的矩阵c(x), 得到新的矩阵
</span></span></span><span class=line><span class=cl><span class=s2>c(x) = 02 03 01 01
</span></span></span><span class=line><span class=cl><span class=s2>       01 02 03 01
</span></span></span><span class=line><span class=cl><span class=s2>       01 01 02 03
</span></span></span><span class=line><span class=cl><span class=s2>       03 01 01 02
</span></span></span><span class=line><span class=cl><span class=s2>乘法在GF(2^8)上进行, 即 f*g mod (x^8 + x^4 + x^3 + x + 1)
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 4*4的矩阵中的每一列进行列混淆运算</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mix_columns</span><span class=p>(</span><span class=n>matrix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>new_matrix</span> <span class=o>=</span> <span class=p>[[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>new_matrix</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>mix_column</span><span class=p>(</span><span class=n>matrix</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>new_matrix</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 列混淆运算</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mix_column</span><span class=p>(</span><span class=n>matrix</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>^=</span> <span class=n>multiply2</span><span class=p>(</span><span class=n>MC</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>k</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 逆列混淆</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>inv_mix_columns</span><span class=p>(</span><span class=n>matrix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>new_matrix</span> <span class=o>=</span> <span class=p>[[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>new_matrix</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>inv_mix_column</span><span class=p>(</span><span class=n>matrix</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>new_matrix</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 逆列混淆运算</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>inv_mix_column</span><span class=p>(</span><span class=n>matrix</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>^=</span> <span class=n>multiply2</span><span class=p>(</span><span class=n>INV_MC</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>k</span><span class=p>],</span> <span class=n>matrix</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># GF(2^8)上的乘法运算</span>
</span></span><span class=line><span class=cl><span class=c1># 思路1</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>multiply1</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>a</span> <span class=o>==</span> <span class=mh>0x01</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>a</span> <span class=o>==</span> <span class=mh>0x02</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>b</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span> 
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>b</span> <span class=o>&amp;</span> <span class=mh>0x80</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>^=</span> <span class=mh>0x11b</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>a</span> <span class=o>==</span> <span class=mh>0x03</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>b</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>b</span> <span class=o>&amp;</span> <span class=mh>0x80</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>^=</span> <span class=mh>0x11b</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span> <span class=o>^</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;Invalid multiplication factor&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 思路2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>multiply2</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span> <span class=c1># 初始化结果为 0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span> <span class=c1># 循环 8 次，因为每个字节有 8 位</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>b</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>:</span> <span class=c1># 检查 b 的最低位是否为 1</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>^=</span> <span class=n>a</span> <span class=c1># 如果最低位为 1，则将 a 异或到结果中</span>
</span></span><span class=line><span class=cl>        <span class=n>a</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span> <span class=c1># 将 a 左移一位</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>a</span> <span class=o>&amp;</span> <span class=mh>0x100</span><span class=p>:</span> <span class=c1># 检查 a 左移后是否溢出（即最高位是否为 1）</span>
</span></span><span class=line><span class=cl>            <span class=n>a</span> <span class=o>^=</span> <span class=mh>0x11b</span> <span class=c1># 如果溢出，则对 a 进行模运算，即异或 0x11b</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>&gt;&gt;=</span> <span class=mi>1</span>  <span class=c1># 将 b 右移一位，准备检查下一位</span>
</span></span><span class=line><span class=cl>    <span class=c1># 返回最终的乘法结果</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span>
</span></span></code></pre></div><p>轮密钥加操作则十分简单。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>5. 轮密钥加: 将4*4的矩阵中的每个字节与轮密钥中的对应字节进行异或
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add_round_key</span><span class=p>(</span><span class=n>matrix</span><span class=p>,</span> <span class=n>round_key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>matrix</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>^=</span> <span class=n>round_key</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>matrix</span>
</span></span></code></pre></div><hr><p>完成了算法各个部分的流程实现，最后就是加密解密和验证操作了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 加密操作</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt</span><span class=p>(</span><span class=n>plaintext</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 将明文按照16字节分组</span>
</span></span><span class=line><span class=cl>    <span class=n>blocks</span> <span class=o>=</span> <span class=n>plaintext_to_blocks</span><span class=p>(</span><span class=n>plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 密钥扩展</span>
</span></span><span class=line><span class=cl>    <span class=n>round_keys</span> <span class=o>=</span> <span class=n>key_expansion</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 加密</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphertext</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>block</span> <span class=ow>in</span> <span class=n>blocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 将16字节数据转成4*4的矩阵</span>
</span></span><span class=line><span class=cl>        <span class=n>block_matrix</span> <span class=o>=</span> <span class=n>bytes_to_matrix</span><span class=p>(</span><span class=n>block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># R0 轮密钥加</span>
</span></span><span class=line><span class=cl>        <span class=n>block_matrix</span> <span class=o>=</span> <span class=n>add_round_key</span><span class=p>(</span><span class=n>block_matrix</span><span class=p>,</span> <span class=n>round_keys</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=c1># R1-R10 轮, R10 轮不进行列混淆</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>11</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 字节代换</span>
</span></span><span class=line><span class=cl>            <span class=n>block_matrix</span> <span class=o>=</span> <span class=n>sub_bytes</span><span class=p>(</span><span class=n>block_matrix</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 行移位</span>
</span></span><span class=line><span class=cl>            <span class=n>block_matrix</span> <span class=o>=</span> <span class=n>shift_rows</span><span class=p>(</span><span class=n>block_matrix</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 列混淆</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>i</span> <span class=o>!=</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>block_matrix</span> <span class=o>=</span> <span class=n>mix_columns</span><span class=p>(</span><span class=n>block_matrix</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 轮密钥加</span>
</span></span><span class=line><span class=cl>            <span class=n>block_matrix</span> <span class=o>=</span> <span class=n>add_round_key</span><span class=p>(</span><span class=n>block_matrix</span><span class=p>,</span> <span class=n>round_keys</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=c1># ECB模式: 将每组密文拼接在一起 转成16进制</span>
</span></span><span class=line><span class=cl>        <span class=n>ciphertext</span> <span class=o>+=</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>matrix_to_bytes</span><span class=p>(</span><span class=n>block_matrix</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ciphertext</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 解密操作</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 将密文按照16字节分组</span>
</span></span><span class=line><span class=cl>    <span class=n>blocks</span> <span class=o>=</span> <span class=n>plaintext_to_blocks</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 密钥扩展</span>
</span></span><span class=line><span class=cl>    <span class=n>round_keys</span> <span class=o>=</span> <span class=n>key_expansion</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 解密</span>
</span></span><span class=line><span class=cl>    <span class=n>plaintext</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>block</span> <span class=ow>in</span> <span class=n>blocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 将16字节数据转成4*4的矩阵</span>
</span></span><span class=line><span class=cl>        <span class=n>block_matrix</span> <span class=o>=</span> <span class=n>bytes_to_matrix</span><span class=p>(</span><span class=n>block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># R10-R1 轮, R10 轮不进行列混淆</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 轮密钥加</span>
</span></span><span class=line><span class=cl>            <span class=n>block_matrix</span> <span class=o>=</span> <span class=n>add_round_key</span><span class=p>(</span><span class=n>block_matrix</span><span class=p>,</span> <span class=n>round_keys</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=c1># 列混淆</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>i</span><span class=o>!=</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>block_matrix</span> <span class=o>=</span> <span class=n>inv_mix_columns</span><span class=p>(</span><span class=n>block_matrix</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 逆行移位</span>
</span></span><span class=line><span class=cl>            <span class=n>block_matrix</span> <span class=o>=</span> <span class=n>inv_shift_rows</span><span class=p>(</span><span class=n>block_matrix</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 逆字节代换</span>
</span></span><span class=line><span class=cl>            <span class=n>block_matrix</span> <span class=o>=</span> <span class=n>inv_sub_bytes</span><span class=p>(</span><span class=n>block_matrix</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># R0 轮密钥加</span>
</span></span><span class=line><span class=cl>        <span class=n>block_matrix</span> <span class=o>=</span> <span class=n>add_round_key</span><span class=p>(</span><span class=n>block_matrix</span><span class=p>,</span> <span class=n>round_keys</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=c1># ECB模式: 将每组明文拼接在一起 转成16进制</span>
</span></span><span class=line><span class=cl>        <span class=n>plaintext</span> <span class=o>+=</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>matrix_to_bytes</span><span class=p>(</span><span class=n>block_matrix</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>plaintext</span>
</span></span></code></pre></div><p>验证代码是否正确。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt_test</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># test case 1</span>
</span></span><span class=line><span class=cl>        <span class=n>plaintext</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;00112233445566778899AABBCCDDEEFF&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;2B7E151628AED2A6ABF7158809CF4F3C&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ciphertext</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>plaintext</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>ciphertext</span> <span class=o>==</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;8DF4E9AAC5C7573A27D8D055D6E4D64B&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># test case 2</span>
</span></span><span class=line><span class=cl>        <span class=n>plaintext</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;34F61A19C754110DA892362BAC078B99&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;0123456789ABCDEF0123456789ABCDEF&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ciphertext</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>plaintext</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>ciphertext</span> <span class=o>==</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;5CFB2FD936BB4F0E372A8246044183E2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># test case 3</span>
</span></span><span class=line><span class=cl>        <span class=n>plaintext</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;11111111111111111111111111111111&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ciphertext</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>plaintext</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>ciphertext</span> <span class=o>==</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;24E08A84E6D1C9FD104A2BEB32D783D5&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># test case 4</span>
</span></span><span class=line><span class=cl>        <span class=n>plaintext</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;12345678123456781234567812345678&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;12345678123456781234567812345678&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ciphertext</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>plaintext</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>ciphertext</span> <span class=o>==</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;D7EEEE18C420FAF0DC7DB5CA73A2B817&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># test case 5</span>
</span></span><span class=line><span class=cl>        <span class=n>plaintext</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;3243F6A8885A308D313198A2E0370734&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;2B7E151628AED2A6ABF7158809CF4F3C&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ciphertext</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>plaintext</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>ciphertext</span> <span class=o>==</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;3925841D02DC09FBDC118597196A0B32&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>AssertionError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;X encrypt test failed X&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;√ encrypt test passed √&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt_test</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># test case 1</span>
</span></span><span class=line><span class=cl>        <span class=n>ciphertext</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;8DF4E9AAC5C7573A27D8D055D6E4D64B&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;2B7E151628AED2A6ABF7158809CF4F3C&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>plaintext</span> <span class=o>=</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>plaintext</span> <span class=o>==</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;00112233445566778899AABBCCDDEEFF&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># test case 2</span>
</span></span><span class=line><span class=cl>        <span class=n>ciphertext</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;5CFB2FD936BB4F0E372A8246044183E2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;0123456789ABCDEF0123456789ABCDEF&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>plaintext</span> <span class=o>=</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>plaintext</span> <span class=o>==</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;34F61A19C754110DA892362BAC078B99&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># test case 3</span>
</span></span><span class=line><span class=cl>        <span class=n>ciphertext</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;24E08A84E6D1C9FD104A2BEB32D783D5&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;11111111111111111111111111111111&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>plaintext</span> <span class=o>=</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>plaintext</span> <span class=o>==</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># test case 4</span>
</span></span><span class=line><span class=cl>        <span class=n>ciphertext</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;D7EEEE18C420FAF0DC7DB5CA73A2B817&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;12345678123456781234567812345678&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>plaintext</span> <span class=o>=</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>plaintext</span> <span class=o>==</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;12345678123456781234567812345678&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># test case 5</span>
</span></span><span class=line><span class=cl>        <span class=n>ciphertext</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;3925841D02DC09FBDC118597196A0B32&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;2B7E151628AED2A6ABF7158809CF4F3C&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>plaintext</span> <span class=o>=</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>plaintext</span> <span class=o>==</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;3243F6A8885A308D313198A2E0370734&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>AssertionError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;X decrypt test failed X&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;√ decrypt test passed √&#34;</span><span class=p>)</span>
</span></span></code></pre></div></article><div class=paginator><a class=link href=https://blog.pi3.fun/post/2025/04/kunming-trip/>← prev</a>
<a class=link href=https://blog.pi3.fun/post/2025/05/aes-128-quantum-implementation/>next →</a></div><div class=comment><div id=tcomment></div><script src=https://registry.npmmirror.com/twikoo/1.6.39/files/dist/twikoo.min.js></script><script async>twikoo.init({envId:"https://twikoo.pi3.fun/.netlify/functions/twikoo",el:"#tcomment",lang:"zh-CN"})</script></div></main><footer id=footer><div><span style=display:flex;align-items:center><span style=margin-right:.5rem>© 2021 - 2025</span><img src=https://cdn.pi3.fun/static/rainbow.gif loading=lazy width=20 alt=rainbow><span style=margin-left:.5rem>By Liu Chao</span></span></div><div class=footnote><span><a href=https://www.foreverblog.cn/ target=_blank><img src=https://img.foreverblog.cn/logo_en_default.png style=width:auto;height:16px></a> | <a data-accent-color href=https://www.boyouquan.com/ style="font-size:16px;background-image:linear-gradient(to right,#14100f,#d55b5b,#4d14e6);background-clip:text;color:transparent">博友圈</a><br><a class=link href=/index.xml><span class="iconfont icon-RSS"></span></a> | <a class=link href=https://github.com/Pi3-l22 target=_ blank><span class="iconfont icon-GitHub"></span></a> | <a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener><span class="iconfont icon-creative-commons-fill"></span></a></span></div><div class=blog-icon></div></footer></div><script>document.addEventListener("DOMContentLoaded",function(){const n=localStorage.getItem("theme")||"light",e=document.querySelector('link[data-theme-style="light"]'),t=document.querySelector('link[data-theme-style="dark"]'),i=window.matchMedia("(prefers-color-scheme: dark)");i.addListener(function(n){if(!localStorage.getItem("theme")){const s=n.matches?"dark":"light";document.documentElement.setAttribute("data-theme",s),localStorage.setItem("theme",s),s==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");const o=document.querySelector("iframe.giscus-frame");if(o){const e=s==="light"?"light_tritanopia":"dark_tritanopia";o.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}}}),n==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");function o(){const e=document.querySelector("iframe.giscus-frame");if(e){const t=n==="light"?"light_tritanopia":"dark_tritanopia";e.contentWindow.postMessage({giscus:{setConfig:{theme:t}}},"https://giscus.app")}else setTimeout(o,1e3)}o();const s=document.querySelector(".theme-toggle");s&&(s.textContent=n==="light"?"黑暗":"明亮",s.addEventListener("click",function(){const o=document.documentElement.getAttribute("data-theme"),n=o==="light"?"dark":"light";document.documentElement.setAttribute("data-theme",n),localStorage.setItem("theme",n),n==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");const s=document.querySelector("iframe.giscus-frame");if(s){const e=n==="light"?"light_tritanopia":"dark_tritanopia";s.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}this.textContent=n==="light"?"黑暗":"明亮"}))})</script><script src=https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){confetti({particleCount:150,spread:100})})</script></body></html>