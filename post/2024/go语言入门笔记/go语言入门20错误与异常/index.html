<!doctype html><html lang=zh-cn><head><script>(function(){const e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)})()</script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=author content="LiuChao"><meta name=description content="Go 语言入门基础学习笔记之 Go 语言的错误与异常"><link rel=icon href=https://blog.pi3.fun/favicon.ico><meta name=keywords content=" study  latex  life  academic "><meta property="og:url" content="https://blog.pi3.fun/post/2024/go%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/go%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A820%E9%94%99%E8%AF%AF%E4%B8%8E%E5%BC%82%E5%B8%B8/"><meta property="og:site_name" content="Pi3's Notes"><meta property="og:title" content="Go语言入门20：错误与异常"><meta property="og:description" content="Go 语言入门基础学习笔记之 Go 语言的错误与异常"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-11-26T00:00:00+00:00"><meta property="article:modified_time" content="2024-11-26T00:00:00+00:00"><meta property="article:tag" content="技术"><meta property="article:tag" content="Golang"><meta property="article:tag" content="Go 入门笔记"><link rel=canonical href=https://blog.pi3.fun/post/2024/go%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/go%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A820%E9%94%99%E8%AF%AF%E4%B8%8E%E5%BC%82%E5%B8%B8/><meta itemprop=name content="Go语言入门20：错误与异常"><meta itemprop=description content="Go 语言入门基础学习笔记之 Go 语言的错误与异常"><meta itemprop=datePublished content="2024-11-26T00:00:00+00:00"><meta itemprop=dateModified content="2024-11-26T00:00:00+00:00"><meta itemprop=wordCount content="2372"><meta itemprop=keywords content="技术,Golang,Go 入门笔记"><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/common.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/content.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/theme.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/iconfont/iconfont.css><link rel=stylesheet href=https://blog.pi3.fun/css/syntax/xcode.css data-theme-style=light media="(prefers-color-scheme: light)"><link rel=stylesheet href=https://blog.pi3.fun/css/syntax/catppuccin-mocha.css data-theme-style=dark media="not all"><title>Go语言入门20：错误与异常 - Pi3's Notes</title>
<link rel=stylesheet href=https://blog.pi3.fun/css/single.css><link href=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/katex.min.css rel=stylesheet><script defer src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/katex.min.js></script><script defer src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}],ignoredTags:["script","noscript","style","textarea","pre","code","option"],throwOnError:!1})})</script></head><body><div id=wrapper><header id=header><h1><a href=https://blog.pi3.fun/>Pi3's Notes</a></h1><nav><span class=nav-bar-item><a class=link href=/>文章</a>
</span><span class=nav-bar-item><a class=link href=/post/>归档</a>
</span><span class=nav-bar-item><a class=link href=/about/>关于</a>
</span><span class=nav-bar-item><a class=link href=/links/>友链</a>
</span><span class=nav-bar-item><a class="link theme-toggle" href=javascript:void(0);>黑暗</a></span></nav></header><main id=main class=post><h1>Go语言入门20：错误与异常</h1><div><b>Keywords: </b><a class=link href=https://blog.pi3.fun/tags/%E6%8A%80%E6%9C%AF>#技术</a>
<a class=link href=https://blog.pi3.fun/tags/golang>#Golang</a>
<a class=link href=https://blog.pi3.fun/tags/go-%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0>#Go 入门笔记</a></div><details><summary><b>Table of Contents</b></summary><div class=toc><nav id=TableOfContents><ul><li><a href=#错误处理>错误处理</a></li><li><a href=#异常处理>异常处理</a><ul><li><a href=#使用场景>使用场景</a></li><li><a href=#基本用法>基本用法</a></li><li><a href=#注意事项>注意事项</a></li><li><a href=#示例代码>示例代码</a></li><li><a href=#其他知识点>其他知识点</a></li></ul></li></ul></nav></div></details><article class=content><p>Go 语言入门基础学习笔记之 Go 语言的错误与异常处理</p><p><img src=https://cdn.pi3.fun/blog/golang.png alt=golang></p><h2 id=错误处理>错误处理</h2><p>Go 语言通过内置的错误接口提供了非常简单的错误处理机制。</p><p>error 类型是一个接口类型，这是它的定义：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=kt>error</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>Error</span><span class=p>()</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>我们可以在编码中通过实现 error 接口类型来生成错误信息。</p><p>函数通常在最后的返回值中返回错误信息。使用 <code>errors.New</code> 可返回一个错误信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Sqrt</span><span class=p>(</span><span class=nx>f</span> <span class=kt>float64</span><span class=p>)</span> <span class=p>(</span><span class=kt>float64</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>f</span> <span class=p>&lt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;math: square root of negative number&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 实现
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>在下面的例子中，我们在调用 <code>Sqrt</code> 的时候传递的一个负数，然后就得到了 <code>non-nil</code> 的 <code>error</code> 对象，将此对象与 <code>nil</code> 比较，结果为 <code>true</code>，所以 <code>fmt.Println</code> （fmt 包在处理 error 时会调用 Error 方法）被调用，以输出错误，请看下面调用的示例代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>result</span><span class=p>,</span> <span class=nx>err</span><span class=o>:=</span> <span class=nf>Sqrt</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>// 定义一个 DivideError 结构体，用于表示除法错误
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>DivideError</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>dividee</span> <span class=kt>int</span> <span class=c1>// 被除数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>divider</span>  <span class=kt>int</span> <span class=c1>// 除数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 实现 `error` 接口的 Error 方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>de</span> <span class=o>*</span><span class=nx>DivideError</span><span class=p>)</span> <span class=nf>Error</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 定义错误信息的格式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>strFormat</span> <span class=o>:=</span> <span class=s>`
</span></span></span><span class=line><span class=cl><span class=s>    Cannot proceed, the divider is zero.
</span></span></span><span class=line><span class=cl><span class=s>    dividee: %d
</span></span></span><span class=line><span class=cl><span class=s>    divider: 0
</span></span></span><span class=line><span class=cl><span class=s>`</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 返回格式化的错误信息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>strFormat</span><span class=p>,</span> <span class=nx>de</span><span class=p>.</span><span class=nx>dividee</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 定义 `int` 类型除法运算的函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Divide</span><span class=p>(</span><span class=nx>varDividee</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>varDivider</span> <span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=nx>result</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>errorMsg</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 检查除数是否为零
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>varDivider</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 创建 DivideError 实例并填充数据
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>dData</span> <span class=o>:=</span> <span class=nx>DivideError</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>dividee</span><span class=p>:</span> <span class=nx>varDividee</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>divider</span><span class=p>:</span> <span class=nx>varDivider</span><span class=p>,</span> <span class=c1>// 除数为零
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 Error 方法获取错误信息
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>errorMsg</span> <span class=p>=</span> <span class=nx>dData</span><span class=p>.</span><span class=nf>Error</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=c1>// 返回结果为 0，错误信息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 正常情况下返回计算结果和空错误信息
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nx>varDividee</span> <span class=o>/</span> <span class=nx>varDivider</span><span class=p>,</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 正常情况：进行除法运算
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>errorMsg</span> <span class=o>:=</span> <span class=nf>Divide</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>10</span><span class=p>);</span> <span class=nx>errorMsg</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果没有错误，则打印结果
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;100/10 = &#34;</span><span class=p>,</span> <span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 当除数为零的时候会返回错误信息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>errorMsg</span> <span class=o>:=</span> <span class=nf>Divide</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span> <span class=nx>errorMsg</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果有错误，则打印错误信息
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;errorMsg is: &#34;</span><span class=p>,</span> <span class=nx>errorMsg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 输出结果
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>100</span><span class=o>/</span><span class=mi>10</span> <span class=p>=</span>  <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=nx>errorMsg</span> <span class=nx>is</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>    <span class=nx>Cannot</span> <span class=nx>proceed</span><span class=p>,</span> <span class=nx>the</span> <span class=nx>divider</span> <span class=nx>is</span> <span class=nx>zero</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=nx>dividee</span><span class=p>:</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    <span class=nx>divider</span><span class=p>:</span> <span class=mi>0</span>
</span></span></code></pre></div><h2 id=异常处理>异常处理</h2><p>在 Go 语言中，<code>panic</code> 是一种用于处理程序中意外情况的机制。当程序遇到严重错误或无法继续执行的情况时，可以使用 <code>panic</code> 来引发一个错误。引发 <code>panic</code> 会导致程序的正常执行流程中断，并开始执行延迟（defer）函数，最终导致程序崩溃。</p><p>Golang 没有结构化异常，使用 panic 抛出错误，recover 捕获错误。</p><p>异常的使用场景简单描述：Go 中可以抛出一个 panic 的异常，然后在 defer 中通过 recover 捕获这个异常，然后正常处理。</p><h3 id=使用场景>使用场景</h3><p><code>panic</code> 通常用于以下情况：</p><ol><li><strong class=chinese>不可恢复的错误</strong>：当程序遇到无法处理的错误，例如数组越界、空指针解引用等。</li><li><strong class=chinese>程序内部错误</strong>：例如，逻辑错误或不应该发生的情况。</li></ol><h3 id=基本用法>基本用法</h3><p>你可以使用内置的 <code>panic</code> 函数来引发一个 <code>panic</code>，例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>r</span> <span class=o>:=</span> <span class=nb>recover</span><span class=p>();</span> <span class=nx>r</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Recovered from:&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Starting program...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;Something went wrong!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;This line will not be executed.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ol><li><strong>defer 和 recover</strong>：在上面的例子中，使用 <code>defer</code> 关键字定义了一个恢复函数。当 <code>panic</code> 发生时，<code>recover</code> 函数可以捕获到这个 <code>panic</code> 并防止程序直接崩溃。</li><li><strong>panic</strong>：调用 <code>panic</code> 会引发一个运行时错误，程序的执行会立即停止，直到找到一个 <code>recover</code> 来处理它。</li><li><strong class=chinese>程序崩溃</strong>：如果没有使用 <code>recover</code>，程序会打印出错误信息并退出。</li></ol><h3 id=注意事项>注意事项</h3><ol><li>利用 <code>recover</code> 处理 <code>panic</code> 指令，<code>defer</code> 必须放在 <code>panic</code> 之前定义，另外 <code>recover</code> 只有在 <code>defer</code> 调用的函数中才有效。否则当 <code>panic</code> 时，<code>recover</code> 无法捕获到 <code>panic</code>，无法防止 <code>panic</code> 扩散。</li><li><code>recover</code> 处理异常后，逻辑并不会恢复到 <code>panic</code> 那个点去，函数跑到 <code>defer</code> 之后的那个点。</li><li>多个 <code>defer</code> 会形成 <code>defer</code> 栈，后定义的 <code>defer</code> 语句会被最先调用。</li></ol><hr><p>在 Go 语言中，<code>panic</code> 通常会在以下几种情况下引发错误：</p><ol><li>数组越界</li></ol><p>当尝试访问数组或切片中不存在的索引时，会引发 <code>panic</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>arr</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>int</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>arr</span><span class=p>[</span><span class=mi>3</span><span class=p>])</span> <span class=c1>// 引发 panic: index out of range
</span></span></span></code></pre></div><ol start=2><li>空指针解引用</li></ol><p>尝试解引用一个为 <code>nil</code> 的指针时，会引发 <code>panic</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>p</span> <span class=o>*</span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=o>*</span><span class=nx>p</span><span class=p>)</span> <span class=c1>// 引发 panic: dereference of nil pointer
</span></span></span></code></pre></div><ol start=3><li>类型断言失败</li></ol><p>在进行类型断言时，如果断言失败，会引发 <code>panic</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>i</span> <span class=kd>interface</span><span class=p>{}</span> <span class=p>=</span> <span class=s>&#34;hello&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>s</span> <span class=o>:=</span> <span class=nx>i</span><span class=p>.(</span><span class=kt>int</span><span class=p>)</span> <span class=c1>// 引发 panic: interface conversion: interface {} is string, not int
</span></span></span></code></pre></div><ol start=4><li>使用 <code>panic</code> 函数</li></ol><p>显式调用 <code>panic</code> 函数时，会引发错误。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nb>panic</span><span class=p>(</span><span class=s>&#34;something went wrong&#34;</span><span class=p>)</span> <span class=c1>// 引发 panic
</span></span></span></code></pre></div><ol start=5><li>运行时错误</li></ol><p>某些运行时错误，例如死循环或堆栈溢出，也可能导致 <code>panic</code>。</p><ol start=6><li>其他严重错误</li></ol><p>在程序中遇到不应该发生的情况，例如逻辑错误、非法状态等，也可以使用 <code>panic</code> 手动引发。</p><h3 id=示例代码>示例代码</h3><p>以下是一个简单的示例，展示了几种引发 <code>panic</code> 的情况：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 数组越界
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>arr</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>int</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>arr</span><span class=p>[</span><span class=mi>3</span><span class=p>])</span> <span class=c1>// panic: index out of range
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// 空指针解引用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>p</span> <span class=o>*</span><span class=kt>int</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=o>*</span><span class=nx>p</span><span class=p>)</span> <span class=c1>// panic: dereference of nil pointer
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// 类型断言失败
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>i</span> <span class=kd>interface</span><span class=p>{}</span> <span class=p>=</span> <span class=s>&#34;hello&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span> <span class=o>:=</span> <span class=nx>i</span><span class=p>.(</span><span class=kt>int</span><span class=p>)</span> <span class=c1>// panic: interface conversion: interface {} is string, not int
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>可以使用 <code>defer</code> 和 <code>recover</code> 来捕获 <code>panic</code>，防止程序崩溃。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>safeFunc</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>r</span> <span class=o>:=</span> <span class=nb>recover</span><span class=p>();</span> <span class=nx>r</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Recovered from:&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// 可能引发 panic 的代码
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>arr</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>int</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>arr</span><span class=p>[</span><span class=mi>3</span><span class=p>])</span> <span class=c1>// 引发 panic
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>safeFunc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Program continues...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>在这个示例中，<code>recover</code> 捕获了 <code>panic</code>，程序不会崩溃，而是继续执行后面的代码。</p><h3 id=其他知识点>其他知识点</h3><ol><li><code>panic</code> 的工作机制</li></ol><ul><li><strong>引发 <code>panic</code></strong>：当 <code>panic</code> 被调用时，Go 运行时系统会开始展开当前调用栈的函数。所有的 <code>defer</code> 语句都会被执行。</li><li><strong class=chinese>展开调用栈</strong>：在 <code>panic</code> 发生后，程序会向上返回，执行每个函数的 <code>defer</code>，直到找到一个 <code>recover</code> 或完全退出程序。</li><li><strong class=chinese>最终崩溃</strong>：如果没有 <code>recover</code> 捕获到 <code>panic</code>，程序将打印出错误信息并退出，返回状态码1。</li></ul><ol start=2><li>使用 <code>defer</code> 和 <code>recover</code></li></ol><ul><li><strong><code>defer</code> 声明</strong>：你可以在函数中使用 <code>defer</code> 关键字来声明一个延迟执行的函数。这个函数会在返回之前执行，即使函数中发生了 <code>panic</code>。</li><li><strong><code>recover</code> 函数</strong>：<code>recover</code> 可以用来捕获 <code>panic</code> 并阻止程序崩溃。它只在被 <code>defer</code> 声明的函数中有效。</li></ul><ol start=3><li><code>panic</code> 的参数</li></ol><ul><li><code>panic</code> 可以接受任意类型的参数，通常是一个字符串或一个错误对象。这个参数会被打印出来，提供有关 <code>panic</code> 的上下文信息。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nb>panic</span><span class=p>(</span><span class=s>&#34;an error occurred&#34;</span><span class=p>)</span>
</span></span></code></pre></div><ol start=4><li>何时使用 <code>panic</code></li></ol><ul><li><strong class=chinese>程序内部错误</strong>：如果遇到不应该发生的逻辑错误，可以使用 <code>panic</code>，例如检查到不符合预期的状态。</li><li><strong class=chinese>初始化错误</strong>：在初始化过程中，如果遇到无法恢复的错误，可以使用 <code>panic</code>。</li><li><strong class=chinese>开发阶段</strong>：在开发期间，<code>panic</code> 可以帮助快速发现问题，但在生产代码中应谨慎使用。</li></ul><ol start=5><li><code>panic</code> 与错误处理的对比</li></ol><ul><li><strong class=chinese>错误处理</strong>：Go 语言推荐使用返回值来处理可恢复的错误，使用 <code>error</code> 类型来传递错误信息。</li><li><strong><code>panic</code></strong>：用于处理不可恢复的错误，通常意味着程序处于不一致状态。</li></ul><ol start=6><li>性能影响</li></ol><ul><li>使用 <code>panic</code> 和 <code>recover</code> 会对性能有一定影响，尤其是在高频调用的情况下。频繁的 <code>panic</code> 和 <code>recover</code> 会增加运行时开销。</li></ul><ol start=7><li>其他注意事项</li></ol><ul><li><strong>嵌套 <code>panic</code></strong>：如果在 <code>defer</code> 的恢复函数中再次调用 <code>panic</code>，将导致程序再次崩溃，而不会执行外层的 <code>recover</code>。</li><li><strong class=chinese>并发</strong>：在并发程序中，<code>panic</code> 只会影响当前 goroutine。如果一个 goroutine 发生了 <code>panic</code>，其他 goroutine 不会受到影响。</li></ul><hr><p>参考课程：</p><ol><li><a href=https://www.bilibili.com/video/BV1gf4y1r79E>8小时转职Golang工程师</a></li><li><a href=https://www.runoob.com/go/go-tutorial.html>Go语言教程 | 菜鸟教程</a></li></ol></article><div class=paginator><a class=link href=https://blog.pi3.fun/post/2024/11/git%E6%92%A4%E9%94%80%E5%A4%A7%E6%96%87%E4%BB%B6%E6%8F%90%E4%BA%A4/>← prev</a>
<a class=link href=https://blog.pi3.fun/post/2024/go%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/go%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A821%E5%8F%8D%E5%B0%84/>next →</a></div><div class=comment><div id=tcomment></div><script src=https://registry.npmmirror.com/twikoo/1.6.39/files/dist/twikoo.min.js></script><script async>twikoo.init({envId:"https://twikoo.pi3.fun/.netlify/functions/twikoo",el:"#tcomment",lang:"zh-CN"})</script></div></main><footer id=footer><div><span style=display:flex;align-items:center><span style=margin-right:.5rem>© 2021 - 2024</span><img src=https://cdn.pi3.fun/static/rainbow.gif loading=lazy width=20 alt=rainbow><span style=margin-left:.5rem>By Liu Chao</span></span></div><div class=footnote><span><a href=https://www.foreverblog.cn/ target=_blank><img src=https://img.foreverblog.cn/logo_en_default.png style=width:auto;height:16px></a> | <a class=link href=https://blogscn.fun/ target=_blank><img src=https://photo.xiangming.site/img/blogscn.png style=width:auto;height:15px></a><br><a class=link href=/index.xml><span class="iconfont icon-RSS"></span></a> | <a class=link href=https://github.com/Pi3-l22 target=_ blank><span class="iconfont icon-GitHub"></span></a> | <a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener><span class="iconfont icon-creative-commons-fill"></span></a></span></div><div class=blog-icon></div></footer></div><script>document.addEventListener("DOMContentLoaded",function(){const n=localStorage.getItem("theme")||"light",e=document.querySelector('link[data-theme-style="light"]'),t=document.querySelector('link[data-theme-style="dark"]'),i=window.matchMedia("(prefers-color-scheme: dark)");i.addListener(function(n){if(!localStorage.getItem("theme")){const s=n.matches?"dark":"light";document.documentElement.setAttribute("data-theme",s),localStorage.setItem("theme",s),s==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");const o=document.querySelector("iframe.giscus-frame");if(o){const e=s==="light"?"light_tritanopia":"dark_tritanopia";o.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}}}),n==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");function o(){const e=document.querySelector("iframe.giscus-frame");if(e){const t=n==="light"?"light_tritanopia":"dark_tritanopia";e.contentWindow.postMessage({giscus:{setConfig:{theme:t}}},"https://giscus.app")}else setTimeout(o,1e3)}o();const s=document.querySelector(".theme-toggle");s&&(s.textContent=n==="light"?"黑暗":"明亮",s.addEventListener("click",function(){const o=document.documentElement.getAttribute("data-theme"),n=o==="light"?"dark":"light";document.documentElement.setAttribute("data-theme",n),localStorage.setItem("theme",n),n==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");const s=document.querySelector("iframe.giscus-frame");if(s){const e=n==="light"?"light_tritanopia":"dark_tritanopia";s.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}this.textContent=n==="light"?"黑暗":"明亮"}))})</script></body></html>