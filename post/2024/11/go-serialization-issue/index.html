<!doctype html><html lang=zh-cn><head><script>(function(){const e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)})()</script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=author content="LiuChao"><meta name=description content="奇怪的Go语言序列化问题"><link rel=icon href=https://blog.pi3.fun/favicon.ico><meta name=keywords content=" study  latex  life  academic "><meta property="og:url" content="https://blog.pi3.fun/post/2024/11/go-serialization-issue/"><meta property="og:site_name" content="Pi3's Notes"><meta property="og:title" content="奇怪的Go语言序列化问题"><meta property="og:description" content="奇怪的Go语言序列化问题"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-11-18T00:00:00+00:00"><meta property="article:modified_time" content="2024-11-18T00:00:00+00:00"><meta property="article:tag" content="技术"><meta property="article:tag" content="Golang"><meta property="article:tag" content="序列化"><link rel=canonical href=https://blog.pi3.fun/post/2024/11/go-serialization-issue/><meta itemprop=name content="奇怪的Go语言序列化问题"><meta itemprop=description content="奇怪的Go语言序列化问题"><meta itemprop=datePublished content="2024-11-18T00:00:00+00:00"><meta itemprop=dateModified content="2024-11-18T00:00:00+00:00"><meta itemprop=wordCount content="1786"><meta itemprop=keywords content="技术,Golang,序列化"><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/common.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/content.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/theme.css><link media=screen rel=stylesheet href=https://blog.pi3.fun/css/iconfont/iconfont.css><link rel=stylesheet href=https://blog.pi3.fun/css/syntax/xcode.css data-theme-style=light media="(prefers-color-scheme: light)"><link rel=stylesheet href=https://blog.pi3.fun/css/syntax/catppuccin-mocha.css data-theme-style=dark media="not all"><title>奇怪的Go语言序列化问题 - Pi3's Notes</title>
<link rel=stylesheet href=https://blog.pi3.fun/css/single.css><link href=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/katex.min.css rel=stylesheet><script defer src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/katex.min.js></script><script defer src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-y/KaTeX/0.15.2/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}],ignoredTags:["script","noscript","style","textarea","pre","code","option"],throwOnError:!1})})</script></head><body><div id=wrapper><header id=header><link rel=stylesheet href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Regular/result.css><link rel=stylesheet href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Italic/result.css><link rel=stylesheet href=https://chinese-fonts-cdn.deno.dev/packages/maple-mono-cn/dist/MapleMono-CN-Regular/result.css><h1><a href=https://blog.pi3.fun/>Pi3's Notes</a></h1><nav><span class=nav-bar-item><a class=link href=/>文章</a>
</span><span class=nav-bar-item><a class=link href=/post/>归档</a>
</span><span class=nav-bar-item><a class=link href=/about/>关于</a>
</span><span class=nav-bar-item><a class=link href=/links/>友链</a>
</span><span class=nav-bar-item><a class="link theme-toggle" href=javascript:void(0);>黑暗</a></span></nav></header><main id=main class=post><h1>奇怪的Go语言序列化问题</h1><div><b>Keywords: </b><a class=link href=https://blog.pi3.fun/tags/%E6%8A%80%E6%9C%AF>#技术</a>
<a class=link href=https://blog.pi3.fun/tags/golang>#Golang</a>
<a class=link href=https://blog.pi3.fun/tags/%E5%BA%8F%E5%88%97%E5%8C%96>#序列化</a></div><div><b>Release Date: </b><span>2024-11-18</span></div><article class=content><p>今天在编写 Go 语言的程序时，遇到了一个有关序列化的奇怪问题。这个问题花费了我一整个下午才最终解决，即使是解决之后，我依然对此十分困惑。</p><p><img src=https://cdn.pi3.fun/blog/202411182037827.png alt=image.png></p><p>在 Go 语言的结构体中有一个结构体标签的语法，通过<strong class=chinese>反引号</strong>来定义，接着就可以通过<strong class=chinese>反射机制</strong>来取出结构体标签中的值。具体可以参考：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 定义一个结构体 resume，包含两个字段：Name 和 sex
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>resume</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Name 字段，带有两个标签：info 和 doc
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`info:&#34;name&#34; doc:&#34;我的名字&#34;`</span> 
</span></span><span class=line><span class=cl>    <span class=c1>// sex 字段，带有一个标签：info
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>sex</span>  <span class=kt>string</span> <span class=s>`info:&#34;sex&#34;`</span>                 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>除此之外，结构体标签还可以用于 Json 格式的序列化编解码，比如在结构体标签中写上 Json 编码的字段名：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Movie</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 结构体字段的tag是用来指定json编码的时候的字段名
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Title</span>  <span class=kt>string</span>   <span class=s>`json:&#34;title&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Year</span>   <span class=kt>int</span>      <span class=s>`json:&#34;year&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Price</span>  <span class=kt>int</span>      <span class=s>`json:&#34;price&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Actors</span> <span class=p>[]</span><span class=kt>string</span> <span class=s>`json:&#34;actors&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>接着使用 <code>"encoding/json"</code> 包中的 <code>Marshal</code> 和 <code>Unmarshal</code> 就可以将结构体和 Json 编码互相转换。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 序列化 编码过程 结构体 -&gt; json字符串
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>movie</span> <span class=o>:=</span> <span class=nx>Movie</span><span class=p>{</span><span class=err>……</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>jsonStr</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>movie</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 反序列化 解码过程 json字符串 -&gt; 结构体
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>myMovie</span> <span class=o>:=</span> <span class=nx>Move</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>jsonStr</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>myMovie</span><span class=p>)</span>
</span></span></code></pre></div><p>而今天我所遇到的问题，就是发生在这样序列化的互相转换中。</p><p>我定义了一个结构体 <code>User</code> 用于存放用户的一些信息，比如有用户名、密码等。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Username</span>     <span class=kt>string</span>     <span class=s>`json:&#34;username&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Password</span>     <span class=kt>string</span>     <span class=s>`json:&#34;password&#34;`</span>      <span class=c1>// Bcrypt
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Key</span>          <span class=kt>string</span>     <span class=s>`json:&#34;key&#34;`</span>           <span class=c1>// Bcrypt
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>GoogleSecret</span> <span class=kt>string</span>     <span class=s>`json:&#34;google_secret&#34;`</span> <span class=c1>// AES-256
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>其中的 <code>GoogleSecret</code> 存放的是 AES-256 加密过后的数据。</p><p>我将这个结构体通过 <code>json.Marshal()</code> 编码称 json 字符串并写入文件。后续还需要这些信息时，就去文件中读取 json 字符串并通过 <code>json.Unmarshal()</code> 转换会结构体变量。</p><p>这时问题就出现了，当我获取 <code>GoogleSecret</code> 使用 AES-256 解密时，时不时还出现 <code>panic: crypto/cipher: input not full blocks 块大小不正确</code> 的错误，但是我实现 AES 加密时已经使用了 PKCS7 填充。</p><p>这让我百思不得其解，我一开始以为是我的加密算法实现错误了，但是我的加密算法在使用之前已经进行了测试，并且能够成功加密字符串和文件。</p><p>后来我又去寻找是否是序列化的过程出错了，为此我还使用了 <code>json.NewEncoder()</code> 和 <code>json.NewDecoder()</code> 的方法重新实现了结构体和 json 的互相编解码，但是问题依然存在。</p><p>更让我困惑的是，我将 <code>GoogleSecret</code> 加密前、加密后和从文件中读取的数据打印出来逐一对比也没有发现问题。</p><p>直到我将 <code>GoogleSecret</code> 各个结点的<strong class=chinese>哈希值</strong>打印出来，我才发现<strong class=chinese>从文件中读取的数据是不正确的</strong>。</p><p>之前肉眼却看不出来，是因为加密后的数据都是字节流，直接转化成字符串都是乱码甚至显示不出来。而恰好文件读出的数据和原来的数据只有一点点差别。</p><p>就比如下面两个结构体数据看似一样，实际上它们的 hash 值完全不同：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=o>&amp;</span><span class=p>{</span><span class=mi>2</span> <span class=err>$</span><span class=mi>2</span><span class=nx>a</span><span class=err>$</span><span class=mi>12</span><span class=err>$</span><span class=nx>k2Os6JvpSkLT8I50k334</span><span class=o>/</span><span class=nx>uHBi9ghVcEMV3Sglh4hBp</span><span class=p>.</span><span class=nx>Y1KxmUYUO</span><span class=p>.</span> <span class=err>$</span><span class=mi>2</span><span class=nx>a</span><span class=err>$</span><span class=mi>12</span><span class=err>$</span><span class=nx>wx2mG4z</span><span class=o>/</span><span class=nx>ciXTqUGtl6EJoeRrgjuQr99X9iv9e2ZcnunHaOVIQIYYm</span> <span class=nx>U</span><span class=err>��</span><span class=nx>HԵ</span><span class=err>���</span><span class=nx>q7</span><span class=err>��</span><span class=nx>u</span><span class=err>&#39;�</span><span class=nx>W</span><span class=o>+</span>
</span></span><span class=line><span class=cl><span class=err>�</span> <span class=err>�</span><span class=nx>NE</span><span class=err>�</span> <span class=nx>rJ</span><span class=err>�$</span><span class=nx>E</span><span class=err>�\���</span><span class=nx>f</span><span class=err>����</span><span class=mi>3</span><span class=err>�</span><span class=nx>lP</span><span class=err>�</span><span class=o>/</span>
</span></span><span class=line><span class=cl><span class=nx>c</span><span class=p>)</span><span class=err>��</span><span class=nx>w</span><span class=err>�</span><span class=p>:</span><span class=err>��</span><span class=p>!</span><span class=err>��</span><span class=nx>b</span><span class=p>&gt;</span><span class=err>���</span> <span class=p>[]}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&amp;</span><span class=p>{</span><span class=mi>2</span> <span class=err>$</span><span class=mi>2</span><span class=nx>a</span><span class=err>$</span><span class=mi>12</span><span class=err>$</span><span class=nx>k2Os6JvpSkLT8I50k334</span><span class=o>/</span><span class=nx>uHBi9ghVcEMV3Sglh4hBp</span><span class=p>.</span><span class=nx>Y1KxmUYUO</span><span class=p>.</span> <span class=err>$</span><span class=mi>2</span><span class=nx>a</span><span class=err>$</span><span class=mi>12</span><span class=err>$</span><span class=nx>wx2mG4z</span><span class=o>/</span><span class=nx>ciXTqUGtl6EJoeRrgjuQr99X9iv9e2ZcnunHaOVIQIYYm</span> <span class=nx>U</span><span class=err>��</span><span class=nx>HԵ</span><span class=err>���</span><span class=nx>q7</span><span class=err>��</span><span class=nx>u</span><span class=err>&#39;�</span><span class=nx>W</span><span class=o>+</span>
</span></span><span class=line><span class=cl><span class=err>�</span> <span class=err>�</span><span class=nx>NE</span><span class=err>�</span> <span class=nx>rJ</span><span class=err>�$</span><span class=nx>E</span><span class=err>�\���</span><span class=nx>f</span><span class=err>����</span><span class=mi>3</span><span class=err>�</span><span class=nx>lP</span><span class=err>�</span><span class=o>/</span>
</span></span><span class=line><span class=cl><span class=nx>c</span><span class=p>)</span><span class=err>��</span><span class=nx>w</span><span class=err>�</span><span class=p>:</span><span class=err>��</span><span class=p>!</span><span class=err>��</span><span class=nx>b</span><span class=p>&gt;</span><span class=err>���</span> <span class=p>[]}</span>
</span></span></code></pre></div><p>所以，最终我定位到了是文件读出的 <code>GoogleSecret</code> 不正确，这与我将加密后的字节流直接转成字符串存放在变量中有关系。</p><p>查看 Go 语言标准库的文档，在 <a href=https://studygolang.com/static/pkgdoc/pkg/encoding_json.htm>encoding/json</a> 中提到<em>Go 1.2及之后版本，编码器会强行将非法字节替换为unicode字符U+FFFD来使字符串合法</em>。也就是说编码器会将 <code>GoogleSecret</code> 以 unicode 字符格式存放。比如这种形式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=s2>&#34;google_secret&#34;</span><span class=err>:</span><span class=s2>&#34;\r\ufffd\ufffd\u000b\ufffd={\r{\u0011\ufffdGO\ufffdO-\ufffd\u001e\u0005\ufffds!\ufffdM\ufffd$\ufffd\u003c\ufffd\u0007\n\ufffdu\ufffdjQ\u000e\ufffd \ufffdY\u0017\ufffd\ufffd\ufffdݷh\u0017\u003e^\u0002\ufffdu\ufffd\ufffd\&#34;\ufffdk\ufffd\ufffd\ufffdy\u0006q\ufffd\ufffd\ufffd\ufffd\ufffd\u001fQO\ufffd\ufffd\ufffd\ufffd+\ufffdN\ufffdg\ufffd_8\ufffd\u001aO\ufffdL\u0018\ufffdl\ufffd\u0018\ufffd&#34;</span>
</span></span></code></pre></div><p>而之前直接将加密后的字节流转成字符串是 UTF-8 的格式的，有大部分数据是显示不出来的，比如这种形式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=s2>&#34;google_secret&#34;</span><span class=err>:</span><span class=s2>&#34;U��HԵ���q7��u&#39;�W+
</span></span></span><span class=line><span class=cl><span class=s2>� �NE� rJ�$E�\���f����3�lP�/
</span></span></span><span class=line><span class=cl><span class=s2>c)��w�:��!��b&gt;��� []}&#34;</span>
</span></span></code></pre></div><p>事实证明，如果使用这种乱码的形式进行 json 序列化，Go 语言编码器会将其转成 unicode 字符形式，而这一的转化会产生错误，导出数据信息丢失不能还原。</p><p>最后我将加密后的字节流转成十六进制的字符串存储，再通过 json 编解码就完全没有问题了，AES-256 加解密也完全不受影响。比如这种形式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=s>&#34;google_secret&#34;</span><span class=p>:</span><span class=s>&#34;dc4f8cbfe2b45bd2e19f98cd3f643b03f2f272a2a855e5b6a955ff35b36124f45b1f5c4efbb5b474a784dcf8e0acde31d5e8d5caf3c68f4208c56a4e24f907ba4e3c857b28e86ae3ff9344fca7b5ce62f6c30d0e1345fec673977876154fc047&#34;</span>
</span></span></code></pre></div><p>最后我依然很困惑，UTF-8 乱码形式到 Unicode 字符形式其中为什么会发生错误？还是说我猜测错了，其实并不是这里发生的错误？</p></article><div class=paginator><a class=link href=https://blog.pi3.fun/post/2024/go-beginner-notes/collections/>← prev</a>
<a class=link href=https://blog.pi3.fun/post/2024/go-beginner-notes/strings/>next →</a></div><div class=comment><div id=tcomment></div><script src=https://registry.npmmirror.com/twikoo/1.6.39/files/dist/twikoo.min.js></script><script async>twikoo.init({envId:"https://twikoo.pi3.fun/.netlify/functions/twikoo",el:"#tcomment",lang:"zh-CN"})</script></div></main><footer id=footer><div><span style=display:flex;align-items:center><span style=margin-right:.5rem>© 2021 - 2025</span><img src=https://cdn.pi3.fun/static/rainbow.gif loading=lazy width=20 alt=rainbow><span style=margin-left:.5rem>By Liu Chao</span></span></div><div class=footnote><span><a href=https://www.foreverblog.cn/ target=_blank><img src=https://img.foreverblog.cn/logo_en_default.png style=width:auto;height:16px></a> | <a class=link href=https://blogscn.fun/ target=_blank><img src=https://photo.xiangming.site/img/blogscn.png style=width:auto;height:15px></a><br><a class=link href=/index.xml><span class="iconfont icon-RSS"></span></a> | <a class=link href=https://github.com/Pi3-l22 target=_ blank><span class="iconfont icon-GitHub"></span></a> | <a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener><span class="iconfont icon-creative-commons-fill"></span></a></span></div><div class=blog-icon></div></footer></div><script>document.addEventListener("DOMContentLoaded",function(){const n=localStorage.getItem("theme")||"light",e=document.querySelector('link[data-theme-style="light"]'),t=document.querySelector('link[data-theme-style="dark"]'),i=window.matchMedia("(prefers-color-scheme: dark)");i.addListener(function(n){if(!localStorage.getItem("theme")){const s=n.matches?"dark":"light";document.documentElement.setAttribute("data-theme",s),localStorage.setItem("theme",s),s==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");const o=document.querySelector("iframe.giscus-frame");if(o){const e=s==="light"?"light_tritanopia":"dark_tritanopia";o.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}}}),n==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");function o(){const e=document.querySelector("iframe.giscus-frame");if(e){const t=n==="light"?"light_tritanopia":"dark_tritanopia";e.contentWindow.postMessage({giscus:{setConfig:{theme:t}}},"https://giscus.app")}else setTimeout(o,1e3)}o();const s=document.querySelector(".theme-toggle");s&&(s.textContent=n==="light"?"黑暗":"明亮",s.addEventListener("click",function(){const o=document.documentElement.getAttribute("data-theme"),n=o==="light"?"dark":"light";document.documentElement.setAttribute("data-theme",n),localStorage.setItem("theme",n),n==="light"?(e.media="all",t.media="not all"):(e.media="not all",t.media="all");const s=document.querySelector("iframe.giscus-frame");if(s){const e=n==="light"?"light_tritanopia":"dark_tritanopia";s.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}this.textContent=n==="light"?"黑暗":"明亮"}))})</script><script src=https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){confetti({particleCount:150,spread:100})})</script></body></html>